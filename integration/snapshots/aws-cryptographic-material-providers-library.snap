---
source: xtask/src/tests.rs
expression: snapshot
---
SPECIFICATION: [Algorithm Suites](aws-encryption-sdk-specification/framework/algorithm-suites.md)
  SECTION: [Overview](#overview)
    TEXT[!MUST,implication]: The algorithm suite defines the behaviors [supported formats](#supported-formats) MUST follow for cryptographic operations.

  SECTION: [GCM](#gcm)
    TEXT[!MUST,implication]: If specified to use GCM, the AWS Encryption SDK MUST use GCM with the following specifics:
    TEXT[implication]: - The internal block cipher is the encryption algorithm specified by the algorithm suite.

  SECTION: [CBC](#cbc)
    TEXT[!MUST]: If specified to use CBC, the S3 Encryption Client MUST use CBC with the following specifics:
    TEXT[!MUST]: - CBC MUST only be used to decrypt existing ciphertexts.
    TEXT[!MUST]: - CBC MUST NOT be used to encrypt new ciphertexts.

  SECTION: [CTR](#ctr)
    TEXT[!MUST]: If specified to use CTR, the S3 Encryption Client MUST use CTR with the following specifics:
    TEXT[!MUST]: - CTR MUST only be used to decrypt existing ciphertexts.
    TEXT[!MUST]: - CTR MUST NOT be used to encrypt new ciphertexts.

  SECTION: [Identity KDF](#identity-kdf)
    TEXT[!MUST]: The Identity KDF MUST take a byte sequence as input,
    TEXT[!MUST]: and MUST return the input, unchanged, as output.
    TEXT[!MUST]: If included in the algorithm suite,
    TEXT[!MUST]: the algorithm suite's encryption key length MUST equal the algorithm suite's [key derivation input length](#key-derivation-input-length).

  SECTION: [Supported Formats](#supported-formats)
    TEXT[!MUST]: Both short and long name MUST be unique.

  SECTION: [Supported Format Algorithm Suites ENUM](#supported-format-algorithm-suites-enum)
    TEXT[!MUST]: The Material Providers Library MUST provide
    TEXT[!MUST]: a set of algorithm suite ENUM for each [supported format](#supported-format).

  SECTION: [Supported Algorithm Suites ENUM](#supported-algorithm-suites-enum)
    TEXT[!MUST,implication]: The Material Providers Library MUST provide
    TEXT[!MUST,implication]: an ENUM that is the super set of all the [supported format algorithm suites enum](#supported-format-algorithm-suites-enum)
    TEXT[!MUST,implication]: called the Algorithm Suite ENUM.
    TEXT[!MAY,implication]: This means that different formats MAY have duplicate Format Algorithm Suite ENUM.

  SECTION: [Supported Algorithm Suites](#supported-algorithm-suites)
    TEXT[!MUST,implication]: The value `00 00` is reserved
    TEXT[!MUST,implication]: and MUST NOT be used
    TEXT[!MUST,implication]: as an Algorithm Suite ID in the future.
    TEXT[!MUST,implication]: Algorithm Suite ID MUST be a unique hex value across all supported algorithm suites.

  SECTION: [Algorithm Suites Signature Settings](#algorithm-suites-signature-settings)
    TEXT[!MUST,implication]: An algorithm suite with a symmetric signature algorithm MUST use [intermediate key wrapping](#intermediate-key-wrapping).

  SECTION: [Intermediate Key Wrapping](#intermediate-key-wrapping)
    TEXT[!MUST,implementation]: - For each encrypted data key, a distinct `intermediate key` MUST be generated using cryptographically secure random bytes.
    TEXT[!MUST]:   This intermediate key MUST have length equal to the encryption key length of the algorithm suite.
    TEXT[!MUST,implementation]: - For each encrypted data key, a [symmetric signing key](./structures.md#symmetric-signing-key) MUST be derived from the `intermediate key`
    TEXT[!MUST,implementation]:   using the key derivation algorithm in the algorithm suite, with the following specifics:
    TEXT[!MUST,implementation]: - For each encrypted data key, a `key encryption key` MUST be derived from the `intermediate key`
    TEXT[!MUST,implementation]:   using the key derivation algorithm in the algorithm suite, with the following specifics:
    TEXT[!MUST,implementation]: - The [EDK ciphertext](./structures.md#ciphertext) MUST be the following serialization:

  SECTION: [Wrapped Plaintext Data Key](#wrapped-plaintext-data-key)
    TEXT[!MUST,implementation]: The wrapped plaintext data key MUST be the result of the following AES GCM 256 Encrypt operation:
    TEXT[!MUST,implication]: This value MUST be equal to the algorithm suite's encryption key length + 16.

  SECTION: [Structure](#structure)
    TEXT[!MUST,implication]: The fields described below are REQUIRED to be specified by algorithm suites, unless otherwise specified.

  SECTION: [Algorithm Suite ID](#algorithm-suite-id)
    TEXT[!MUST,implication]: A 2-byte hex value that MUST uniquely identify an algorithm suite.
    TEXT[!SHOULD]: This 2-byte value SHOULD be used to bind algorithm suites to ciphertext.

  SECTION: [Encryption Algorithm](#encryption-algorithm)
    TEXT[!MUST]: The length of the input encryption key MUST equal the [encryption key length](#encryption-key-length) specified by the algorithm suite.

  SECTION: [Encryption Algorithm Mode](#encryption-algorithm-mode)
    TEXT[!MUST]: The length of the input IV MUST equal the IV length specified by the algorithm suite.
    TEXT[!MUST]: The length of the authentication tag MUST equal the authentication tag length specified by the algorithm suite.

  SECTION: [Encryption Key Derivation Algorithm](#encryption-key-derivation-algorithm)
    TEXT[!MUST]: The specified KDF algorithm MUST be used to generate the encryption algorithm encryption key input.

  SECTION: [Commit Key Derivation Algorithm](#commit-key-derivation-algorithm)
    TEXT[!MUST]: The specified KDF algorithm MUST be used to generate the [commit key](#commit-key).

  SECTION: [Asymmetric Signature Algorithm](#asymmetric-signature-algorithm)
    TEXT[!MAY,implication]: This field is OPTIONAL.
    TEXT[!MUST]: - Asymmetric signatures MUST be generated using the specified asymmetric signature algorithm.
    TEXT[!MUST]: - Asymmetric signatures MUST be verified using the specified asymmetric signature algorithm.
    TEXT[!MUST]: - Asymmetric signatures MUST NOT be generated.
    TEXT[!MUST]: - Asymmetric signatures MUST NOT be verified.

  SECTION: [Symmetric Signature Algorithm](#symmetric-signature-algorithm)
    TEXT[!MAY,implementation]: This field is OPTIONAL.
    TEXT[!MUST]: - Symmetric signatures MUST be generated using the specified symmetric signature algorithm.
    TEXT[!MUST]: - Symmetric signatures MUST be verified using the specified symmetric signature algorithm.
    TEXT[!MUST,implementation]: - The algorithm suite MUST also use [Intermediate Key Wrapping](#intermediate-key-wrapping).
    TEXT[!MUST]: - Symmetric signatures MUST NOT be generated.
    TEXT[!MUST]: - Symmetric signatures MUST NOT be verified.

  SECTION: [Message Format Version](#message-format-version)
    TEXT[!MUST]: This MUST be used to branch any serialization/deserialization logic in [supported formats](#supported-formats).

  SECTION: [Supported Algorithm Suite Data](#supported-algorithm-suite-data)
    TEXT[!MUST]: - Algorithm Suite 05 78 MUST store the commit key in the suite data
    TEXT[!MUST]: - Algorithm Suite 04 78 MUST store the commit key in the suite data

  SECTION: [Algorithm Suite Data Length](#algorithm-suite-data-length)
    TEXT[!MAY]: The field MAY be length 0.

SPECIFICATION: [AWS KMS Discovery Keyring](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-discovery-keyring.md)
  SECTION: [Interface](#interface)
    TEXT[!MUST,implication]: MUST implement that [AWS Encryption SDK Keyring interface](../keyring-interface.md#interface)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: On initialization the caller MUST provide:
    TEXT[!MUST,implication]: The AWS KMS SDK client MUST NOT be null.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: This function MUST fail.

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST,implication]: OnDecrypt MUST take [decryption materials](../structures.md#decryption-materials) and
    TEXT[!MUST,implication]: a list of [encrypted data keys](../structures.md#encrypted-data-key) as input.
    TEXT[!MUST,implication]: If the [decryption materials](../structures.md#decryption-materials) already contained a valid plaintext data key,
    TEXT[!MUST,implication]: they keyring MUST fail and MUST NOT modify the [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation,test]: The set of encrypted data keys MUST first be filtered to match this keyring’s configuration.
    TEXT[!MUST,implication]: - Its provider ID MUST exactly match the value “aws-kms”.
    TEXT[!MUST,test]: - The provider info MUST be a [valid AWS KMS ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn) with a resource type of `key` or OnDecrypt MUST fail.
    TEXT[!MUST,implication]: - If a discovery filter is configured, its partition and the provider info partition MUST match.
    TEXT[!MUST,implication]: - If a discovery filter is configured, its set of accounts MUST contain the provider info account.
    TEXT[!MUST,implementation]: For each encrypted data key in the filtered set, one at a time, the OnDecrypt MUST attempt to decrypt the data key.
    TEXT[!MUST,implication]: To attempt to decrypt a particular [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST,implication]: OnDecrypt MUST call [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html) with the configured AWS KMS client.
    TEXT[!MUST,implication]: When calling [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html), the keyring MUST call with a request constructed as follows:
    TEXT[!MUST,implication]: - The `KeyId` field in the response MUST equal the AWS KMS ARN from the provider info
    TEXT[!MUST,implication]: - The length of the response’s `Plaintext` MUST equal the [key derivation input length](../algorithm-suites.md#key-derivation-input-length)
    TEXT[!MUST,implication]:   specified by the [algorithm suite](../algorithm-suites.md) included in the input [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation]: If the response does not satisfy these requirements
    TEXT[!MUST,implementation]: then an error is collected and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST,implication]: If the response does satisfy these requirements then OnDecrypt MUST do the following with the response:
    TEXT[!MUST,implementation]: If OnDecrypt fails to successfully decrypt any [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST,implementation]: then it MUST yield an error that includes all collected errors.

SPECIFICATION: [AWS KMS ECDH Keyring](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-ecdh-keyring.md)
  SECTION: [ECC Keys](#ecc-keys)
    TEXT[!MUST]: ECC Private Key MUST be a [PEM encoded PKCS #8 PrivateKeyInfo structures](https://tools.ietf.org/html/rfc5958#section-2)
    TEXT[!MUST]: as private key.
    TEXT[!MUST]: ECC Public Key MUST be a [DER-encoded ASN.1 SubjectPublicKeyInfo](https://datatracker.ietf.org/doc/html/rfc5280#section-4.1)

  SECTION: [Interface](#interface)
    TEXT[!MUST,implication]: MUST implement the [AWS Encryption SDK Keyring interface](../keyring-interface.md#interface)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: - MUST provide a [Key Agreement Schema](#key-agreement-schema)
    TEXT[!MUST,implication]: - MUST provide a [Curve Specification](#curve-specification)
    TEXT[!MUST,implication]: - MUST provide an AWS KMS SDK client
    TEXT[!MAY,implication]: - MAY provide a list of Grant Tokens
    TEXT[!MUST,implication]: the keyring MUST set the recipient's public key on the keyring.

  SECTION: [Curve Specification](#curve-specification)
    TEXT[!MUST]: This value MUST correspond with one of the [supported curve specifications](#supported-curve-specifications).

  SECTION: [Supported Curve Specifications](#supported-curve-specifications)
    TEXT[!MUST]: This keyring MUST NOT use a curve specification outside of the defined above.

  SECTION: [Additional Information](#additional-information)
    TEXT[!MUST]: - Non-secret data that MUST remain associated with the [message](../data-format/message.md) ciphertext.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: OnEncrypt MUST fail if configured with a [KmsPublicKeyDiscovery Key Agreement Configuration](../key-agreement-schemas.md#kmspublickeydiscovery)
    TEXT[!MUST,implication]: OnEncrypt MUST take [encryption materials](structures.md#encryption-materials) as input.
    TEXT[!MUST]: The keyring MUST attempt to serialize the [encryption materials'](structures.md#encryption-materials)
    TEXT[!MUST]: [encryption context](structures.md#encryption-context-1) according to the [encryption context serialization specification](structures.md#serialization).
    TEXT[!MUST,implication]: If the keyring cannot serialize the encryption context, OnEncrypt MUST fail.
    TEXT[!MUST,implication]: To attempt to generate a shared secret,
    TEXT[!MUST,implication]: OnEncrypt MUST call [AWS KMS DeriveSharedSecret]()
    TEXT[!MUST,implication]: the keyring MUST call with a request constructed as follows:
    TEXT[!MUST,implication]: - `KeyId` MUST be the configured AWS KMS key identifier in the schema
    TEXT[!MUST,implication]: - `PublicKey` MUST be the configured Recipient Public Key on the schema
    TEXT[!MUST,implication]: - `KeyAgreementAlgorithm` MUST be "ECDH"
    TEXT[!MUST,implication]: - `GrantTokens` MUST be this keyring's [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).
    TEXT[!MUST,implementation,implication]: If the call to KMS DeriveSharedSecret fails, the keyring MUST fail.
    TEXT[!MUST,implication]: The keyring MUST derive a shared wrapping key according to the construction
    TEXT[!MUST,implication]: outlined by the [key agreement schemas](./key-agreement-schemas.md#key-derivation)
    TEXT[!MUST]: If the Key Derivation step fails, OnEncrypt MUST fail.
    TEXT[!MUST,implication]: If they Key Derivation step succeeds it MUST produce
    TEXT[!MUST,implication]: keying material with a length of 64 bytes.
    TEXT[!MUST,implementation]: The keyring MUST use the first 32 bytes as the Commitment Key.
    TEXT[!MUST,implementation]: The keyring MUST use the last 32 bytes as the Shared Wrapping Key.
    TEXT[!MUST,implementation]: The keyring MUST perform data key wrapping according to the [Data Key Wrapping section](../raw-ecdh-keyring.md#data-key-wrapping).
    TEXT[!MUST]: If the keyring is unable to wrap a plaintext data key, OnEncrypt MUST fail
    TEXT[!MUST]: and MUST NOT modify the [encryption materials](structures.md#encryption-materials).
    TEXT[!MUST]: Otherwise,
    TEXT[!MUST,implementation]: OnEncrypt MUST append a new [encrypted data key](../structures.md#encrypted-data-key)
    TEXT[!MUST,implementation]: to the encrypted data key list in the [encryption materials](../structures.md#encryption-materials)
    TEXT[!MUST]: , constructed as follows:
    TEXT[!MUST,implementation]: - The [key provider id](../structures.md#key-provider-id) MUST be the UTF8 encoded string "aws-kms-ecdh".

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST]: OnDecrypt MUST take [decryption materials](structures.md#decryption-materials) and
    TEXT[!MUST]: a list of [encrypted data keys](structures.md#encrypted-data-key) as input.
    TEXT[!MUST,implementation]: If the decryption materials already contain a plaintext data key,
    TEXT[!MUST,implementation]: OnDecrypt MUST fail
    TEXT[!MUST,implementation]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST]: The keyring MUST attempt to serialize the [decryption materials'](structures.md#decryption-materials)
    TEXT[!MUST]: [encryption context](structures.md#encryption-context-1) according to the [encryption context serialization specification](structures.md#serialization).
    TEXT[!MUST]: If the keyring cannot serialize the encryption context, OnDecrypt MUST fail.
    TEXT[!MUST,implementation]: The set of encrypted data keys MUST first be filtered to match this keyring’s configuration.
    TEXT[implementation]: For the encrypted data key to match:
    TEXT[!MUST]: - MUST first verify that the uncompressed deserialized sender's public key
    TEXT[!MUST]:   and the uncompressed deserialized recipient's public key match the public
    TEXT[!MUST]:   keys configured on the keyring.
    TEXT[!MUST]: - The deserialized version value in the [key provider information](#key-provider-information) MUST match `0x01`.
    TEXT[!MUST,implementation]: - The [ciphertext](#ciphertext) and [key provider information](#key-provider-information) MUST be successfully deserialized.
    TEXT[!MUST,implementation]: - The key provider ID of the encrypted data key MUST have a value equal to the UTF8 encoded strings `raw-ecdh` OR `aws-kms-ecdh`.
    TEXT[!MUST]: - The [authentication tag length](#authentication-tag-length) obtained from the key provider information MUST have a value equal to 16 bytes.
    TEXT[!MUST,implementation]: For each encrypted data key in the filtered set, one at a time, the OnDecrypt MUST attempt to decrypt the data key.
    TEXT[!MUST,implementation]: If this attempt results in an error, then these errors MUST be collected.
    TEXT[!MUST]: To attempt to decrypt a particular [encrypted data key](./structures.md#encrypted-data-key),
    TEXT[!MUST]: OnDecrypt MUST attempt to deserialize the [serialized ciphertext](#ciphertext)
    TEXT[!MUST]: to obtain:
    TEXT[!MUST]: If the keyring is unable to deserialize this information then an error MUST be collected
    TEXT[!MUST]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST,implementation]: The keyring MUST derive the shared secret
    TEXT[!MUST,implementation]: by calling [AWS KMS DeriveSharedSecret]()
    TEXT[!MUST]: with a request constructed as follows:
    TEXT[!MUST]: - `KeyId` MUST be the configured AWS KMS key identifier in the schema
    TEXT[!MUST]: - `PublicKey` MUST be the configured Recipient Public Key on the schema
    TEXT[!MUST]: - `KeyAgreementAlgorithm` MUST be "ECDH"
    TEXT[!MUST]: - `GrantTokens` MUST be this keyring's [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).
    TEXT[!MUST]: If the call to KMS DeriveSharedSecret fails, an error MUST be collected
    TEXT[!MUST]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST]: The keyring MUST derive a shared wrapping key according
    TEXT[!MUST]: to the construction outlined by the [key agreement schemas](./key-agreement-schemas.md#key-derivation)
    TEXT[!MUST]: If the Key Derivation step fails, then an error MUST be collected
    TEXT[!MUST]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST]: If they Key Derivation step succeeds it MUST produce
    TEXT[!MUST]: keying material with a length of 64 bytes.
    TEXT[!MUST]: The keyring MUST use the first 32 bytes as the Commitment Key.
    TEXT[!MUST]: The keyring MUST use the last 32 bytes as the Shared Wrapping Key.
    TEXT[!MUST]: The keyring MUST check that the calculated Commitment Key
    TEXT[!MUST]: from the key derivation step is equal to the deserialized commitment key
    TEXT[!MUST]: found in the encrypted data key.
    TEXT[!MUST]: This check MUST be a constant time check.
    TEXT[!MUST]: If the commitment keys DO NOT match, then an error MUST be collected
    TEXT[!MUST]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST]: The keyring MUST perform data key unwrapping according to the [Data Key Unwrapping section](#data-key-unwrapping).
    TEXT[!MUST]: If the keyring fails to unwrap the data key,
    TEXT[!MUST]: then an error MUST be collected and the next encrypted data key
    TEXT[!MUST]: in the filtered set MUST be attempted.
    TEXT[implementation]: If the response does satisfy these requirements then OnDecrypt:
    TEXT[!MUST]: - MUST set the plaintext data key on the [decryption materials](./structures.md#decryption-materials)
    TEXT[!MUST]: - MUST immediately return the modified [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation]: If OnDecrypt fails to successfully decrypt any encrypted data key,
    TEXT[!MUST,implementation]: then it MUST yield an error that includes all the collected errors.

SPECIFICATION: [AWS KMS Hierarchical Keyring](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-hierarchical-keyring.md)
  SECTION: [Interface](#interface)
    TEXT[!MUST,implication]: MUST implement the [AWS Encryption SDK Keyring interface](../keyring-interface.md#interface)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: - MUST provide a [Keystore](../branch-key-store.md)
    TEXT[!MUST,implication]: - MUST provide a [cache limit TTL
    TEXT[!MUST]: ](#cache-limit-ttl)
    TEXT[!MUST,implication]: - MUST provide either a Branch Key Identifier or a [Branch Key Supplier](#branch-key-supplier)
    TEXT[!MAY]: - MAY provide a max cache size
    TEXT[!MUST]: On initialization the Hierarchical Keyring MUST initialize a [cryptographic-materials-cache](../local-cryptographic-materials-cache.md) with the configured cache limit TTL and the max cache size.
    TEXT[!MUST]: If no max cache size is provided, the crypotgraphic materials cache MUST be configured to a
    TEXT[!MUST]: max cache size of 1000.

  SECTION: [Cache Limit TTL](#cache-limit-ttl)
    TEXT[!MUST]: The maximum amount of time in seconds that an entry within the cache may be used before it MUST be evicted.
    TEXT[!MUST]: The client MUST set a time-to-live (TTL) for [branch key materials](../structures.md#branch-key-materials) in the underlying cache.
    TEXT[!MUST]: This value MUST be greater than zero.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: OnEncrypt MUST take [encryption materials](../structures.md#encryption-materials) as input.
    TEXT[!MUST]: If the input [encryption materials](../structures.md#encryption-materials) do not contain a plaintext data key,
    TEXT[!MUST]: OnEncrypt MUST generate a random plaintext data key, according to the key length defined in the [algorithm suite](../algorithm-suites.md#encryption-key-length).
    TEXT[!MUST]: The process used to generate this random plaintext data key MUST use a secure source of randomness.
    TEXT[!MUST]: The hierarchical keyring MUST attempt to find [branch key materials](../structures.md#branch-key-materials)
    TEXT[!MUST]: from the underlying [cryptographic materials cache](../local-cryptographic-materials-cache.md).
    TEXT[!MUST]: The hierarchical keyring MUST use the formulas specified in [Appendix A](#appendix-a-cache-entry-identifier-formulas)
    TEXT[!MUST]: to compute the [cache entry identifier](../cryptographic-materials-cache.md#cache-identifier).
    TEXT[!MUST]: If a cache entry is found and the entry's TTL has not expired, the hierarchical keyring MUST use those branch key materials for key wrapping.
    TEXT[!MUST]: If a cache entry is not found or the cache entry is expired,
    TEXT[!MUST,implementation]: the hierarchical keyring MUST attempt to obtain the branch key materials
    TEXT[!MUST,implementation]: by querying the backing branch keystore specified in the [retrieve OnEncrypt branch key materials](#query-branch-keystore-onencrypt) section.
    TEXT[!MUST]: If the keyring is not able to retrieve [branch key materials](../structures.md#branch-key-materials)
    TEXT[!MUST]: through the underlying cryptographic materials cache or
    TEXT[!MUST]: it no longer has access to them through the backing keystore, OnEncrypt MUST fail.
    TEXT[!MUST]: - MUST wrap a data key with the branch key materials according to the [branch key wrapping](#branch-key-wrapping) section.
    TEXT[!MUST]: If the keyring is unable to wrap a plaintext data key, OnEncrypt MUST fail
    TEXT[!MUST]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST]: Otherwise,
    TEXT[!MUST,implementation]: OnEncrypt MUST append a new [encrypted data key](../structures.md#encrypted-data-key)
    TEXT[!MUST,implementation]: to the encrypted data key list in the [encryption materials](../structures.md#encryption-materials)
    TEXT[!MUST]: , constructed as follows:
    TEXT[!MUST]: -
    TEXT[!MUST,implementation]: [ciphertext](../structures.md#ciphertext): MUST be serialized as the [hierarchical keyring ciphertext](#ciphertext)
    TEXT[!MUST]: -
    TEXT[!MUST,implementation]: [key provider id](../structures.md#key-provider-id): MUST be UTF8 Encoded "aws-kms-hierarchy"
    TEXT[!MUST]: -
    TEXT[!MUST,implementation]: [key provider info](../structures.md#key-provider-information): MUST be the UTF8 Encoded AWS DDB response `branch-key-id`

  SECTION: [Query Branch Keystore OnEncrypt](#query-branch-keystore-onencrypt)
    TEXT[!MUST]: OnEncrypt MUST call the Keystore's [GetActiveBranchKey](../branch-key-store.md#getactivebranchkey) operation with the following inputs:
    TEXT[!MUST]: If the Keystore's GetActiveBranchKey operation succeeds
    TEXT[!MUST]: the keyring MUST put the returned branch key materials in the cache using the
    TEXT[!MUST]: formula defined in [Appendix A](#appendix-a-cache-entry-identifier-formulas).
    TEXT[!MUST]: Otherwise, OnEncrypt MUST fail.

  SECTION: [Branch Key Wrapping](#branch-key-wrapping)
    TEXT[!MUST,implementation]: The hierarchical keyring MUST:
    TEXT[implementation]: 1. Use a [KDF in Counter Mode with a Pseudo Random Function with HMAC SHA 256](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-108r1.pdf)
    TEXT[implementation]: to derive a 32 byte `derivedBranchKey`
    TEXT[implementation]:    - Use the `salt` as the salt.
    TEXT[implementation]:    - Use the branch key as the `key`.
    TEXT[implementation]: 1. Encrypt a plaintext data key with the `derivedBranchKey` using `AES-GCM-256` with the following inputs:
    TEXT[!MUST]:    -
    TEXT[!MUST,implementation]: MUST use the `derivedBranchKey` as the AES-GCM cipher key.
    TEXT[!MUST]:    -
    TEXT[!MUST,implementation]: MUST use the plain text data key that will be wrapped by the `derivedBranchKey` as the AES-GCM message.
    TEXT[!MUST]:    -
    TEXT[!MUST,implementation]: MUST use the derived `IV` as the AES-GCM IV.
    TEXT[!MUST]:    -
    TEXT[!MUST,implication]: MUST use an authentication tag byte of length 16.
    TEXT[!MUST,implementation]:    - MUST use the serialized [AAD](#branch-key-wrapping-and-unwrapping-aad) as the AES-GCM AAD.
    TEXT[!MUST]: If OnEncrypt fails to do any of the above, OnEncrypt MUST fail.

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST]: OnDecrypt MUST take [decryption materials](../structures.md#decryption-materials) and a list of [encrypted data keys](../structures.md#encrypted-data-keys) as input.
    TEXT[!MUST]: If the decryption materials already contain a `PlainTextDataKey`, OnDecrypt MUST fail.
    TEXT[!MUST]: The set of encrypted data keys MUST first be filtered to match this keyring’s configuration.
    TEXT[!MUST,implementation]: - Its provider ID MUST match the UTF8 Encoded value of “aws-kms-hierarchy”.
    TEXT[!MUST]: - Deserialize the key provider info, if deserialization fails the next EDK in the set MUST be attempted.
    TEXT[!MUST,implementation]:   - The deserialized key provider info MUST be UTF8 Decoded
    TEXT[!MUST]:  and
    TEXT[!MUST,implementation]: MUST match this keyring's configured `Branch Key Identifier`.
    TEXT[!MUST]: For each encrypted data key in the filtered set, one at a time, OnDecrypt MUST attempt to decrypt the encrypted data key.
    TEXT[!MUST]: If this attempt results in an error, then these errors MUST be collected.
    TEXT[!MUST]: To decrypt each encrypted data key in the filtered set, the hierarchical keyring MUST attempt
    TEXT[!MUST]: to find the corresponding [branch key materials](../structures.md#branch-key-materials)
    TEXT[!MUST]: from the underlying [cryptographic materials cache](../local-cryptographic-materials-cache.md).
    TEXT[!MUST]: The hierarchical keyring MUST use the OnDecrypt formula specified in [Appendix A](#decryption-materials)
    TEXT[!MUST]: in order to compute the [cache entry identifier](cryptographic-materials-cache.md#cache-identifier).
    TEXT[!MUST]: If a cache entry is found and the entry's TTL has not expired, the hierarchical keyring MUST use those branch key materials for key unwrapping.
    TEXT[!MUST]: If a cache entry is not found or the cache entry is expired, the hierarchical keyring
    TEXT[!MUST]: MUST attempt to obtain the branch key materials by calling the backing branch key
    TEXT[!MUST]: store specified in the [retrieve OnDecrypt branch key materials](#getitem-branch-keystore-ondecrypt) section.
    TEXT[!MUST]: If the keyring is not able to retrieve `branch key materials` from the backing keystore then OnDecrypt MUST fail.
    TEXT[!MUST]: - MUST unwrap the encrypted data key with the branch key materials according to the [branch key unwrapping](#branch-key-unwrapping) section.
    TEXT[!MUST,test]: If a decryption succeeds, this keyring MUST
    TEXT[!MUST,test]: add the resulting plaintext data key to the decryption materials and return the modified materials.
    TEXT[!MUST]: If OnDecrypt fails to successfully decrypt any [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST]: then it MUST yield an error that includes all the collected errors
    TEXT[!MUST]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).

  SECTION: [GetItem Branch Keystore OnDecrypt](#getitem-branch-keystore-ondecrypt)
    TEXT[!MUST]: OnDecrypt MUST calculate the following values:
    TEXT[!MUST]: OnDecrypt MUST call the Keystore's [GetBranchKeyVersion](../branch-key-store.md#getbranchkeyversion) operation with the following inputs:
    TEXT[!MUST]: If the Keystore's GetBranchKeyVersion operation succeeds
    TEXT[!MUST]: the keyring MUST put the returned branch key materials in the cache using the
    TEXT[!MUST]: formula defined in [Appendix A](#appendix-a-cache-entry-identifier-formulas).
    TEXT[!MUST]: Otherwise, OnDecrypt MUST fail.

  SECTION: [Branch Key Unwrapping](#branch-key-unwrapping)
    TEXT[!MUST]: To decrypt an encrypted data key with a branch key, the hierarchical keyring MUST:
    TEXT[!MUST]:    - It MUST use the `encrypted key` obtained from deserialization as the AES-GCM input ciphertext.
    TEXT[!MUST]:    - It MUST use the `authentication tag` obtained from deserialization as the AES-GCM input authentication tag.
    TEXT[!MUST]:    - It MUST use the `derivedBranchKey` as the AES-GCM cipher key.
    TEXT[!MUST]:    - It MUST use the `IV` obtained from deserialization as the AES-GCM input IV.
    TEXT[!MUST]:    - It MUST use the serialized [encryption context](#branch-key-wrapping-and-unwrapping-aad) as the AES-GCM AAD.
    TEXT[!MUST]: If OnDecrypt fails to do any of the above, OnDecrypt MUST fail.

  SECTION: [Branch Key Wrapping and Unwrapping AAD](#branch-key-wrapping-and-unwrapping-aad)
    TEXT[!MUST,implementation]: To Encrypt and Decrypt the `wrappedDerivedBranchKey` the keyring MUST include the following values as part of the AAD for
    TEXT[!MUST,implementation]: the AES Encrypt/Decrypt calls.
    TEXT[!MUST,implication]: To construct the AAD, the keyring MUST concatenate the following values
    TEXT[!MUST]: If the keyring cannot serialize the encryption context, the operation MUST fail.

  SECTION: [Appendix A: Cache Entry Identifier Formulas](#appendix-a-cache-entry-identifier-formulas)
    TEXT[!MUST]: When accessing the underlying cryptographic materials cache,
    TEXT[!MUST]: the hierarchical keyring MUST use the formulas specified in this appendix
    TEXT[!MUST]: in order to compute the [cache entry identifier](../cryptographic-materials-cache.md#cache-identifier).

  SECTION: [Encryption Materials](#encryption-materials)
    TEXT[!MUST]: When the hierarchical keyring receives an OnEncrypt request,
    TEXT[!MUST]: the cache entry identifier MUST be calculated as the first 32 bytes of the
    TEXT[!MUST]: SHA-512 hash of the following byte strings, in the order listed:

  SECTION: [Decryption Materials](#decryption-materials)
    TEXT[!MUST]: When the hierarchical keyring receives an OnDecrypt request,
    TEXT[!MUST]: it MUST calculate the cache entry identifier as the first 32 bytes of the SHA-512 hash of the following byte strings, in the order listed:

  SECTION: [Branch Key Supplier](#branch-key-supplier)
    TEXT[!MUST]: This operation MUST take in an encryption context as input,
    TEXT[!MUST]: and return a branch key id (string) as output.

SPECIFICATION: [AWS KMS Key ARN](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-key-arn.md)
  SECTION: [A valid AWS KMS ARN](#a-valid-aws-kms-arn)
    TEXT[!MUST,implication]: MUST start with string `arn`
    TEXT[!MUST,implication]: The partition MUST be a non-empty
    TEXT[!MUST,implication]: The service MUST be the string `kms`
    TEXT[!MUST,implication]: The region MUST be a non-empty string
    TEXT[!MUST,implication]: The account MUST be a non-empty string
    TEXT[!MUST,implication]: The resource section MUST be non-empty and MUST be split by a single `/`
    TEXT[!MUST,implication]:    any additional `/` are included in the resource id
    TEXT[!MUST,implication]: The resource type MUST be either `alias` or `key`
    TEXT[!MUST,implication]: The resource id MUST be a non-empty string

  SECTION: [Identifying an an AWS KMS multi-Region ARN](#identifying-an-an-aws-kms-multi-region-arn)
    TEXT[!MUST,implication]: This function MUST take a single AWS KMS ARN
    TEXT[!MUST,implication]: If the input is an invalid AWS KMS ARN this function MUST error.
    TEXT[!MUST,implication]: If resource type is “alias”,
    TEXT[!MUST,implication]: this is an AWS KMS alias ARN and MUST return false.
    TEXT[!MUST,implication]: If resource type is “key” and resource ID starts with “mrk-“,
    TEXT[!MUST,implication]: this is a AWS KMS multi-Region key ARN and MUST return true.
    TEXT[!MUST,implication]: If resource type is “key” and resource ID does not start with “mrk-“,
    TEXT[!MUST,implication]: this is a (single-region) AWS KMS key ARN and MUST return false.

  SECTION: [Identifying an an AWS KMS multi-Region identifier](#identifying-an-an-aws-kms-multi-region-identifier)
    TEXT[!MUST,implication]: This function MUST take a single AWS KMS identifier
    TEXT[!MUST,implication]: If the input starts with "arn:",
    TEXT[!MUST,implication]: this MUST return the output of [identifying an an AWS KMS multi-Region ARN](aws-kms-key-arn.md#identifying-an-an-aws-kms-multi-region-arn)
    TEXT[!MUST,implication]: called with this input.
    TEXT[!MUST,implication]: If the input starts with “alias/“,
    TEXT[!MUST,implication]: this an AWS KMS alias and not a multi-Region key id and MUST return false.
    TEXT[!MUST,implication]: If the input starts with “mrk-“,
    TEXT[!MUST,implication]: this is a multi-Region key id and MUST return true.
    TEXT[!MUST,implication]: If the input does not start with any of the above,
    TEXT[!MUST,implication]: this is not a multi-Region key id and MUST return false.

SPECIFICATION: [AWS KMS Keyring](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-keyring.md)
  SECTION: [Interface](#interface)
    TEXT[!MUST,implication]: MUST implement the [AWS Encryption SDK Keyring interface](../keyring-interface.md#interface)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: - MUST provide an AWS KMS key identifier
    TEXT[!MUST,implication]: - MUST provide an AWS KMS SDK client
    TEXT[!MAY,implication]: - MAY provide a list of Grant Tokens
    TEXT[!MUST,implication]: The AWS KMS key identifier MUST NOT be null or empty.
    TEXT[!MUST,implication]: The AWS KMS key identifier MUST be [a valid identifier](aws-kms-key-arn.md#a-valid-aws-kms-identifier).
    TEXT[!MUST,implication]: The AWS KMS SDK client MUST NOT be null.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: OnEncrypt MUST take [encryption materials](../structures.md#encryption-materials) as input.
    TEXT[!MUST,implication]: If the input [encryption materials](../structures.md#encryption-materials) do not contain a plaintext data key
    TEXT[!MUST,implication]: OnEncrypt MUST attempt to generate a new plaintext data key
    TEXT[!MUST,implication]: by calling [AWS KMS GenerateDataKey](https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKey.html).
    TEXT[!MUST,implication]: If the keyring calls AWS KMS GenerateDataKeys, it MUST use the configured AWS KMS client to make the call.
    TEXT[!MUST,implication]: The keyring MUST call AWS KMS GenerateDataKeys with a request constructed as follows:
    TEXT[!MUST,implication]: - `KeyId` MUST be the keyring's KMS key identifier.
    TEXT[!MUST,implication]: - `NumberOfBytes` MUST be the [key derivation input length](../algorithm-suites.md#key-derivation-input-length)
    TEXT[!MUST,implication]:   specified by the [algorithm suite](../algorithm-suites.md) included in the input [encryption materials](../structures.md#encryption-materials).
    TEXT[!MUST,implementation,implication]: - `EncryptionContext` MUST be the [encryption context](../structures.md#encryption-context)
    TEXT[!MUST,implementation,implication]:   included in the input [encryption materials](../structures.md#encryption-materials).
    TEXT[!MUST,implementation,implication]: - `GrantTokens` MUST be this keyring's [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).
    TEXT[!MUST,implementation]: If the call to [AWS KMS GenerateDataKey](https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKey.html) does not succeed,
    TEXT[!MUST,implementation]: OnEncrypt MUST NOT modify the [encryption materials](../structures.md#encryption-materials) and MUST fail.
    TEXT[!MUST,implication]: If the Generate Data Key call succeeds, OnEncrypt MUST verify that the response `Plaintext` length matches
    TEXT[!MUST,implication]: the specification of the [algorithm suite](../algorithm-suites.md)'s Key Derivation Input Length field.
    TEXT[!MUST,implementation]: The Generate Data Key response’s `KeyId` MUST be [a valid AWS KMS key ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn).
    TEXT[!MUST]: - MUST set the plaintext data key on the [encryption materials](../structures.md#encryption-materials) as the response `Plaintext`.
    TEXT[!MUST,implementation]: - MUST append a new [encrypted data key](../structures.md#encrypted-data-key) to the encrypted data key list in the [encryption materials](../structures.md#encryption-materials), constructed as follows:
    TEXT[!MUST,implementation]:   - the [ciphertext](../structures.md#ciphertext) MUST be the response `CiphertextBlob`.
    TEXT[!MUST,implementation]:   - the [key provider id](../structures.md#key-provider-id) MUST be "aws-kms".
    TEXT[!MUST,implementation]:   - the [key provider information](../structures.md#key-provider-information) MUST be the response `KeyId`.
    TEXT[!MUST,implication]: - MUST output the modified [encryption materials](../structures.md#encryption-materials)
    TEXT[!MUST,implication]: If the input [encryption materials](../structures.md#encryption-materials) do contain a plaintext data key,
    TEXT[!MUST,implication]: OnEncrypt MUST attempt to encrypt the plaintext data key using the configured AWS KMS key identifier.
    TEXT[!MUST,implication]: The keyring MUST call [AWS KMS Encrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Encrypt.html) using the configured AWS KMS client.
    TEXT[!MUST,implication]: The keyring MUST AWS KMS Encrypt call with a request constructed as follows:
    TEXT[!MUST,implication]: - `KeyId` MUST be the configured AWS KMS key identifier.
    TEXT[!MUST,implication]: - `PlaintextDataKey` MUST be the plaintext data key in the [encryption materials](../structures.md#encryption-materials).
    TEXT[!MUST,implication]: If the call to [AWS KMS Encrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Encrypt.html) does not succeed, OnEncrypt MUST fail.
    TEXT[!MUST,implementation]: If the Encrypt call succeeds the response’s `KeyId` MUST be [A valid AWS KMS key ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn).
    TEXT[!MUST,implication]: If verified, OnEncrypt MUST append a new [encrypted data key](../structures.md#encrypted-data-key) to the encrypted data key list in the [encryption materials](../structures.md#encryption-materials), constructed as follows:
    TEXT[!MUST]: - The [ciphertext](../structures.md#ciphertext) MUST be the response `CiphertextBlob`.
    TEXT[!MUST]: - The [key provider id](../structures.md#key-provider-id) MUST be "aws-kms".
    TEXT[!MUST]: - The [key provider information](../structures.md#key-provider-information) MUST be the response `KeyId`.
    TEXT[!MUST,implication]: If all Encrypt calls succeed, OnEncrypt MUST output the modified [encryption materials](../structures.md#encryption-materials).

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST,implication]: OnDecrypt MUST take [decryption materials](../structures.md#decryption-materials) and
    TEXT[!MUST,implication]: a list of [encrypted data keys](../structures.md#encrypted-data-key) as input.
    TEXT[!MUST,implication]: If the [decryption materials](../structures.md#decryption-materials) already contained a valid plaintext data key
    TEXT[!MUST,implication]: OnDecrypt MUST return an error.
    TEXT[!MUST,implementation]: The set of encrypted data keys MUST first be filtered to match this keyring’s configuration.
    TEXT[!MUST,implication]: - Its provider ID MUST exactly match the value “aws-kms”.
    TEXT[!MUST,implementation]: - The provider info MUST be a [valid AWS KMS ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn) with a resource type of `key` or OnDecrypt MUST fail.
    TEXT[!MUST,implementation]: - The provider info MUST match the configured AWS KMS key identifier.
    TEXT[!MUST,implementation]: For each encrypted data key in the filtered set, one at a time, the OnDecrypt MUST attempt to decrypt the data key.
    TEXT[!MUST,implementation]: If this attempt results in an error, then these errors MUST be collected.
    TEXT[!MUST,implication]: To attempt to decrypt a particular [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST,implication]: OnDecrypt MUST call [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html) with the configured AWS KMS client.
    TEXT[!MUST,implication]: When calling [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html), the keyring MUST call with a request constructed as follows:
    TEXT[!MUST,implication]: - `KeyId` MUST be the configured AWS KMS key identifier.
    TEXT[!MUST,implication]: - `CiphertextBlob` MUST be the [encrypted data key ciphertext](../structures.md#ciphertext).
    TEXT[!MUST,implication]: - `EncryptionContext` MUST be the [encryption context](../structures.md#encryption-context) included in the input [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implication]: - `GrantTokens` MUST be this keyring's [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).
    TEXT[!MUST,implication]: - The `KeyId` field in the response MUST equal the configured AWS KMS key identifier.
    TEXT[!MUST,implication]: - The length of the response’s `Plaintext` MUST equal the [key derivation input length](../algorithm-suites.md#key-derivation-input-length)
    TEXT[!MUST,implication]:   specified by the [algorithm suite](../algorithm-suites.md) included in the input [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation]: If the response does not satisfies these requirements then an error MUST be collected
    TEXT[!MUST,implementation]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST,implementation]: - MUST set the plaintext data key on the [decryption materials](../structures.md#decryption-materials) as the response `Plaintext`.
    TEXT[!MUST,implication]: - MUST immediately return the modified [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation]: If OnDecrypt fails to successfully decrypt any [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST,implementation]: then it MUST yield an error that includes all the collected errors.

SPECIFICATION: [Assert AWS KMS MRK are unique](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-mrk-are-unique.md)
  SECTION: [Implementation](#implementation)
    TEXT[!MUST,implication]: The caller MUST provide:
    TEXT[!MUST,implication]: If the list does not contain any [multi-Region keys](aws-kms-key-arn.md#identifying-an-aws-kms-multi-region-key)
    TEXT[!MUST,implication]: this function MUST exit successfully.
    TEXT[!MUST,implication]: If there are zero duplicate resource ids between the multi-region keys,
    TEXT[!MUST,implication]: this function MUST exit successfully
    TEXT[!MUST,implementation]: If any duplicate multi-region resource ids exist,
    TEXT[!MUST,implementation]: this function MUST yield an error
    TEXT[!MUST,implementation]: that includes all identifiers with duplicate resource ids
    TEXT[!MUST,implementation]: not only the first duplicate found.

SPECIFICATION: [AWS KMS MRK Aware Master Key Provider](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-mrk-aware-master-key-provider.md)
  SECTION: [Interface](#interface)
    TEXT[!MUST,exception]: MUST implement the [Master Key Provider Interface](../master-key-provider-interface.md#interface)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,exception]: On initialization the caller MUST provide:
    TEXT[exception]: - An indicator of either strict or discovery mode e.g an. `isDiscovery` boolean
    TEXT[exception]: - A list of AWS KMS key identifiers, the list may be empty
    TEXT[exception]: - An optional list of AWS KMS grant tokens
    TEXT[exception]: - A method that can take a region string and return an AWS KMS client e.g. a regional client supplier
    TEXT[exception]: - An optional discovery filter that is an AWS partition and a set of AWS accounts
    TEXT[exception]: - An optional discovery MRK Region string
    TEXT[!MUST,exception]: The key id list MUST NOT be empty or null in strict mode.
    TEXT[!MUST,exception]: The key id list MUST NOT contain any null or empty string values.
    TEXT[!MUST,exception]: All AWS KMS key identifiers are be passed to [Assert AWS KMS MRK are unique](aws-kms-mrk-are-unique.md#Implementation)
    TEXT[!MUST,exception]: and the function MUST return success.
    TEXT[!MUST,exception]: A discovery filter MUST NOT be configured in strict mode.
    TEXT[!MUST,exception]: A default MRK Region MUST NOT be configured in strict mode.
    TEXT[!MUST,exception]: In discovery mode if a default MRK Region is not configured
    TEXT[!MUST,exception]: the AWS SDK Default Region MUST be used.
    TEXT[!MUST,exception]: If an AWS SDK Default Region can not be obtained initialization MUST fail.
    TEXT[!MUST,exception]: The key id list MUST be empty in discovery mode.
    TEXT[!MUST,exception]: The regional client supplier MUST be defined in discovery mode.

  SECTION: [Get Master Key](#get-master-key)
    TEXT[!MUST,exception]: The input MUST be the same as the [Master Key Provider Get Master Key](../master-key-provider-interface.md#get-master-key) interface.
    TEXT[!MUST,exception]: The function MUST only provide master keys if the input provider id equals `aws-kms`.
    TEXT[!MUST,exception]: In strict mode, the requested AWS KMS key ARN MUST match a member of the configured key ids
    TEXT[!MUST,exception]: by using [AWS KMS MRK Match for Decrypt](aws-kms-mrk-match-for-decrypt.md#implementation)
    TEXT[!MUST,exception]: otherwise this function MUST error.
    TEXT[!MUST,exception]: In discovery mode, the requested AWS KMS key identifier MUST be a well formed AWS KMS ARN.
    TEXT[!MUST,exception]: In discovery mode if a discovery filter is configured
    TEXT[!MUST,exception]: the requested AWS KMS key ARN’s `partition` MUST match the discovery filter’s `partition`
    TEXT[!MUST,exception]: and the AWS KMS key ARN’s `account` MUST exist in the discovery filter’s account id set.
    TEXT[!MUST,exception]: If the requested AWS KMS key identifier is not a well formed ARN
    TEXT[!MUST,exception]: the AWS Region MUST be the configured default region this SHOULD be obtained from the AWS SDK.
    TEXT[!MUST,exception]: Otherwise if the requested AWS KMS key identifier is [identified as a multi-Region key](aws-kms-key-arn.md#identifying-an-aws-kms-multi-region-key),
    TEXT[!MUST,exception]: then AWS Region MUST be the region from the AWS KMS key ARN stored in the provider info from the encrypted data key.
    TEXT[!MUST,exception]: Otherwise if the mode is discovery then the AWS Region MUST be the discovery MRK region.
    TEXT[!MUST,exception]: Finally if the provider info is [identified as a multi-Region key](aws-kms-key-arn.md#identifying-an-aws-kms-multi-region-key)
    TEXT[!MUST,exception]: the AWS Region MUST be the region from the AWS KMS key in the configured key ids matched to
    TEXT[!MUST,exception]: the requested AWS KMS key by using [AWS KMS MRK Match for Decrypt](aws-kms-mrk-match-for-decrypt.md#implementation).
    TEXT[!MUST,exception]: An AWS KMS client MUST be obtained by calling the regional client supplier with this AWS Region.
    TEXT[!MUST,exception]: In strict mode a [AWS KMS MRK Aware Master Key](aws-kms-mrk-aware-master-key.md) MUST be returned configured with
    TEXT[exception]: - The AWS KMS obtained by calling the regional client supplier.
    TEXT[exception]: - The AWS KMS key in the configured key ids matched to the requested AWS KMS key by using [AWS KMS MRK Match for Decrypt](aws-kms-mrk-match-for-decrypt.md#implementation).
    TEXT[exception]: - The configured grant tokens.
    TEXT[!MUST,exception]: In discovery mode a [AWS KMS MRK Aware Master Key](aws-kms-mrk-aware-master-key.md) MUST be returned configured with
    TEXT[exception]: - The AWS KMS obtained by calling the regional client supplier.
    TEXT[exception]: - An AWS KMS key ARN where the `region` element is the AWS Region, and every other ARN element matches the requested AWS KMS key ARN.
    TEXT[exception]: - The configured grant tokens.
    TEXT[!MUST,exception]: The output MUST be the same as the [Master Key Provider Get Master Key](../master-key-provider-interface.md#get-master-key) interface.

  SECTION: [Get Master Keys For Encryption](#get-master-keys-for-encryption)
    TEXT[!MUST,exception]: The input MUST be the same as the [Master Key Provider Get Master Keys For Encryption](../master-key-provider-interface.md#get-master-keys-for-encryption) interface.
    TEXT[!MUST,exception]: If the configured mode is discovery the function MUST return an empty list.
    TEXT[!MUST,exception]: If the configured mode is strict this function MUST return a list of master keys
    TEXT[!MUST,exception]: obtained by calling [Get Master Key](aws-kms-mrk-aware-master-key-provider.md#get-master-key) for each AWS KMS key identifier in the configured key ids
    TEXT[!MUST,exception]: The output MUST be the same as the [Master Key Provider Get Master Keys For Encryption](../master-key-provider-interface.md#get-master-keys-for-encryption) interface.

  SECTION: [Decrypt Data Key](#decrypt-data-key)
    TEXT[!MUST,exception]: The input MUST be the same as the [Master Key Provider Decrypt Data Key](../master-key-provider-interface.md#decrypt-data-key) interface.
    TEXT[!MUST,exception]: The set of encrypted data keys MUST first be filtered to match this master key’s configuration.
    TEXT[!MUST,exception]: To match the encrypted data key’s provider ID MUST exactly match the value “aws-kms”.
    TEXT[!MUST,exception]: Additionally each provider info MUST be a [valid AWS KMS ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn) with a resource type of `key`.
    TEXT[!MUST,exception]: For each encrypted data key in the filtered set, one at a time,
    TEXT[!MUST,exception]: the master key provider MUST call [Get Master Key](aws-kms-mrk-aware-master-key-provider.md#get-master-key)
    TEXT[!MUST,exception]: with the encrypted data key’s provider info as the AWS KMS key ARN.
    TEXT[!MUST,exception]: It MUST call [Decrypt Data Key](aws-kms-mrk-aware-master-key.md#decrypt-data-key) on this master key with the input algorithm,
    TEXT[!MUST,exception]: this single encrypted data key, and the input encryption context.
    TEXT[!MUST,exception]: If this attempt results in an error, then these errors MUST be collected.
    TEXT[!MUST,exception]: If the decrypt data key call is successful, then this function MUST return this result
    TEXT[!MUST,exception]: and not attempt to decrypt any more encrypted data keys.
    TEXT[!MUST,exception]: If all the input encrypted data keys have been processed
    TEXT[!MUST,exception]: then this function MUST yield an error that includes all the collected errors.
    TEXT[!MUST,exception]: The output MUST be the same as the [Master Key Provider Decrypt Data Key](../master-key-provider-interface.md#decrypt-data-key) interface.

SPECIFICATION: [AWS KMS MRK Aware Master Key](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-mrk-aware-master-key.md)
  SECTION: [Interface](#interface)
    TEXT[!MUST,exception]: MUST implement the [Master Key Interface](../master-key-interface.md#interface)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,exception]: On initialization, the caller MUST provide:
    TEXT[exception]: - An AWS KMS key identifier
    TEXT[exception]: - An AWS KMS SDK client.
    TEXT[!MUST,exception]: The AWS KMS key identifier MUST NOT be null or empty.
    TEXT[!MUST,exception]: The AWS KMS key identifier MUST be [a valid identifier](aws-kms-key-arn.md#a-valid-aws-kms-identifier).
    TEXT[!MUST,exception]: The AWS KMS SDK client MUST not be null.
    TEXT[!MUST,exception]: The master key MUST be able to be configured with an optional list of Grant Tokens.
    TEXT[!SHOULD,exception]: This configuration SHOULD be on initialization and SHOULD be immutable.

  SECTION: [Get Master Key](#get-master-key)
    TEXT[!MUST,exception]: MUST be unchanged from the Master Key interface.

  SECTION: [Get Master Keys For Encryption](#get-master-keys-for-encryption)
    TEXT[!MUST,exception]: MUST be unchanged from the Master Key interface.

  SECTION: [Decrypt Data Key](#decrypt-data-key)
    TEXT[!MUST,exception]: The inputs MUST be the same as the [Master Key Decrypt Data Key](../master-key-interface.md#decrypt-data-key) interface.
    TEXT[!MUST,exception]: The set of encrypted data keys MUST first be filtered to match this master key’s configuration.
    TEXT[!MUST,exception]: To match the encrypted data key’s provider ID MUST exactly match the value “aws-kms”
    TEXT[!MUST,exception]: and the the function [AWS KMS MRK Match for Decrypt](aws-kms-mrk-match-for-decrypt.md#implementation) called with the configured AWS KMS key identifier
    TEXT[!MUST,exception]: and the encrypted data key’s provider info MUST return `true`.
    TEXT[!MUST,exception]: Additionally each provider info MUST be a [valid AWS KMS ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn) with a resource type of `key`.
    TEXT[!MUST,exception]: For each encrypted data key in the filtered set, one at a time,
    TEXT[!MUST,exception]: the master key MUST attempt to decrypt the data key.
    TEXT[!MUST,exception]: If this attempt results in an error,
    TEXT[!MUST,exception]: then these errors MUST be collected.
    TEXT[!MUST,exception]: To decrypt the encrypted data key this master key MUST use the configured AWS KMS client
    TEXT[!MUST,exception]: to make an [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html) request constructed as follows:
    TEXT[exception]: - `KeyId`: The configured AWS KMS key identifier.
    TEXT[exception]: - `CiphertextBlob`: The `ciphertext` from the encrypted data key.
    TEXT[exception]: - `EncryptionContext`: The encryption context included in the input.
    TEXT[exception]: - `GrantTokens`: The configured grant tokens.
    TEXT[!MUST,exception]: If the call succeeds then the response’s `KeyId` MUST be equal to the configured AWS KMS key identifier
    TEXT[!MUST,exception]: otherwise the function MUST collect an error.
    TEXT[!MUST,exception]: The response’s `Plaintext`’s length MUST equal the length required by the requested algorithm suite
    TEXT[!MUST,exception]: otherwise the function MUST collect an error.
    TEXT[!MUST,exception]: If the AWS KMS response satisfies the requirements then it MUST be use and this function MUST return
    TEXT[!MUST,exception]: and not attempt to decrypt any more encrypted data keys.
    TEXT[!MUST,exception]: If all the input encrypted data keys have been processed
    TEXT[!MUST,exception]: then this function MUST yield an error that includes all the collected errors.
    TEXT[!MUST,exception]: The output MUST be the same as the [Master Key Decrypt Data Key](../master-key-interface.md#decrypt-data-key) interface.

  SECTION: [Generate Data Key](#generate-data-key)
    TEXT[!MUST,exception]: The inputs MUST be the same as the [Master Key Generate Data Key](../master-key-interface.md#generate-data-key) interface.
    TEXT[!MUST,exception]: This master key MUST use the configured AWS KMS client
    TEXT[!MUST,exception]: to make an [AWS KMS GenerateDatakey](https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKey.html) request constructed as follows:
    TEXT[exception]: - `KeyId`: The configured AWS KMS key identifier.
    TEXT[exception]: - `NumberOfBytes`: The key derivation input length specified by the algorithm suite included in the input.
    TEXT[exception]: - `EncryptionContext`: The encryption context included in the input.
    TEXT[exception]: - `GrantTokens`: The configured grant tokens.
    TEXT[!MUST,exception]: If the call succeeds the AWS KMS Generate Data Key response’s `Plaintext` MUST match the key derivation input length specified by the algorithm suite included in the input.
    TEXT[!MUST,exception]: The response’s `KeyId` MUST be valid.
    TEXT[!MUST,exception]: The response’s `Plaintext` MUST be the plaintext in the output.
    TEXT[!MUST,exception]: The response’s cipher text blob MUST be used as the returned as the ciphertext for the encrypted data key in the output.
    TEXT[!MUST,exception]: The output MUST be the same as the [Master Key Generate Data Key](../master-key-interface.md#generate-data-key) interface.

  SECTION: [Encrypt Data Key](#encrypt-data-key)
    TEXT[!MUST,exception]: The inputs MUST be the same as the [Master Key Encrypt Data Key](../master-key-interface.md#encrypt-data-key) interface.
    TEXT[!MUST,exception]: The master key MUST use the configured AWS KMS client to make an [AWS KMS Encrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Encrypt.html) request constructed as follows:
    TEXT[exception]: - `KeyId`: The configured AWS KMS key identifier.
    TEXT[exception]: - `PlaintextDataKey`: The plaintext data key obtained from the input.
    TEXT[exception]: - `EncryptionContext`: the encryption context included in the input.
    TEXT[exception]: - `GrantTokens`: The configured grant tokens.
    TEXT[!MUST,exception]: The AWS KMS Encrypt response MUST contain a valid `KeyId`.
    TEXT[!MUST,exception]: The response’s cipher text blob MUST be used as the `ciphertext` for the encrypted data key.
    TEXT[!MUST,exception]: The output MUST be the same as the [Master Key Encrypt Data Key](../master-key-interface.md#encrypt-data-key) interface.

SPECIFICATION: [AWS KMS MRK Discovery Keyring](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-mrk-discovery-keyring.md)
  SECTION: [Interface](#interface)
    TEXT[!MUST,implication]: MUST implement that [AWS Encryption SDK Keyring interface](../keyring-interface.md#interface)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: On initialization the keyring MUST accept the following parameters:
    TEXT[!MUST,implication]: They keyring MUST fail initialization if any required parameters are missing or null.
    TEXT[!SHOULD,implication]: The keyring SHOULD fail initialization if the provided region does not match the
    TEXT[!SHOULD,implication]: region of the KMS client.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: This function MUST fail.

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST,implication]: OnDecrypt MUST take [decryption materials](../structures.md#decryption-materials) and
    TEXT[!MUST,implication]: a list of [encrypted data keys](../structures.md#encrypted-data-key) as input.
    TEXT[!MUST,implication]: If the [decryption materials](../structures.md#decryption-materials) already contained a valid plaintext data key,
    TEXT[!MUST,implication]: they keyring MUST fail and MUST NOT modify the [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation]: The set of encrypted data keys MUST first be filtered to match this keyring’s configuration.
    TEXT[!MUST,implication]: - Its provider ID MUST exactly match the value “aws-kms”.
    TEXT[!MUST,implementation]: - The provider info MUST be a [valid AWS KMS ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn) with a resource type of `key` or OnDecrypt MUST fail.
    TEXT[!MUST,implication]: - If a discovery filter is configured, its partition and the provider info partition MUST match.
    TEXT[!MUST,implication]: - If a discovery filter is configured, its set of accounts MUST contain the provider info account.
    TEXT[!MUST,implication]: - If the provider info is not [identified as a multi-Region key](aws-kms-key-arn.md#identifying-an-aws-kms-multi-region-key), then the provider info’s Region MUST match the AWS KMS client region.
    TEXT[!MUST,implementation]: For each encrypted data key in the filtered set, one at a time, the OnDecrypt MUST attempt to decrypt the data key.
    TEXT[!MUST,implication]: To attempt to decrypt a particular [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST,implication]: OnDecrypt MUST call [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html) with the configured AWS KMS client.
    TEXT[!MUST]: When calling [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html), the keyring MUST call with a request constructed as follows:
    TEXT[!MUST,implementation]: - `KeyId`: If the provider info’s resource type is `key` and its resource is a multi-Region key
    TEXT[!MUST,implementation]:   then a new ARN MUST be created where the region part MUST equal the AWS KMS client region
    TEXT[!MUST,implementation]:   and every other part MUST equal the provider info.
    TEXT[!MUST,implementation]: Otherwise it MUST be the provider info.
    TEXT[!MUST]: - The `KeyId` field in the response MUST equal the requested `KeyId`
    TEXT[!MUST,implication]: - The length of the response’s `Plaintext` MUST equal the [key derivation input length](../algorithm-suites.md#key-derivation-input-length)
    TEXT[!MUST,implication]:   specified by the [algorithm suite](../algorithm-suites.md) included in the input [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation]: If the response does not satisfies these requirements
    TEXT[!MUST,implementation]: then an error is collected and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST]: Since the response does satisfies these requirements
    TEXT[!MUST]: then OnDecrypt MUST do the following with the response:
    TEXT[!MUST,implementation]: If OnDecrypt fails to successfully decrypt any [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST,implementation]: then it MUST yield an error that includes all collected errors.

SPECIFICATION: [AWS KMS MRK Keyring](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-mrk-keyring.md)
  SECTION: [Interface](#interface)
    TEXT[!MUST,implication]: MUST implement the [AWS Encryption SDK Keyring interface](../keyring-interface.md#interface)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST]: On initialization the caller MUST provide:
    TEXT[!MUST,implication]: The AWS KMS key identifier MUST NOT be null or empty.
    TEXT[!MUST,implication]: The AWS KMS key identifier MUST be [a valid identifier](aws-kms-key-arn.md#a-valid-aws-kms-identifier).
    TEXT[!MUST,implication]: The AWS KMS SDK client MUST NOT be null.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: OnEncrypt MUST take [encryption materials](../structures.md#encryption-materials) as input.
    TEXT[!MUST,implication]: If the input [encryption materials](../structures.md#encryption-materials) do not contain a plaintext data key
    TEXT[!MUST,implication]: OnEncrypt MUST attempt to generate a new plaintext data key
    TEXT[!MUST,implication]: by calling [AWS KMS GenerateDataKey](https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKey.html).
    TEXT[!MUST,implication]: If the keyring calls AWS KMS GenerateDataKeys,
    TEXT[!MUST,implication]: it MUST use the configured AWS KMS client to make the call.
    TEXT[!MUST,implication]: The keyring MUST call AWS KMS GenerateDataKeys with a request constructed as follows:
    TEXT[!MUST,implication]: If the call to [AWS KMS GenerateDataKey](https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKey.html) does not succeed,
    TEXT[!MUST,implication]: OnEncrypt MUST NOT modify the [encryption materials](../structures.md#encryption-materials) and MUST fail.
    TEXT[!MUST,implementation]: If the Generate Data Key call succeeds, OnEncrypt MUST verify that the response `Plaintext` length matches
    TEXT[!MUST,implementation]: the specification of the [algorithm suite](../algorithm-suites.md)'s Key Derivation Input Length field.
    TEXT[!MUST,implementation]: The Generate Data Key response’s `KeyId` MUST be [A valid AWS KMS key ARN](aws-kms-key-arn.md#identifying-an-aws-kms-multi-region-key).
    TEXT[!MUST,implication]: If verified, OnEncrypt MUST do the following with the response from [AWS KMS GenerateDataKey](https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKey.html):
    TEXT[!MUST,implication]: - OnEncrypt MUST output the modified [encryption materials](../structures.md#encryption-materials)
    TEXT[!MUST,implication]: If the input [encryption materials](../structures.md#encryption-materials) do contain a plaintext data key,
    TEXT[!MUST,implication]: OnEncrypt MUST attempt to encrypt the plaintext data key using the configured AWS KMS key identifier.
    TEXT[!MUST,implication]: The keyring MUST call [AWS KMS Encrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Encrypt.html) using the configured AWS KMS client.
    TEXT[!MUST,implication]: The keyring MUST AWS KMS Encrypt call with a request constructed as follows:
    TEXT[!MUST,implication]: If the call to [AWS KMS Encrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Encrypt.html) does not succeed, OnEncrypt MUST fail.
    TEXT[!MUST,implementation]: If the Encrypt call succeeds the response’s `KeyId` MUST be [A valid AWS KMS key ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn).
    TEXT[!MUST,implication]: If verified, OnEncrypt MUST do the following with the response from [AWS KMS Encrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Encrypt.html):
    TEXT[!MUST,implication]: If all Encrypt calls succeed, OnEncrypt MUST output the modified [encryption materials](../structures.md#encryption-materials).

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST,implication]: OnDecrypt MUST take [decryption materials](../structures.md#decryption-materials) and
    TEXT[!MUST,implication]: a list of [encrypted data keys](../structures.md#encrypted-data-key) as input.
    TEXT[!MUST]: If the [decryption materials](../structures.md#decryption-materials) already contained a valid plaintext data key
    TEXT[!MUST]: OnDecrypt MUST immediately return the unmodified [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation]: The set of encrypted data keys MUST first be filtered to match this keyring’s configuration.
    TEXT[!MUST,implication]: - Its provider ID MUST exactly match the value “aws-kms”.
    TEXT[!MUST,implementation]: - The provider info MUST be a [valid AWS KMS ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn) with a resource type of `key` or OnDecrypt MUST fail.
    TEXT[!MUST,implementation]: - The the function [AWS KMS MRK Match for Decrypt](aws-kms-mrk-match-for-decrypt.md#implementation)
    TEXT[!MUST,implementation]:   called with the configured AWS KMS key identifier and the provider info MUST return `true`.
    TEXT[!MUST,implementation]: For each encrypted data key in the filtered set, one at a time, the OnDecrypt MUST attempt to decrypt the data key.
    TEXT[!MUST,implementation]: If this attempt results in an error, then these errors MUST be collected.
    TEXT[!MUST,implication]: To attempt to decrypt a particular [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST,implication]: OnDecrypt MUST call [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html) with the configured AWS KMS client.
    TEXT[!MUST,implication]: When calling [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html), the keyring MUST call with a request constructed as follows:
    TEXT[!MUST,implication]: - The `KeyId` field in the response MUST equal the configured AWS KMS key identifier.
    TEXT[!MUST,implication]: - The length of the response’s `Plaintext` MUST equal the [key derivation input length](../algorithm-suites.md#key-derivation-input-length)
    TEXT[!MUST,implication]:   specified by the [algorithm suite](../algorithm-suites.md) included in the input [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation]: If the response does not satisfies these requirements then an error MUST be collected
    TEXT[!MUST,implementation]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST]: If the response does satisfies these requirements then OnDecrypt MUST do the following with the response:
    TEXT[!MUST]: If OnDecrypt fails to successfully decrypt any [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST]: then it MUST yield an error that includes all the collected errors.

SPECIFICATION: [AWS KMS MRK Match for Decrypt](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-mrk-match-for-decrypt.md)
  SECTION: [Implementation](#implementation)
    TEXT[!MUST,implication]: The caller MUST provide:
    TEXT[implication]: - 2 AWS KMS key identifiers
    TEXT[!MUST,implication]: If both identifiers are identical, this function MUST return `true`.
    TEXT[!MUST,implication]: Otherwise if either input is not [identified as a multi-Region key](aws-kms-key-arn.md#identifying-an-aws-kms-multi-region-key),
    TEXT[!MUST,implication]: then this function MUST return `false`.
    TEXT[!MUST,implication]: Otherwise if both inputs are [identified as a multi-Region keys](aws-kms-key-arn.md#identifying-an-aws-kms-multi-region-key),
    TEXT[!MUST,implication]: this function MUST return the result of comparing
    TEXT[!MUST,implication]: the `partition`, `service`, `accountId`, `resourceType`, and `resource` parts of both ARN inputs.

SPECIFICATION: [AWS KMS MRK Multi Keyrings](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-mrk-multi-keyrings.md)
  SECTION: [AWS KMS MRK Multi-Keyring](#aws-kms-mrk-multi-keyring)
    TEXT[!MUST]: The caller MUST provide:
    TEXT[!MUST,implication]: If any of the AWS KMS key identifiers is not a [valid AWS KMS key ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn), this function MUST fail
    TEXT[!MUST,implication]: All AWS KMS identifiers are passed to [Assert AWS KMS MRK are unique](aws-kms-mrk-are-unique.md#Implementation)
    TEXT[!MUST,implication]: and the function MUST return success otherwise this MUST fail.
    TEXT[!MUST,implementation]: If a regional client supplier is not passed, then a default MUST be created that takes a region string and generates a default AWS SDK client for the given region.
    TEXT[!MUST,implication]: If there is a generator input then the generator keyring MUST be a [AWS KMS MRK Keyring](aws-kms-mrk-keyring.md) initialized with
    TEXT[!MUST]: - The AWS KMS client that MUST be created by the regional client supplier
    TEXT[!MUST]:   when called with the region part of the generator ARN
    TEXT[!MUST]:   or a signal for the AWS SDK to select the default region.
    TEXT[!MUST,implication]: If there is a set of child identifiers then a set of [AWS KMS MRK Keyring](aws-kms-mrk-keyring.md) MUST be created for each AWS KMS key identifier by initialized each keyring with
    TEXT[!MUST]: - The AWS KMS client that MUST be created by the regional client supplier
    TEXT[!MUST]:   when called with the region part of the AWS KMS key identifier
    TEXT[!MUST]:   or a signal for the AWS SDK to select the default region.
    TEXT[!SHOULD,implication]: NOTE: The AWS Encryption SDK SHOULD NOT attempt to evaluate its own default region.
    TEXT[!MUST,implication]: Then a [Multi-Keyring](../multi-keyring.md#inputs) MUST be initialize by using this generator keyring as the [generator keyring](../multi-keyring.md#generator-keyring) and this set of child keyrings as the [child keyrings](../multi-keyring.md#child-keyrings).
    TEXT[!MUST,implication]: This Multi-Keyring MUST be this functions output.

  SECTION: [AWS KMS MRK Discovery Multi-Keyring](#aws-kms-mrk-discovery-multi-keyring)
    TEXT[!MUST,implication]: The caller MUST provide:
    TEXT[implication]: - A set of Region strings
    TEXT[implication]: - An optional discovery filter that is an AWS partition and a set of AWS accounts
    TEXT[implication]: - An optional method that can take a region string and return an AWS KMS client e.g. a regional client supplier
    TEXT[implication]: - An optional list of AWS KMS grant tokens
    TEXT[!MUST,implication]: If an empty set of Region is provided this function MUST fail.
    TEXT[!MUST,implication]: If any element of the set of regions is null or an empty string this function MUST fail.
    TEXT[!MUST]: If a regional client supplier is not passed, then a default MUST be created that takes a region string and generates a default AWS SDK client for the given region.
    TEXT[!MUST,implementation]: A set of AWS KMS clients MUST be created by calling regional client supplier for each region in the input set of regions.
    TEXT[!MUST,implication]: Then a set of [AWS KMS MRK Discovery Keyring](aws-kms-mrk-discovery-keyring.md) MUST be created for each AWS KMS client by initializing each keyring with
    TEXT[implication]: - The AWS KMS client
    TEXT[implication]: - The input discovery filter
    TEXT[implication]: - The input AWS KMS grant tokens
    TEXT[!MUST,implication]: Then a [Multi-Keyring](../multi-keyring.md#inputs) MUST be initialize by using this set of discovery keyrings as the [child keyrings](../multi-keyring.md#child-keyrings).
    TEXT[!MUST,implication]: This Multi-Keyring MUST be this functions output.

SPECIFICATION: [AWS KMS Multi Keyrings](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-multi-keyrings.md)
  SECTION: [AWS KMS Multi-Keyring](#aws-kms-multi-keyring)
    TEXT[!MUST]: The caller MUST provide:
    TEXT[!MUST,implication]: If any of the AWS KMS key identifiers is not a [valid AWS KMS key ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn), this function MUST fail.
    TEXT[!MUST,implementation]: If a regional client supplier is not passed, then a default MUST be created that takes a region string and generates a default AWS SDK client for the given region.
    TEXT[!MUST,implication]: If there is a generator input then the generator keyring MUST be a [AWS KMS Keyring](aws-kms-keyring.md) initialized with
    TEXT[!MUST]: - The AWS KMS client that MUST be created by the regional client supplier
    TEXT[!MUST]:   when called with the region part of the generator ARN
    TEXT[!MUST]:   or a signal for the AWS SDK to select the default region.
    TEXT[!MUST,implication]: If there is a set of child identifiers then a set of [AWS KMS Keyring](aws-kms-keyring.md) MUST be created for each AWS KMS key identifier by initializing each keyring with
    TEXT[!MUST]: - The AWS KMS client that MUST be created by the regional client supplier
    TEXT[!MUST]:   when called with the region part of the AWS KMS key identifier
    TEXT[!MUST]:   or a signal for the AWS SDK to select the default region.
    TEXT[!SHOULD,implication]: NOTE: The AWS Encryption SDK SHOULD NOT attempt to evaluate its own default region.
    TEXT[!MUST,implication]: Then a [Multi-Keyring](../multi-keyring.md#inputs) MUST be initialize by using this generator keyring as the [generator keyring](../multi-keyring.md#generator-keyring) and this set of child keyrings as the [child keyrings](../multi-keyring.md#child-keyrings).
    TEXT[!MUST,implication]: This Multi-Keyring MUST be this function's output.

  SECTION: [AWS KMS Discovery Multi-Keyring](#aws-kms-discovery-multi-keyring)
    TEXT[!MUST,implication]: The caller MUST provide:
    TEXT[implication]: - A set of Region strings
    TEXT[implication]: - An optional discovery filter that is an AWS partition and a set of AWS accounts
    TEXT[implication]: - An optional method that can take a region string and return an AWS KMS client e.g. a regional client supplier
    TEXT[implication]: - An optional list of AWS KMS grant tokens
    TEXT[!MUST,implication]: If an empty set of Region is provided this function MUST fail.
    TEXT[!MUST,implication]: If any element of the set of regions is null or an empty string this function MUST fail.
    TEXT[!MUST,implementation]: If a regional client supplier is not passed, then a default MUST be created that takes a region string and generates a default AWS SDK client for the given region.
    TEXT[!MUST,implementation]: A set of AWS KMS clients MUST be created by calling regional client supplier for each region in the input set of regions.
    TEXT[!MUST,implication]: Then a set of [AWS KMS Discovery Keyring](aws-kms-discovery-keyring.md) MUST be created for each AWS KMS client by initializing each keyring with
    TEXT[implication]: - The AWS KMS client
    TEXT[implication]: - The input discovery filter
    TEXT[implication]: - The input AWS KMS grant tokens
    TEXT[!MUST,implication]: Then a [Multi-Keyring](../multi-keyring.md#inputs) MUST be initialize by using this set of discovery keyrings as the [child keyrings](../multi-keyring.md#child-keyrings).
    TEXT[!MUST,implication]: This Multi-Keyring MUST be this functions output.

SPECIFICATION: [AWS KMS RSA Keyring](aws-encryption-sdk-specification/framework/aws-kms/aws-kms-rsa-keyring.md)
  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: - MUST provide an AWS KMS key identifier
    TEXT[!MUST,implication]: - MUST provide an [AWS KMS Encryption Algorithm](#supported-padding-schemes)
    TEXT[!MAY,implication]: - MAY provide a PEM encoded Public Key
    TEXT[!MAY,implication]: - MAY provide an AWS KMS SDK client
    TEXT[!MAY,implication]: - MAY provide a list of Grant Tokens
    TEXT[!MUST,implication]: The AWS KMS key identifier MUST NOT be null or empty.
    TEXT[!MUST,implication]: The AWS KMS key identifier MUST be [a valid identifier](../../framework/aws-kms/aws-kms-key-arn.md#a-valid-aws-kms-identifier).
    TEXT[!MUST,implication]: The AWS KMS key identifier MUST NOT be an AWS KMS alias.
    TEXT[!MUST,implication]: If provided the Public Key
    TEXT[!MUST,implication]: MUST have an RSA modulus bit length greater than or equal to 2048.

  SECTION: [AWS KMS Encryption Algorithm](#aws-kms-encryption-algorithm)
    TEXT[!MUST]: This value MUST correspond with one of the [supported padding schemes](#supported-padding-schemes).

  SECTION: [Supported Padding Schemes](#supported-padding-schemes)
    TEXT[!MUST]: This keyring MUST NOT use a padding scheme outside those defined above.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST]: OnEncrypt MUST fail if this keyring does not have a specified Public Key.
    TEXT[!MUST,implication]: OnEncrypt MUST fail if the input [encryption materials](../structures.md#encryption-materials)
    TEXT[!MUST,implication]: contains an [algorithm suite](../algorithm-suites.md) containing an
    TEXT[!MUST,implication]: [asymmetric signature](../algorithm-suites.md#asymmetric-signature-algorithm).
    TEXT[!MUST]: OnEncrypt MUST take [encryption materials](../structures.md#encryption-materials) as input.
    TEXT[!MUST]: If the [encryption materials](structures.md#encryption-materials) do not contain a plaintext data key,
    TEXT[!MUST]: OnEncrypt MUST generate a random plaintext data key and set it on the [encryption materials](structures.md#encryption-materials).
    TEXT[!MUST,implementation]: OnEncrypt MUST calculate a Encryption Context Digest by:
    TEXT[!MUST]: The keyring MUST determine the [Padding Scheme](#padding-scheme)
    TEXT[!MUST]: using the configured [AWS KMS Encryption Algorithm]((https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html#KMS-Decrypt-request-EncryptionAlgorithm).
    TEXT[!MUST]: If `RSAES_OAEP_SHA_256` the keyring
    TEXT[!MUST]: MUST use [OAEP with SHA-256 and MGF1 with SHA-256 Padding](https://tools.ietf.org/html/rfc8017#section-7.1).
    TEXT[!MUST]: If `RSAES_OAEP_SHA_1` the keyring
    TEXT[!MUST]: MUST use [OAEP with SHA-1 and MGF1 with SHA-1 Padding](https://tools.ietf.org/html/rfc8017#section-7.1)
    TEXT[!MUST]: The keyring MUST attempt to encrypt the plaintext data key in the
    TEXT[!MUST]: [encryption materials](structures.md#encryption-materials) using RSA.
    TEXT[!MUST]: If RSA encryption was successful, OnEncrypt MUST return the input
    TEXT[!MUST]: [encryption materials](structures.md#encryption-materials), modified in the following ways:
    TEXT[!MUST]:   - The [ciphertext](../structures.md#ciphertext) MUST field is the ciphertext output by the RSA encryption.
    TEXT[!MUST]:   - The [key provider id](../structures.md#key-provider-id) MUST be "aws-kms-rsa".
    TEXT[!MUST]:   - The [key provider information](../structures.md#key-provider-information) MUST be
    TEXT[!MUST]:     the configured `AWS KMS key identifier`.
    TEXT[!MUST]: If RSA encryption was NOT successful, OnEncrypt MUST fail.

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST]: OnDecrypt MUST fail if this keyring does not have a specified AWS KMS SDK client.
    TEXT[!MUST,implication]: OnDecrypt MUST fail if the input [decryption materials](../structures.md#decryption-materials)
    TEXT[!MUST,implication]: contains an [algorithm suite](../algorithm-suites.md) containing an
    TEXT[!MUST,implication]: [asymmetric signature](../algorithm-suites.md#asymmetric-signature-algorithm).
    TEXT[!MUST]: OnDecrypt MUST take [decryption materials](../structures.md#decryption-materials) and
    TEXT[!MUST]: a list of [encrypted data keys](../structures.md#encrypted-data-key) as input.
    TEXT[!MUST]: If the [decryption materials](../structures.md#decryption-materials) already contained a valid plaintext data key
    TEXT[!MUST]: OnDecrypt MUST return an error.
    TEXT[!MUST]: The set of encrypted data keys MUST first be filtered to match this keyring’s configuration.
    TEXT[!MUST]: - Its provider ID MUST exactly match the value “aws-kms-rsa”.
    TEXT[!MUST]: - The provider info MUST be a [valid AWS KMS ARN](aws-kms-key-arn.md#a-valid-aws-kms-arn)
    TEXT[!MUST]:   with a resource type of `key` or OnDecrypt MUST fail.
    TEXT[!MUST]: - The function [AWS KMS MRK Match for Decrypt](aws-kms-mrk-match-for-decrypt.md#implementation)
    TEXT[!MUST]:   called with the configured AWS KMS key identifier and the provider info MUST return `true`.
    TEXT[!MUST]: OnDecrypt MUST calculate a Encryption Context Digest Prime by:
    TEXT[!MUST]: For each encrypted data key in the filtered set,
    TEXT[!MUST]: one at a time,
    TEXT[!MUST]: the OnDecrypt MUST attempt to decrypt the data key.
    TEXT[!MUST]: If this attempt results in an error,
    TEXT[!MUST]: then these errors MUST be collected.
    TEXT[!MUST]: To attempt to decrypt a particular [encrypted data key](../structures.md#encrypted-data-key),
    TEXT[!MUST]: OnDecrypt MUST call [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html)
    TEXT[!MUST]: with the configured AWS KMS client.
    TEXT[!MUST]: When calling [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html),
    TEXT[!MUST]: the keyring MUST call with a request constructed as follows:
    TEXT[!MUST]: - `KeyId` MUST be the configured AWS KMS key identifier.
    TEXT[!MUST]: - `CiphertextBlob` MUST be the [encrypted data key ciphertext](../structures.md#ciphertext).
    TEXT[!MUST]: - `GrantTokens` MUST be this keyring's [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).
    TEXT[!MUST]: - `EncryptionAlgorithm` MUST be configured value.
    TEXT[!MUST]: - The `KeyId` field in the response MUST equal the configured AWS KMS key identifier.
    TEXT[!MUST]: If any decryption succeeds,
    TEXT[!MUST]: the result of this decryption MUST be split into
    TEXT[!MUST]: the encryption context digest and plaintext data key by:
    TEXT[!MUST]: The keyring MUST compare the decrypted encryption context digest
    TEXT[!MUST]: to the encryption context digest prime;
    TEXT[!MUST]: if the two are not equal,
    TEXT[!MUST]: the keyring MUST fail and
    TEXT[!MUST]: MUST NOT modify the [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST]: Otherwise, this keyring MUST immediately return the input
    TEXT[!MUST]: [decryption materials](structures.md#decryption-materials), modified in the following ways:
    TEXT[!MUST]: If no decryption and keyring digest check succeeds,
    TEXT[!MUST]: the keyring MUST fail
    TEXT[!MUST]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).

  SECTION: [Encryption Context Digest](#encryption-context-digest)
    TEXT[!MUST]: The fact that this digest is not truncated
    TEXT[!MUST]: means that this keyring MUST NOT
    TEXT[!MUST]: support 1024 bit keys.

SPECIFICATION: [Keystore](aws-encryption-sdk-specification/framework/branch-key-store.md)
  SECTION: [Initialization](#initialization)
    TEXT[!MAY,implementation,implication]: The following inputs MAY be specified to create a KeyStore:
    TEXT[implication]: - [ID](#keystore-id)
    TEXT[implication]: - [AWS KMS Grant Tokens](#aws-kms-grant-tokens)
    TEXT[implication]: - [DynamoDb Client](#dynamodb-client)
    TEXT[implication]: - [KMS Client](#kms-client)
    TEXT[!MUST,implementation,implication]: The following inputs MUST be specified to create a KeyStore:
    TEXT[implication]: - [Table Name](#table-name)
    TEXT[implication]: - [AWS KMS Configuration](#aws-kms-configuration)
    TEXT[implication]: - [Logical KeyStore Name](#logical-keystore-name)

  SECTION: [Keystore ID](#keystore-id)
    TEXT[!MUST,implementation,test]: If one is not supplied, then a [version 4 UUID](https://www.ietf.org/rfc/rfc4122.txt) MUST be used.

  SECTION: [DynamoDb Client](#dynamodb-client)
    TEXT[!MUST,implementation,todo]: If the AWS KMS Configuration is KMS Key ARN or KMS MRKey ARN,
    TEXT[!MUST,implementation,todo]: and no DynamoDb Client is provided,
    TEXT[!MUST,implementation,todo]: a new DynamoDb Client MUST be created
    TEXT[!MUST,implementation,todo]: with the region of the supplied KMS ARN.
    TEXT[!MUST,implementation,todo]: If the AWS KMS Configuration is Discovery,
    TEXT[!MUST,implementation,todo]: and no DynamoDb Client is provided,
    TEXT[!MUST,implementation,todo]: a new DynamoDb Client MUST be created
    TEXT[!MUST,implementation,todo]: with the default configuration.
    TEXT[!MUST,implementation]: If the AWS KMS Configuration is MRDiscovery,
    TEXT[!MUST,implementation]: and no DynamoDb Client is provided,
    TEXT[!MUST,implementation]: a new DynamoDb Client MUST be created
    TEXT[!MUST,implementation]: with the region configured in the MRDiscovery.

  SECTION: [KMS Client](#kms-client)
    TEXT[!MUST,implementation,todo]: If the AWS KMS Configuration is KMS Key ARN or KMS MRKey ARN,
    TEXT[!MUST,implementation,todo]: and no KMS Client is provided,
    TEXT[!MUST,implementation,todo]: a new KMS Client MUST be created
    TEXT[!MUST,implementation,todo]: with the region of the supplied KMS ARN.
    TEXT[!MUST,implementation,todo]: If the AWS KMS Configuration is Discovery,
    TEXT[!MUST,implementation,todo]: and no KMS Client is provided,
    TEXT[!MUST,implementation,todo]: a new KMS Client MUST be created
    TEXT[!MUST,implementation,todo]: with the default configuration.
    TEXT[!MUST,implementation]: If the AWS KMS Configuration is MRDiscovery,
    TEXT[!MUST,implementation]: and no KMS Client is provided,
    TEXT[!MUST,implementation]: a new KMS Client MUST be created
    TEXT[!MUST,implementation]: with the region configured in the MRDiscovery.
    TEXT[!SHOULD]: On initialization the KeyStore SHOULD
    TEXT[!SHOULD]: append a user agent string to the AWS KMS SDK Client with
    TEXT[!SHOULD]: the value `aws-kms-hierarchy`.

  SECTION: [AWS KMS Configuration](#aws-kms-configuration)
    TEXT[!MUST,implication]: `KMS Key ARN` and `KMS MRKey ARN` MUST take an additional argument
    TEXT[!MUST,implication]: that is a KMS ARN.
    TEXT[!MUST,implementation,test]: This ARN MUST NOT be an Alias.
    TEXT[!MUST,implication]: This ARN MUST be a valid
    TEXT[!MUST,implication]: [AWS KMS Key ARN](./aws-kms/aws-kms-key-arn.md#a-valid-aws-kms-arn).
    TEXT[!MAY]: To be clear, an KMS ARN for a Multi-Region Key MAY be provided to the `KMS Key ARN` configuration,
    TEXT[!MAY]: and a KMS ARN for non Multi-Region Key MAY be provided to the `KMS MRKey ARN` configuration.
    TEXT[!MUST,implication]: `MRDiscovery` MUST take an additional argument, which is a region.

  SECTION: [Discovery](#discovery)
    TEXT[!MAY]: The Keystore MAY use the KMS Key ARNs already
    TEXT[!MAY]: persisted to the backing DynamoDB table,
    TEXT[!MAY]: provided they are in records created
    TEXT[!MAY]: with an identical Logical Keystore Name.

  SECTION: [MRDiscovery](#mrdiscovery)
    TEXT[!MAY]: The Keystore MAY use the KMS Key ARNs already
    TEXT[!MAY]: persisted to the backing DynamoDB table,
    TEXT[!MAY]: provided they are in records created
    TEXT[!MAY]: with an identical Logical Keystore Name.

  SECTION: [Logical KeyStore Name](#logical-keystore-name)
    TEXT[!MUST,implication]: The logical keystore name MUST be bound to every created key.

  SECTION: [Operations](#operations)
    TEXT[!MUST,implication]: The Keystore MUST support the following operations:
    TEXT[implication]: - [GetKeyStoreInfo](#getkeystoreinfo)
    TEXT[implication]: - [CreateKeyStore](#createkeystore)
    TEXT[implication]: - [CreateKey](#createkey)
    TEXT[implication]: - [VersionKey](#versionkey)
    TEXT[implication]: - [GetActiveBranchKey](#getactivebranchkey)
    TEXT[implication]: - [GetBranchKeyVersion](#getbranchkeyversion)
    TEXT[implication]: - [GetBeaconKey](#getbeaconkey)

  SECTION: [GetKeyStoreInfo](#getkeystoreinfo)
    TEXT[!MUST,implication]: This operation MUST return the keystore information in this keystore configuration.
    TEXT[!MUST,implication]: This MUST include:

  SECTION: [CreateKeyStore](#createkeystore)
    TEXT[!MUST,implementation,implication]: This operation MUST first calls the DDB::DescribeTable API with the configured `tableName`.
    TEXT[implementation]: If the response is successful, this operation validates that the table has the expected
    TEXT[implementation]: [KeySchema](#keyschema) as defined below.
    TEXT[!MUST,implementation,implication]: If the [KeySchema](#keyschema) does not match
    TEXT[!MUST,implementation,implication]: this operation MUST yield an error.
    TEXT[!MAY,implication]: The table MAY have additional information,
    TEXT[!MAY,implication]: like GlobalSecondaryIndex defined.
    TEXT[!MUST,implementation,implication]: If the client responds with a `ResourceNotFoundException`,
    TEXT[!MUST,implementation,implication]: then this operation MUST continue and
    TEXT[!MUST,implementation,implication]: MUST call [AWS DDB CreateTable](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_CreateTable.html)
    TEXT[!MUST,implementation,implication]: with the following specifics:
    TEXT[implication]: - TableName is the configured tableName.
    TEXT[implication]: - [KeySchema](#keyschema) as defined below.
    TEXT[!MUST,implementation,implication]: If the operation fails to create table, the operation MUST fail.
    TEXT[!MUST,implementation,implication]: If the operation successfully creates a table, the operation MUST return the AWS DDB Table Arn
    TEXT[!MUST,implementation,implication]: back to the caller.

  SECTION: [KeySchema](#keyschema)
    TEXT[!MUST,implementation,implication]: The following KeySchema MUST be configured on the table:

  SECTION: [CreateKey](#createkey)
    TEXT[!MUST,implication]: The CreateKey caller MUST provide:
    TEXT[implication]: - An optional branch key id
    TEXT[implication]: - An optional encryption context
    TEXT[!MUST,implication]: If an optional branch key id is provided
    TEXT[!MUST,implication]: and no encryption context is provided this operation MUST fail.
    TEXT[!MUST,implication]: If the Keystore's KMS Configuration is `Discovery` or `MRDiscovery`,
    TEXT[!MUST,implication]: this operation MUST fail.
    TEXT[!MUST,implementation,test]: If no branch key id is provided,
    TEXT[!MUST,implementation,test]: then this operation MUST create a [version 4 UUID](https://www.ietf.org/rfc/rfc4122.txt)
    TEXT[!MUST,implementation,test]: to be used as the branch key id.
    TEXT[!MUST,implication]: This operation MUST create a [branch key](structures.md#branch-key) and a [beacon key](structures.md#beacon-key) according to
    TEXT[!MUST,implication]: the [Branch Key and Beacon Key Creation](#branch-key-and-beacon-key-creation) section.
    TEXT[!MUST,implication]: If creation of the keys are successful,
    TEXT[!MUST,implication]: the operation MUST call Amazon DynamoDB TransactWriteItems according to the [write key material](#writing-branch-key-and-beacon-key-to-keystore) section.
    TEXT[!MUST,implication]: If writing to the keystore succeeds,
    TEXT[!MUST,implication]: the operation MUST return the branch-key-id that maps to both
    TEXT[!MUST,implication]: the branch key and the beacon key.
    TEXT[!MUST,implication]: Otherwise, this operation MUST yield an error.

  SECTION: [Branch Key and Beacon Key Creation](#branch-key-and-beacon-key-creation)
    TEXT[!MUST,implication]: To create a branch key, this operation MUST take the following:
    TEXT[implication]: - `branchKeyId`: The identifier
    TEXT[implication]: - `encryptionContext`: Additional encryption context to bind to the created keys
    TEXT[implementation]: - `version`: a new guid.
    TEXT[!MUST,implementation,test]: This guid MUST be [version 4 UUID](https://www.ietf.org/rfc/rfc4122.txt)
    TEXT[implementation]: - `timestamp`: a timestamp for the current time.
    TEXT[!MUST,implementation]:   This timestamp MUST be in ISO 8601 format in UTC, to microsecond precision (e.g.
    TEXT[implementation]:  “YYYY-MM-DDTHH:mm:ss.ssssssZ“)
    TEXT[!MUST,implication]: The wrapped Branch Keys, DECRYPT_ONLY and ACTIVE, MUST be created according to [Wrapped Branch Key Creation](#wrapped-branch-key-creation).
    TEXT[!MUST,implication]: The operation MUST call [AWS KMS API GenerateDataKeyWithoutPlaintext](https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKeyWithoutPlaintext.html).
    TEXT[!MUST,implication]: The call to AWS KMS GenerateDataKeyWithoutPlaintext MUST use the configured AWS KMS client to make the call.
    TEXT[!MUST,implication]: The operation MUST call AWS KMS GenerateDataKeyWithoutPlaintext with a request constructed as follows:
    TEXT[!MUST,implication]: - `KeyId` MUST be [compatible with](#aws-key-arn-compatibility) the configured KMS Key in the [AWS KMS Configuration](#aws-kms-configuration) for this keystore.
    TEXT[!MUST,implication]: - `NumberOfBytes` MUST be 32.
    TEXT[!MUST,implication]: - `EncryptionContext` MUST be the [encryption context for beacon keys](#beacon-key-encryption-context).
    TEXT[!MUST,implication]: - `GrantTokens` MUST be this keystore's [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).
    TEXT[!MUST,implication]: If the call to AWS KMS GenerateDataKeyWithoutPlaintext succeeds,
    TEXT[!MUST,implication]: the operation MUST use the `CiphertextBlob` as the wrapped Beacon Key.

  SECTION: [Wrapped Branch Key Creation](#wrapped-branch-key-creation)
    TEXT[!MUST,implication]: The operation MUST call [AWS KMS API GenerateDataKeyWithoutPlaintext](https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKeyWithoutPlaintext.html).
    TEXT[!MUST,implication]: The call to AWS KMS GenerateDataKeyWithoutPlaintext MUST use the configured AWS KMS client to make the call.
    TEXT[!MUST,implication]: The operation MUST call AWS KMS GenerateDataKeyWithoutPlaintext with a request constructed as follows:
    TEXT[!MUST,implication]: - `KeyId` MUST be [compatible with](#aws-key-arn-compatibility) the configured KMS Key in the [AWS KMS Configuration](#aws-kms-configuration) for this keystore.
    TEXT[!MUST,implication]: - `NumberOfBytes` MUST be 32.
    TEXT[!MUST,implication]: - `EncryptionContext` MUST be the [DECRYPT_ONLY encryption context for branch keys](#decrypt_only-encryption-context).
    TEXT[!MUST,implication]: - GenerateDataKeyWithoutPlaintext `GrantTokens` MUST be this keystore's [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).
    TEXT[!MUST,implication]: If the call to AWS KMS GenerateDataKeyWithoutPlaintext succeeds,
    TEXT[!MUST,implication]: the operation MUST use the GenerateDataKeyWithoutPlaintext result `CiphertextBlob`
    TEXT[!MUST,implication]: as the wrapped DECRYPT_ONLY Branch Key.
    TEXT[!MUST,implication]: The operation MUST call [AWS KMS API ReEncrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_ReEncrypt.html)
    TEXT[!MUST,implication]: with a request constructed as follows:
    TEXT[!MUST,implication]: - `SourceEncryptionContext` MUST be the [DECRYPT_ONLY encryption context for branch keys](#decrypt_only-encryption-context).
    TEXT[!MUST,implication]: - `SourceKeyId` MUST be [compatible with](#aws-key-arn-compatibility) the configured KMS Key in the [AWS KMS Configuration](#aws-kms-configuration) for this keystore.
    TEXT[!MUST,implication]: - `CiphertextBlob` MUST be the wrapped DECRYPT_ONLY Branch Key.
    TEXT[!MUST,implication]: - ReEncrypt `GrantTokens` MUST be this keystore's [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).
    TEXT[!MUST,implication]: - `DestinationKeyId` MUST be [compatible with](#aws-key-arn-compatibility) the configured KMS Key in the [AWS KMS Configuration](#aws-kms-configuration) for this keystore.
    TEXT[!MUST,implication]: - `DestinationEncryptionContext` MUST be the [ACTIVE encryption context for branch keys](#active-encryption-context).
    TEXT[!MUST,implication]: If the call to AWS KMS ReEncrypt succeeds,
    TEXT[!MUST,implication]: the operation MUST use the ReEncrypt result `CiphertextBlob`
    TEXT[!MUST,implication]: as the wrapped ACTIVE Branch Key.

  SECTION: [Writing Branch Key and Beacon Key to Keystore](#writing-branch-key-and-beacon-key-to-keystore)
    TEXT[!MUST,implication]: To add the branch keys and a beacon key to the keystore the
    TEXT[!MUST,implication]: operation MUST call [Amazon DynamoDB API TransactWriteItems](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_TransactWriteItems.html).
    TEXT[!MUST,implication]: The call to Amazon DynamoDB TransactWriteItems MUST use the configured Amazon DynamoDB Client to make the call.
    TEXT[!MUST,implication]: The operation MUST call Amazon DynamoDB TransactWriteItems with a request constructed as follows:
    TEXT[!MUST,implication]:     - Every key-value pair of the custom [encryption context](./structures.md#encryption-context-3) that is associated with the branch key
    TEXT[!MUST,implication]:       MUST be added with an Attribute Name of `aws-crypto-ec:` + the Key and Attribute Value (S) of the value.
    TEXT[!MUST,implication]: If DDB TransactWriteItems is successful, this operation MUST return a successful response containing no additional data.
    TEXT[!MUST,implication]: Otherwise, this operation MUST yield an error.

  SECTION: [VersionKey](#versionkey)
    TEXT[!MUST,implication]: - MUST supply a `branch-key-id`
    TEXT[!MUST,implication]: If the Keystore's KMS Configuration is `Discovery` or `MRDiscovery`,
    TEXT[!MUST,implication]: this operation MUST immediately fail.
    TEXT[!MUST,implication]: VersionKey MUST first get the active version for the branch key from the keystore
    TEXT[!MUST,implication]: by calling AWS DDB `GetItem`
    TEXT[!MUST,implication]: using the `branch-key-id` as the Partition Key and `"branch:ACTIVE"` value as the Sort Key.
    TEXT[!MUST,implication,todo]: The `kms-arn` field of DDB response item MUST be [compatible with](#aws-key-arn-compatibility)
    TEXT[!MUST,implication,todo]: the configured `KMS ARN` in the [AWS KMS Configuration](#aws-kms-configuration) for this keystore.
    TEXT[!MUST]: The `kms-arn` stored in the DDB table MUST NOT change as a result of this operation,
    TEXT[!MUST]: even if the KeyStore is configured with a `KMS MRKey ARN` that does not exactly match the stored ARN.
    TEXT[!MUST,implication]: The values on the AWS DDB response item
    TEXT[!MUST,implication]: MUST be authenticated according to [authenticating a keystore item](#authenticating-a-keystore-item).
    TEXT[!MUST,implication]: If the item fails to authenticate this operation MUST fail.
    TEXT[!MUST,implication]: The wrapped Branch Keys, DECRYPT_ONLY and ACTIVE, MUST be created according to [Wrapped Branch Key Creation](#wrapped-branch-key-creation).
    TEXT[!MUST,implication]: To add the new branch key to the keystore,
    TEXT[!MUST,implication]: the operation MUST call [Amazon DynamoDB API TransactWriteItems](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_TransactWriteItems.html).
    TEXT[!MUST,implication]: The call to Amazon DynamoDB TransactWriteItems MUST use the configured Amazon DynamoDB Client to make the call.
    TEXT[!MUST,implication]: The operation MUST call Amazon DynamoDB TransactWriteItems with a request constructed as follows:
    TEXT[!MUST,test]:     - Every key-value pair of the custom [encryption context](./structures.md#encryption-context-3) that is associated with the branch key
    TEXT[!MUST,test]:       MUST be added with an Attribute Name of `aws-crypto-ec:` + the Key and Attribute Value (S) of the value.
    TEXT[!MUST,implication]: If DDB TransactWriteItems is successful, this operation MUST return a successful response containing no additional data.
    TEXT[!MUST,implication]: Otherwise, this operation MUST yield an error.

  SECTION: [Authenticating a Keystore item](#authenticating-a-keystore-item)
    TEXT[!MUST,implication]: The operation MUST use the configured `KMS SDK Client` to authenticate the value of the keystore item.
    TEXT[!MUST,implication]: Every key in the constructed [encryption context](#encryption-context)
    TEXT[!MUST,implication]: except `tableName`
    TEXT[!MUST,implication]: MUST exist as a string attribute in the AWS DDB response item.
    TEXT[!MUST,implication]: Every value in the constructed [encryption context](#encryption-context)
    TEXT[!MUST,implication]: except the logical table name
    TEXT[!MUST,implication]: MUST equal the value with the same key in the AWS DDB response item.
    TEXT[!MUST,implementation,implication]: The key `enc` MUST NOT exist in the constructed [encryption context](#encryption-context).
    TEXT[!MUST,implication]: The operation MUST call [AWS KMS API ReEncrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_ReEncrypt.html)
    TEXT[!MUST,implication]: with a request constructed as follows:
    TEXT[!MUST,implication]: - `SourceEncryptionContext` MUST be the [encryption context](#encryption-context) constructed above
    TEXT[!MUST,implication]: - `SourceKeyId` MUST be [compatible with](#aws-key-arn-compatibility) the configured KMS Key in the [AWS KMS Configuration](#aws-kms-configuration) for this keystore.
    TEXT[!MUST,implication]: - `CiphertextBlob` MUST be the `enc` attribute value on the AWS DDB response item
    TEXT[!MUST,implication]: - `GrantTokens` MUST be the configured [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).
    TEXT[!MUST,implication]: - `DestinationKeyId` MUST be [compatible with](#aws-key-arn-compatibility) the configured KMS Key in the [AWS KMS Configuration](#aws-kms-configuration) for this keystore.
    TEXT[!MUST,implication]: - `DestinationEncryptionContext` MUST be the [encryption context](#encryption-context) constructed above

  SECTION: [GetActiveBranchKey](#getactivebranchkey)
    TEXT[!MUST,implication]: - MUST supply a `branch-key-id`
    TEXT[!MUST,implication]: To get the active version for the branch key id from the keystore
    TEXT[!MUST,implication]: this operation MUST call AWS DDB `GetItem`
    TEXT[!MUST,implication]: using the `branch-key-id` as the Partition Key and `"branch:ACTIVE"` value as the Sort Key.
    TEXT[!MUST,implication]: The AWS DDB response MUST contain the fields defined in the [branch keystore record format](#record-format).
    TEXT[!MUST,implication]: If the record does not contain the defined fields, this operation MUST fail.
    TEXT[!MUST,implication]: The operation MUST decrypt the branch key according to the [AWS KMS Branch Key Decryption](#aws-kms-branch-key-decryption) section.
    TEXT[!MUST,implication]: If the branch key fails to decrypt, GetActiveBranchKey MUST fail.
    TEXT[!MUST,implication]: This GetActiveBranchKey MUST construct [branch key materials](./structures.md#branch-key-materials)
    TEXT[!MUST,implication]: according to [Branch Key Materials From Authenticated Encryption Context](#branch-key-materials-from-authenticated-encryption-context).
    TEXT[!MUST,implication]: This operation MUST return the constructed [branch key materials](./structures.md#branch-key-materials).

  SECTION: [GetBranchKeyVersion](#getbranchkeyversion)
    TEXT[!MUST,implication]: - MUST supply a `branch-key-id`
    TEXT[!MUST,implication]: - MUST supply a `branchKeyVersion`
    TEXT[!MUST,implication]: To get a branch key from the keystore this operation MUST call AWS DDB `GetItem`
    TEXT[!MUST,implication]: using the `branch-key-id` as the Partition Key and "branch:version:" + `branchKeyVersion` value as the Sort Key.
    TEXT[!MUST,implication]: The AWS DDB response MUST contain the fields defined in the [branch keystore record format](#record-format).
    TEXT[!MUST,implication]: If the record does not contain the defined fields, this operation MUST fail.
    TEXT[!MUST,implication]: The operation MUST decrypt the branch key according to the [AWS KMS Branch Key Decryption](#aws-kms-branch-key-decryption) section.
    TEXT[!MUST,implication]: If the branch key fails to decrypt, this operation MUST fail.
    TEXT[!MUST,implication]: This GetBranchKeyVersion MUST construct [branch key materials](./structures.md#branch-key-materials)
    TEXT[!MUST,implication]: according to [Branch Key Materials From Authenticated Encryption Context](#branch-key-materials-from-authenticated-encryption-context).
    TEXT[!MUST,implication]: This operation MUST return the constructed [branch key materials](./structures.md#branch-key-materials).

  SECTION: [GetBeaconKey](#getbeaconkey)
    TEXT[!MUST,implication]: - MUST supply a `branch-key-id`
    TEXT[!MUST,implication]: To get a branch key from the keystore this operation MUST call AWS DDB `GetItem`
    TEXT[!MUST,implication]: using the `branch-key-id` as the Partition Key and "beacon:ACTIVE" value as the Sort Key.
    TEXT[!MUST,implication]: The AWS DDB response MUST contain the fields defined in the [branch keystore record format](#record-format).
    TEXT[!MUST,implication]: If the record does not contain the defined fields, this operation MUST fail.
    TEXT[!MUST,implication]: The operation MUST decrypt the beacon key according to the [AWS KMS Branch Key Decryption](#aws-kms-branch-key-decryption) section.
    TEXT[!MUST,implication]: If the beacon key fails to decrypt, this operation MUST fail.
    TEXT[!MUST,implication]: This GetBeaconKey MUST construct [beacon key materials](./structures.md#beacon-key-materials) from the decrypted branch key material
    TEXT[!MUST,implication]: and the `branchKeyId` from the returned `branch-key-id` field.
    TEXT[!MUST,implication]: This operation MUST return the constructed [beacon key materials](./structures.md#beacon-key-materials).

  SECTION: [Encryption Context](#encryption-context)
    TEXT[!MUST,implication]: - MUST have a `branch-key-id` attribute
    TEXT[!MUST,implication]: - The `branch-key-id` field MUST not be an empty string
    TEXT[!MUST,implication]: - MUST have a `type` attribute
    TEXT[!MUST,implication]: - The `type` field MUST not be an empty string
    TEXT[!MUST,implication]: - MUST have a `create-time` attribute
    TEXT[!MUST,implication]: - MUST have a `tablename` attribute to store the logicalKeyStoreName
    TEXT[!MUST,implication]: - MUST have a `kms-arn` attribute
    TEXT[!MUST,implication]: - MUST have a `hierarchy-version`
    TEXT[!MUST,implication]: - MUST NOT have a `enc` attribute
    TEXT[!MUST,implication]: Any additionally attributes on the DynamoDB item
    TEXT[!MUST,implication]: MUST be added to the encryption context.

  SECTION: [ACTIVE Encryption Context](#active-encryption-context)
    TEXT[!MUST,implication]: The ACTIVE encryption context value of the `type` attribute MUST equal to `"branch:ACTIVE"`.
    TEXT[!MUST,implication]: The ACTIVE encryption context MUST have a `version` attribute.
    TEXT[!MUST,implication]: The `version` attribute MUST store the branch key version formatted like `"branch:version:"` + `version`.

  SECTION: [DECRYPT_ONLY Encryption Context](#decrypt-only-encryption-context)
    TEXT[!MUST,implication]: The DECRYPT_ONLY encryption context MUST NOT have a `version` attribute.
    TEXT[!MUST,implication]: The `type` attribute MUST stores the branch key version formatted like `"branch:version:"` + `version`.

  SECTION: [Beacon Key Encryption Context](#beacon-key-encryption-context)
    TEXT[!MUST,implication]: The Beacon key encryption context value of the `type` attribute MUST equal to `"beacon:ACTIVE"`.
    TEXT[!MUST,implication]: The Beacon key encryption context MUST NOT have a `version` attribute.

  SECTION: [Custom Encryption Context](#custom-encryption-context)
    TEXT[!MUST,implication]: If custom [encryption context](./structures.md#encryption-context-3)
    TEXT[!MUST,implication]: is associated with the branch key these values MUST be added to the AWS KMS encryption context.
    TEXT[!MUST,implication]: To avoid name collisions each added attribute from the custom [encryption context](./structures.md#encryption-context-3)
    TEXT[!MUST,implication]: MUST be prefixed with `aws-crypto-ec:`.
    TEXT[!MUST,implication,exception]: Across all versions of a Branch Key, the custom encryption context MUST be equal.

  SECTION: [AWS KMS Branch Key Decryption](#aws-kms-branch-key-decryption)
    TEXT[!MUST,implication]: The operation MUST use the configured `KMS SDK Client` to decrypt the value of the branch key field.
    TEXT[!MUST,implication]: Every attribute except for `enc` on the AWS DDB response item
    TEXT[!MUST,implication]: MUST be authenticated in the decryption of `enc`
    TEXT[!MUST,implication]: Every key in the constructed [encryption context](#encryption-context)
    TEXT[!MUST,implication]: except `tableName`
    TEXT[!MUST,implication]: MUST exist as a string attribute in the AWS DDB response item.
    TEXT[!MUST,implication]: Every value in the constructed [encryption context](#encryption-context)
    TEXT[!MUST,implication]: except the logical table name
    TEXT[!MUST,implication]: MUST equal the value with the same key in the AWS DDB response item.
    TEXT[!MUST,implication]: The key `enc` MUST NOT exist in the constructed [encryption context](#encryption-context).
    TEXT[!MUST,implication]: If the Keystore's [AWS KMS Configuration](#aws-kms-configuration) is `KMS Key ARN` or `KMS MRKey ARN`,
    TEXT[!MUST,implication]: the `kms-arn` field of the DDB response item MUST be
    TEXT[!MUST,implication]: [compatible with](#aws-key-arn-compatibility) the configured KMS Key in
    TEXT[!MUST,implication]: the [AWS KMS Configuration](#aws-kms-configuration) for this keystore,
    TEXT[!MUST,implication]: or the operation MUST fail.
    TEXT[!MUST,implication]: If the Keystore's [AWS KMS Configuration](#aws-kms-configuration) is `Discovery` or `MRDiscovery`,
    TEXT[!MUST,implication]: the `kms-arn` field of DDB response item MUST NOT be an Alias
    TEXT[!MUST,implication]: or the operation MUST fail.
    TEXT[!MUST,implication]: When calling [AWS KMS Decrypt](https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html),
    TEXT[!MUST,implication]: the keystore operation MUST call with a request constructed as follows:
    TEXT[!MUST,implication]: - `KeyId`, if the KMS Configuration is Discovery, MUST be the `kms-arn` attribute value of the AWS DDB response item.
    TEXT[!MUST,implication]:   If the KMS Configuration is MRDiscovery, `KeyId` MUST be the `kms-arn` attribute value of the AWS DDB response item, with the region replaced by the configured region.
    TEXT[!MUST,implication]:   Otherwise, it MUST BE the Keystore's configured KMS Key.
    TEXT[!MUST,implication]: - `CiphertextBlob` MUST be the `enc` attribute value on the AWS DDB response item
    TEXT[!MUST,implication]: - `EncryptionContext` MUST be the [encryption context](#encryption-context) constructed above
    TEXT[!MUST,implication]: - `GrantTokens` MUST be this keystore's [grant tokens](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#grant_token).

  SECTION: [Record Format](#record-format)
    TEXT[!MUST,implication]: A branch key record MUST include the following key-value pairs:
    TEXT[!MAY,implication]: A branch key record MAY include [custom encryption context](#custom-encryption-context) key-value pairs.

  SECTION: [Branch Key Materials From Authenticated Encryption Context](#branch-key-materials-from-authenticated-encryption-context)
    TEXT[!MUST,implication]: The `type` attribute MUST either be equal to `"branch:ACTIVE"` or start with `"branch:version:"`.
    TEXT[!MUST,implication]: If the `type` attribute is equal to `"branch:ACTIVE"`
    TEXT[!MUST,implication]: then the authenticated encryption context MUST have a `version` attribute
    TEXT[!MUST,implication]: and the version string is this value.
    TEXT[!MUST,implication]: If the `type` attribute start with `"branch:version:"` then the version string MUST be equal to this value.
    TEXT[!MUST,implication]: - [Branch Key](./structures.md#branch-key) MUST be the [decrypted branch key material](#aws-kms-branch-key-decryption)
    TEXT[!MUST,implication]: - [Branch Key Id](./structures.md#branch-key-id) MUST be the `branch-key-id`
    TEXT[!MUST,implication]: - [Branch Key Version](./structures.md#branch-key-version)
    TEXT[!MUST,implication]:   The version string MUST start with `branch:version:`.
    TEXT[!MUST,implication]:   The remaining string encoded as UTF8 bytes MUST be the Branch Key version.
    TEXT[!MUST,implication]: - [Encryption Context](./structures.md#encryption-context-3) MUST be constructed by
    TEXT[!MUST,implication]:   [Custom Encryption Context From Authenticated Encryption Context](#custom-encryption-context-from-authenticated-encryption-context)

  SECTION: [Custom Encryption Context From Authenticated Encryption Context](#custom-encryption-context-from-authenticated-encryption-context)
    TEXT[!MUST,implication]: For every key in the [encryption context](./structures.md#encryption-context-3)
    TEXT[!MUST,implication]: the string `aws-crypto-ec:` + the UTF8 decode of this key
    TEXT[!MUST,implication]: MUST exist as a key in the authenticated encryption context.
    TEXT[!MUST,implication]: Also, the value in the [encryption context](./structures.md#encryption-context-3) for this key
    TEXT[!MUST,implication]: MUST equal the value in the authenticated encryption context
    TEXT[!MUST,implication]: for the constructed key.

SPECIFICATION: [Caching Cryptographic Materials Manager](aws-encryption-sdk-specification/framework/caching-cmm.md)
  SECTION: [Initialization](#initialization)
    TEXT[!MUST]: On caching CMM initialization,
    TEXT[!MUST]: the caller MUST provide the following values:
    TEXT[!MUST]: Additionally, the caller MUST provide one of the following values:
    TEXT[!MUST]: If the caller provides a keyring,
    TEXT[!MUST]: then the caching CMM MUST set its underlying CMM
    TEXT[!MUST]: to a [default CMM](default-cmm.md) initialized with the keyring.
    TEXT[!MUST]: Finally, the caching CMM MUST optionally accept the following values:

  SECTION: [Underlying Cryptographic Materials Cache](#underlying-cryptographic-materials-cache)
    TEXT[!MUST]: Multiple caching CMMs MAY share the same cryptographic materials cache,
    TEXT[!MUST]: but by default MUST NOT use each other's cache entries.

  SECTION: [Cache Limit TTL](#cache-limit-ttl)
    TEXT[!MUST]: The Caching CMM MUST set a time-to-live (TTL) for data keys in the CMC.

  SECTION: [Partition ID](#partition-id)
    TEXT[!MUST]: If this parameter is not set, the caching CMM MUST set a partition ID
    TEXT[!MUST]: that uniquely identifies the respective caching CMM.
    TEXT[!MUST]: The Partition ID MUST NOT be changed after initialization.

  SECTION: [Limit Bytes](#limit-bytes)
    TEXT[!MAY]: The maximum number of bytes that MAY be encrypted by a single data key.
    TEXT[!MUST]: If this parameter is not set, the caching CMM MUST set it to a value no more than 2^63-1.

  SECTION: [Limit Messages](#limit-messages)
    TEXT[!MAY]: The maximum number of messages that MAY be encrypted by a single data key.
    TEXT[!MUST]: If this parameter is not set, the caching CMM MUST set it to 2^32.
    TEXT[!MUST]: The caching CMM MUST provide a structure as defined below,
    TEXT[!MUST]: to track usage statistics.

  SECTION: [Usage Stats](#usage-stats)
    TEXT[!MUST]: When the caching CMM stores encryption materials into the cryptographic materials cache,
    TEXT[!MUST]: the caching CMM MUST set the initial usage stats for the cache entry.
    TEXT[!MUST]: When the caching CMM obtains encryption materials from the cryptographic materials cache,
    TEXT[!MUST]: the caching CMM MUST update the usage stats for the cache entry retrieved.

  SECTION: [Get Encryption Materials](#get-encryption-materials)
    TEXT[!MUST]: If the [algorithm suite](algorithm-suites.md) requested contains a [Identity KDF](algorithm-suites.md#identity-kdf),
    TEXT[!MUST]: the caching CMM MUST obtain the encryption materials by making a call to the underlying CMM's [Get Encryption Materials](cmm-interface.md#get-encryption-materials) function.
    TEXT[!MUST]: Otherwise, the caching CMM MUST attempt to find the [encryption materials](structures.md#encryption-materials)
    TEXT[!MUST]: from the underlying [cryptographic materials cache (CMC)](#underlying-cryptographic-materials-cache).
    TEXT[!MUST]: The caching CMM MUST use the formulas specified in [Appendix A](#appendix-a-cache-entry-identifier-formulas)
    TEXT[!MUST]: in order to compute the [cache entry identifier](cryptographic-materials-cache.md#cache-identifier).
    TEXT[!MUST]: If a cache entry is found, the caching CMM MUST return the encryption materials retrieved.
    TEXT[!MUST]: If a cache entry is not found or the cache entry is expired, the caching CMM MUST then attempt to obtain the encryption materials
    TEXT[!MUST]: by making a call to the underlying CMM's [Get Encryption Materials](cmm-interface.md#get-encryption-materials).
    TEXT[!MUST]: If the [algorithm suite](algorithm-suites.md) requested does not contain an [Identity KDF](algorithm-suites.md#identity-kdf),
    TEXT[!MUST]: the caching CMM MUST add the encryption materials obtained from the underlying CMM into the underlying CMC.
    TEXT[!MUST]: If the [algorithm suite](algorithm-suites.md) requested contains an Identity KDF,
    TEXT[!MUST]: the caching CMM MUST NOT store the encryption materials in the underlying CMC.

  SECTION: [Decrypt Materials](#decrypt-materials)
    TEXT[!MUST]: If the [algorithm suite](algorithm-suites.md) requested contains a [Identity KDF](algorithm-suites.md#identity-kdf),
    TEXT[!MUST]: the caching CMM MUST obtain the decryption materials by making a call to the underlying CMM's [Decrypt Materials](cmm-interface.md#decrypt-materials) function.
    TEXT[!MUST]: Otherwise, the caching CMM MUST attempt to find the [decryption materials](structures.md#decryption-materials)
    TEXT[!MUST]: from the [underlying CMC](#underlying-cryptographic-materials-cache).
    TEXT[!MUST]: The caching CMM MUST use the formulas specified in [Appendix A](#appendix-a-cache-entry-identifier-formulas)
    TEXT[!MUST]: in order to compute the [cache entry identifier](cryptographic-materials-cache.md#cache-identifier).
    TEXT[!MUST]: If a cache entry is found, the caching CMM MUST return the decryption materials retrieved.
    TEXT[!MUST]: If a cache entry is not found or the cache entry is expired, the caching CMM MUST attempt to obtain the decryption materials
    TEXT[!MUST]: by making a call to the underlying CMM's [Decrypt Materials](cmm-interface.md#decrypt-materials).
    TEXT[!MUST]: If the [algorithm suite](algorithm-suites.md) requested does not contain an [Identity KDF](algorithm-suites.md#identity-kdf),
    TEXT[!MUST]: the caching CMM MUST add the decryption materials obtained from the underlying CMM into the underlying CMC.
    TEXT[!MUST]: If the [algorithm suite](algorithm-suites.md) requested contains an Identity KDF,
    TEXT[!MUST]: the caching CMM MUST NOT store the decryption materials in the underlying CMC.

  SECTION: [Appendix A: Cache Entry Identifier Formulas](#appendix-a-cache-entry-identifier-formulas)
    TEXT[!MUST]: When accessing the underlying CMC,
    TEXT[!MUST]: the caching CMM MUST use the formulas specified in this appendix
    TEXT[!MUST]: in order to compute the [cache entry identifier](cryptographic-materials-cache.md#cache-identifier).

  SECTION: [Encryption Materials, Without Algorithm Suite](#encryption-materials-without-algorithm-suite)
    TEXT[!MUST]: If the Get Encryption Materials request does not specify an algorithm suite,
    TEXT[!MUST]: then the cache entry identifier MUST be calculated
    TEXT[!MUST]: as the SHA-512 hash of the concatenation of the following byte strings,
    TEXT[!MUST]: in the order listed:

  SECTION: [Encryption Materials, With Algorithm Suite](#encryption-materials-with-algorithm-suite)
    TEXT[!MUST]: If the Get Encryption Materials request does specify an algorithm suite,
    TEXT[!MUST]: then the cache entry identifier MUST be calculated
    TEXT[!MUST]: as the SHA-512 hash of the concatenation of the following byte strings,
    TEXT[!MUST]: in the order listed:

  SECTION: [Decryption Materials](#decryption-materials)
    TEXT[!MUST]: When the caching CMM receives a Decrypt Materials request,
    TEXT[!MUST]: it MUST calculate the cache entry identifier as
    TEXT[!MUST]: the SHA-512 hash of the concatenation of the following byte strings,
    TEXT[!MUST]: in the order listed:

SPECIFICATION: [Cryptographic Materials Manager Interface](aws-encryption-sdk-specification/framework/cmm-interface.md)
  SECTION: [Overview](#overview)
    TEXT[!MUST,implication]: The CMM interface describes the interface that all CMMs MUST implement.

  SECTION: [Supported CMMs](#supported-cmms)
    TEXT[!MAY,implication]: Note: A user MAY create their own custom CMM.

  SECTION: [Encryption Materials Request](#encryption-materials-request)
    TEXT[!MUST,implication]: The encryption materials request MUST include the following:
    TEXT[implication]: - [Encryption Context](structures.md#encryption-context)
    TEXT[!MAY,implication]:   - The encryption context provided MAY be empty.
    TEXT[implication]: - [Commitment Policy](./commitment-policy.md#supported-commitment-policy-enum)
    TEXT[!MAY,implication]: The encryption request MAY include the following:
    TEXT[implication]: - [Algorithm Suite Id](algorithm-suites.md#algorithm-suite-id)
    TEXT[implication]: - Required Encryption Context Keys - a set of strings.
    TEXT[implication]: - Max Plaintext Length
    TEXT[implication]:   - This value represents the maximum length of the plaintext to be encrypted
    TEXT[implication]:     using the returned materials.
    TEXT[!MUST,implication]:     The length of the plaintext to be encrypted MUST not be larger than this value.

  SECTION: [Decrypt Materials Request](#decrypt-materials-request)
    TEXT[!MUST,implication]: The decrypt materials request MUST include the following:
    TEXT[implication]: - [Algorithm Suite Id](algorithm-suites.md#algorithm-suite-id)
    TEXT[implication]: - [Commitment Policy](./commitment-policy.md#supported-commitment-policy-enum)
    TEXT[implication]: - [Encrypted Data Keys](structures.md#encrypted-data-keys)
    TEXT[implication]: - [Encryption Context](structures.md#encryption-context)
    TEXT[!MAY,implication]:   - The encryption context provided MAY be empty.
    TEXT[!MAY,implication]: The decrypt materials request MAY include the following:
    TEXT[implication]: - [Reproduced Encryption Context](structures.md#encryption-context)

  SECTION: [Behaviors](#behaviors)
    TEXT[!MUST,implication]: The CMM Interface MUST support the following behaviors:

  SECTION: [Get Encryption Materials](#get-encryption-materials)
    TEXT[!MUST,exception]: When the CMM gets an [encryption materials request](#encryption-materials-request),
    TEXT[!MUST,exception]: it MUST return [encryption materials](structures.md#encryption-materials) appropriate for the request.
    TEXT[!MUST,implementation,implication]: The encryption materials returned MUST include the following:
    TEXT[!SHOULD,implication]:   - If the encryption materials request contains an algorithm suite, the encryption materials returned SHOULD contain the same algorithm suite.
    TEXT[!MUST,exception]:   - Every encrypted data key in this list MUST correspond to the above plaintext data key.
    TEXT[!MAY,implication]:   - The CMM MAY modify the encryption context.
    TEXT[implication]: If the algorithm suite contains a [signing algorithm](algorithm-suites.md#signature-algorithm):
    TEXT[!MUST,implication]: - The CMM MUST include a [signing key](structures.md#signing-key).
    TEXT[!SHOULD,implication]: - The CMM SHOULD also add a key-value pair using the reserved key `aws-crypto-public-key` to the encryption context.
    TEXT[!SHOULD,implication]:   If it does, the mapped value SHOULD be the signature verification key corresponding to the signing key.
    TEXT[implication]: If the algorithm suite does not contain a [signing algorithm](algorithm-suites.md#signature-algorithm):
    TEXT[!SHOULD,implication]: - The CMM SHOULD NOT add a key-value pair using the reserved key `aws-crypto-public-key` to the encryption context.
    TEXT[!MUST,implementation,implication]: The CMM MUST ensure that the encryption materials returned are valid.
    TEXT[!MUST,implementation,implication]: - The encryption materials returned MUST follow the specification for [encryption-materials](structures.md#encryption-materials).
    TEXT[!MUST,implementation,implication]: - The value of the plaintext data key MUST be non-NULL.
    TEXT[!MUST,implementation,implication]: - The plaintext data key length MUST be equal to the [key derivation input length](algorithm-suites.md#key-derivation-input-length).
    TEXT[!MUST,implementation,implication]: - The encrypted data keys list MUST contain at least one encrypted data key.
    TEXT[!MUST,implementation,implication]: - If the algorithm suite contains a signing algorithm, the encryption materials returned MUST include the generated signing key.
    TEXT[!MUST,implementation,implication]: - For every key in [Required Encryption Context Keys](structures.md#required-encryption-context-keys)
    TEXT[!MUST,implementation,implication]:   there MUST be a matching key in the [Encryption Context](structures.md#encryption-context-1).
    TEXT[!MUST,implication]: - The [Required Encryption Context Keys](structures.md#required-encryption-context-keys) MUST be
    TEXT[!MUST,implication]:   a super set of the Required Encryption Context Keys in the [encryption materials request](#encryption-materials-request).

  SECTION: [Decrypt Materials](#decrypt-materials)
    TEXT[!MUST,exception]: When the CMM gets a [decrypt materials request](#decrypt-materials-request),
    TEXT[!MUST,exception]: it MUST return [decryption materials](structures.md#decryption-materials) appropriate for the request.
    TEXT[!SHOULD,implication]: If the requested algorithm suite does not include a signing algorithm but the encryption context includes the reserved `aws-crypto-public-key` key, the operation SHOULD fail.
    TEXT[!SHOULD,implication]: Likewise, if the requested algorithm suite includes a signing algorithm but the encryption context does not include the reserved `aws-crypto-public-key` key, the operation SHOULD fail.
    TEXT[!MUST,implementation,implication]: The CMM MUST validate the [Encryption Context](structures.md#encryption-context)
    TEXT[!MUST,implementation,implication]: by comparing it to the customer supplied [Reproduced Encryption Context](structures.md#encryption-context)
    TEXT[!MUST,implementation,implication]: in [decrypt materials request](#decrypt-materials-request).
    TEXT[!MUST,implementation,implication]: For every key that exists in both [Reproduced Encryption Context](structures.md#encryption-context)
    TEXT[!MUST,implementation,implication]: and [Encryption Context](structures.md#encryption-context),
    TEXT[!MUST,implementation,implication]: the values MUST be equal or the operation MUST fail.
    TEXT[!MAY]: The CMM MAY fail if it expects key-value pairs
    TEXT[!MAY]: that do not exist in [Reproduced Encryption Context](structures.md#encryption-context)
    TEXT[!MAY]: on the [decrypt materials request](#decrypt-materials-request).
    TEXT[!MUST,implementation,implication]: The decryption materials returned MUST include the following:
    TEXT[!MAY,exception]:   - The CMM MAY modify the encryption context.
    TEXT[!SHOULD,exception]:   - The operations made on the encryption context on the Get Encryption Materials call
    TEXT[!SHOULD,exception]:     SHOULD be inverted on the Decrypt Materials call.
    TEXT[!SHOULD,implementation,implication]:   - All key-value pairs that exist in [Reproduced Encryption Context](structures.md#encryption-context)
    TEXT[!SHOULD,implementation,implication]:     but do not exist in encryption context on the [decrypt materials request](#decrypt-materials-request)
    TEXT[!SHOULD,implementation,implication]:     SHOULD be appended to the decryption materials.
    TEXT[!SHOULD,implication]:   - If the decrypt materials request contains an algorithm suite,
    TEXT[!SHOULD,implication]:     the decryption materials returned SHOULD contain the same algorithm suite.
    TEXT[!MUST,implication]:   - This set MUST include all keys added to the decryption materials encryption context
    TEXT[!MUST,implication]:     that existed in the [decrypt materials request's](#decrypt-materials-request) reproduced encryption context
    TEXT[!MUST,implication]:     but did not exist in the [decrypt materials request's](#decrypt-materials-request) encryption context.
    TEXT[!MUST,implementation,implication]:   - All keys in this set MUST exist in the decryption materials encryption context.
    TEXT[!MUST,implication]: If the algorithm suite obtained from the decryption request contains a [signing algorithm](algorithm-suites.md#signature-algorithm),
    TEXT[!MUST,implication]: the decryption materials MUST include the [signature verification key](structures.md#verification-key).
    TEXT[!MUST,implementation,implication]: The CMM MUST ensure that the decryption materials returned are valid.
    TEXT[!MUST,implementation,implication]: - The decryption materials returned MUST follow the specification for [decryption-materials](structures.md#decryption-materials).
    TEXT[!MUST,implementation,implication]: - The value of the plaintext data key MUST be non-NULL.
    TEXT[!MUST,exception]: - The plaintext data key returned MUST correspond with at least one of the encrypted data keys.

SPECIFICATION: [Commitment Policy](aws-encryption-sdk-specification/framework/commitment-policy.md)
  SECTION: [Supported Format Commitment Policy ENUM](#supported-format-commitment-policy-enum)
    TEXT[!MUST,implication]: The Material Providers Library MUST provide
    TEXT[!MUST,implication]: a distinct commitment policy ENUM for each format.
    TEXT[implication]: | ESDK Commitment Policy ENUM     |
    TEXT[implication]: | ------------------------------- |
    TEXT[implication]: | FORBID_ENCRYPT_ALLOW_DECRYPT    |
    TEXT[implication]: | REQUIRE_ENCRYPT_ALLOW_DECRYPT   |
    TEXT[implication]: | REQUIRE_ENCRYPT_REQUIRE_DECRYPT |

  SECTION: [Supported Commitment Policy ENUM](#supported-commitment-policy-enum)
    TEXT[!MUST,implication]: The Material Providers Library also MUST provide
    TEXT[!MUST,implication]: a union ENUM for all distinct commitment policy ENUMs
    TEXT[!MUST,implication]: called the Commitment Policy ENUM.
    TEXT[!MAY,implication]: This means that different formats MAY have duplicate Format Commitment Policy ENUM.

  SECTION: [ESDK.FORBID_ENCRYPT_ALLOW_DECRYPT](#esdk-forbid-encrypt-allow-decrypt)
    TEXT[!MUST,implication]: - `ESDK.ALG_AES_256_GCM_IV12_TAG16_NO_KDF` MUST be the default algorithm suite
    TEXT[!MUST,implementation,test]: - [Get Encryption Materials](./cmm-interface.md#get-encryption-materials) MUST only support algorithm suites that have a [Key Commitment](./algorithm-suites.md#algorithm-suites-encryption-key-derivation-settings) value of False
    TEXT[!MUST,implication]: - [Decrypt Materials](./cmm-interface.md#decrypt-materials) MUST support all algorithm suites

  SECTION: [ESDK.REQUIRE_ENCRYPT_ALLOW_DECRYPT](#esdk-require-encrypt-allow-decrypt)
    TEXT[!MUST,implication]: - `05 78` MUST be the default algorithm suite
    TEXT[!MUST,implementation,implication]: - [Get Encryption Materials](./cmm-interface.md#get-encryption-materials) MUST only support algorithm suites that have a [Key Commitment](./algorithm-suites.md#algorithm-suites-encryption-key-derivation-settings) value of True
    TEXT[!MUST,implication]: - [Decrypt Materials](./cmm-interface.md#decrypt-materials) MUST support all algorithm suites

  SECTION: [ESDK.REQUIRE_ENCRYPT_REQUIRE_DECRYPT](#esdk-require-encrypt-require-decrypt)
    TEXT[!MUST,implication]: - `05 78` MUST be the default algorithm suite
    TEXT[!MUST,implementation,implication]: - [Get Encryption Materials](./cmm-interface.md#get-encryption-materials) MUST only support algorithm suites that have a [Key Commitment](./algorithm-suites.md#algorithm-suites-encryption-key-derivation-settings) value of True
    TEXT[!MUST,implementation,implication]: - [Decrypt Materials](./cmm-interface.md#decrypt-materials) MUST only support algorithm suites that have a [Key Commitment](./algorithm-suites.md#algorithm-suites-encryption-key-derivation-settings) value of True

  SECTION: [DBE.REQUIRE_ENCRYPT_REQUIRE_DECRYPT](#dbe-require-encrypt-require-decrypt)
    TEXT[!MUST,implication]: - `67 01` MUST be the default algorithm suite
    TEXT[!MUST,implementation,implication]: - [Get Encryption Materials](./cmm-interface.md#get-encryption-materials) MUST only support algorithm suites that have a [Key Commitment](./algorithm-suites.md#algorithm-suites-encryption-key-derivation-settings) value of True
    TEXT[!MUST,implementation,implication]: - [Decrypt Materials](./cmm-interface.md#decrypt-materials) MUST only support algorithm suites that have a [Key Commitment](./algorithm-suites.md#algorithm-suites-encryption-key-derivation-settings) value of True

SPECIFICATION: [Cryptographic Materials Cache Interface](aws-encryption-sdk-specification/framework/cryptographic-materials-cache.md)
  SECTION: [Overview](#overview)
    TEXT[implication]: Cryptographic materials cache (CMC) is used by the [caching cryptographic materials manager (CMM)](caching-cmm.md)
    TEXT[implication]: to store cryptographic materials for reuse.
    TEXT[!MUST,implication]: This document describes the interface that all CMCs MUST implement.

  SECTION: [Cache Entry](#cache-entry)
    TEXT[!MUST,implication]: A cache entry represents an entry in the cryptographic materials cache
    TEXT[!MUST,implication]: and MUST have the following information.
    TEXT[implication]: - [Materials](#materials)
    TEXT[implication]: - [Creation Time](#creation-time)
    TEXT[implication]: - [Expiry Time](#expiry-time)
    TEXT[implication]: - [Usage Metadata](#usage-metadata)

  SECTION: [Usage Metadata](#usage-metadata)
    TEXT[!SHOULD,exception]: Updating usage metadata SHOULD be atomic.

  SECTION: [Time-to-live (TTL)](#time-to-live-ttl)
    TEXT[!MUST,implication]: Each cache entry has a time-to-live (TTL)
    TEXT[!MUST,implication]: that represents a point in time at which the cache entry
    TEXT[!MUST,implication]: MUST be considered invalid.
    TEXT[!MUST,implementation]: After a cache entry's TTL has elapsed,
    TEXT[!MUST,implementation]: we say that the entry is _TTL-expired_,
    TEXT[!MUST,implementation]: and a CMC MUST NOT return the entry to any caller.

  SECTION: [Put Cache Entry](#put-cache-entry)
    TEXT[!MUST]: The CMC MUST create a new cache entry for the specified cache ID.
    TEXT[!MUST,implication]: This operation MUST NOT return the inserted cache entry.
    TEXT[!MUST,implication]: The cache entry MUST include all [usage metadata](#usage-metadata)
    TEXT[!MUST,implication]: since this information can not be updated after the put operation.
    TEXT[!MAY]: If used in a multi-threaded context,
    TEXT[!MAY]: the next [Get Cache Entry](#get-cache-entry) operation
    TEXT[!MAY]: MAY not return the entry just added.

  SECTION: [Get Cache Entry](#get-cache-entry)
    TEXT[!MUST,implementation]: The CMC MUST validate that the cache entry
    TEXT[!MUST,implementation]: has not exceeded it's stored [TTL](#time-to-live-ttl).
    TEXT[!MAY]: - Get Cache Entry MAY return a cache miss when the TTL has net yet been exceeded.
    TEXT[!MAY]: - Get Cache Entry MAY not return immediately if no cache entry exists for the specified cache ID,
    TEXT[!MAY]:   and a cache miss was recently returned for another thread.

  SECTION: [Background Processing](#background-processing)
    TEXT[!SHOULD]: An implementation SHOULD provide a way to avoid this, for example,
    TEXT[!SHOULD]: by spawning a background thread to occasionally remove expired entries.

SPECIFICATION: [Default Cryptographic Materials Manager](aws-encryption-sdk-specification/framework/default-cmm.md)
  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: On default CMM initialization,
    TEXT[!MUST,implication]: the caller MUST provide the following value:
    TEXT[implication]: - [Keyring](#keyring)

  SECTION: [Get Encryption Materials](#get-encryption-materials)
    TEXT[!SHOULD,implementation]: Adding the key `aws-crypto-public-key` SHOULD be done to a copy of the encryption context
    TEXT[!SHOULD,implementation]: so that the caller's encryption context is not mutated.
    TEXT[!MUST,implication]: If the encryption context included in the [encryption materials request](cmm-interface.md#encryption-materials-request)
    TEXT[!MUST,implication]: already contains the `aws-crypto-public-key` key,
    TEXT[!MUST,implication]: this operation MUST fail rather than overwrite the associated value.
    TEXT[!MUST,implication]: - If the [encryption materials request](cmm-interface.md#encryption-materials-request) does not contain an algorithm suite,
    TEXT[!MUST,implication]:   the operation MUST add the default algorithm suite for the [commitment policy](./commitment-policy.md#supported-commitment-policy-enum)
    TEXT[!MUST,implication]:   as the algorithm suite in the encryption materials returned.
    TEXT[!MUST,implication]: - If the [encryption materials request](cmm-interface.md#encryption-materials-request) does contain an algorithm suite,
    TEXT[!MUST,implication]:   the request MUST fail if the algorithm suite is not supported by the [commitment policy](./commitment-policy.md#supported-commitment-policy-enum) on the request.
    TEXT[!MUST,implication]: - If the [encryption materials request](cmm-interface.md#encryption-materials-request) does contain an algorithm suite,
    TEXT[!MUST,implication]:   the encryption materials returned MUST contain the same algorithm suite.
    TEXT[!MUST,implication]: If the algorithm suite contains a [signing algorithm](algorithm-suites.md#signature-algorithm),
    TEXT[!MUST,implication]: the default CMM MUST Generate a [signing key](structures.md#signing-key).
    TEXT[!MUST,implication]: If the algorithm suite contains a [signing algorithm](algorithm-suites.md#signature-algorithm),
    TEXT[!MUST,implication]: the default CMM MUST Add the key-value pair of
    TEXT[!MUST,implication]: key `aws-crypto-public-key`,
    TEXT[!MUST,implication]: value `base64-encoded public verification key`
    TEXT[!MUST,implication]: to the [encryption context](structures.md#encryption-context).
    TEXT[!MUST,implication]: On each call to Get Encryption Materials,
    TEXT[!MUST,implication]: the default CMM MUST make a call to its [keyring's](#keyring)
    TEXT[!MUST,implication]: [On Encrypt](keyring-interface.md#onencrypt) operation.
    TEXT[!MUST,implication]: The default CMM MUST obtain the Plaintext Data Key from the
    TEXT[!MUST,implication]: On Encrypt Response and include it in the
    TEXT[!MUST,implication]: [encryption materials](structures.md#encryption-materials) returned.
    TEXT[!MUST,implication]: The default CMM MUST obtain the
    TEXT[!MUST,implication]: [Encrypted Data Keys](structures.md#encrypted-data-keys)
    TEXT[!MUST,implication]: from the On Encrypt Response and include it
    TEXT[!MUST,implication]: in the [encryption materials](structures.md#encryption-materials) returned.

  SECTION: [Decrypt Materials](#decrypt-materials)
    TEXT[!MUST,implication]: If the algorithm suite contains a [signing algorithm](algorithm-suites.md#signature-algorithm),
    TEXT[!MUST,implication]: the default CMM MUST extract the verification key
    TEXT[!MUST,implication]: from the encryption context under the reserved `aws-crypto-public-key` key.
    TEXT[!MUST,implication]: If this key is not present in the encryption context, the operation MUST fail
    TEXT[!MUST,implication]: without returning any decryption materials.
    TEXT[!MUST,implication]: If the algorithm suite does not contain a [signing algorithm](algorithm-suites.md#signature-algorithm),
    TEXT[!MUST,implication]: but the encryption context includes the reserved `aws-crypto-public-key` key,
    TEXT[!MUST,implication]: the operation MUST fail without returning any decryption materials.
    TEXT[!MUST,implication]: The request MUST fail if the algorithm suite on the request is not supported by the [commitment policy](./commitment-policy.md#supported-commitment-policy-enum) on the request.
    TEXT[!MUST,implication]: On each call to Decrypt Materials,
    TEXT[!MUST,implication]: the default CMM MUST make a call to its [keyring's](#keyring)
    TEXT[!MUST,implication]: [On Decrypt](keyring-interface.md#ondecrypt) operation.
    TEXT[!MUST,implication]: The default CMM MUST obtain the Plaintext Data Key from
    TEXT[!MUST,implication]: the On Decrypt response and include it in the decrypt
    TEXT[!MUST,implication]: materials returned.

  SECTION: [Legacy Behavior : Master Key Providers](#legacy-behavior-master-key-providers)
    TEXT[!MUST,exception]: For implementations that support [master key providers](master-key-provider-interface.md),
    TEXT[!MUST,exception]: the default CMM MUST support generating, encrypting, and decrypting data keys
    TEXT[!MUST,exception]: using master key providers.

  SECTION: [Legacy](#legacy)
    TEXT[!SHOULD,implication]: Master key providers SHOULD NOT be included in any additional implementations.

  SECTION: [Initialization](#initialization-1)
    TEXT[implication]: In place of requiring the caller to provide a [keyring](keyring-interface.md)
    TEXT[implication]: on initialization:
    TEXT[!MUST,implication]: On default CMM initialization,
    TEXT[!MUST,implication]: the caller MUST provide the following value:
    TEXT[implication]: - [Master Key Provider](master-key-provider-interface.md)

  SECTION: [Get Encryption Materials (master key provider)](#get-encryption-materials-master-key-provider)
    TEXT[implication]: In place of calling its keyring's [On Encrypt](keyring-interface.md#onencrypt) operation:
    TEXT[!MUST,implication]: The default CMM MUST call its master key provider's
    TEXT[!MUST,implication]: [Get Master Keys for Encryption](master-key-provider-interface.md#get-master-keys-for-encryption) operation
    TEXT[!MUST,implication]: to obtain a list of master keys to use.
    TEXT[!MUST,implication]: If the master key provider does not identify which master key MUST generate the data key,
    TEXT[!MUST,implication]: the default CMM MUST use the first master key in the list for that purpose.
    TEXT[!MUST,implication]: The default CMM MUST generate the data key using this master key's
    TEXT[!MUST,implication]: [Generate Data Key](master-key-interface.md#generate-data-key) operation.
    TEXT[!MUST,implication]: For each remaining master key,
    TEXT[!MUST,implication]: the default CMM MUST call the master key's
    TEXT[!MUST,implication]: [Encrypt Data Key](master-key-interface.md#encrypt-data-key) operation
    TEXT[!MUST,implication]: with the plaintext data key.

  SECTION: [Decrypt Materials (master key provider)](#decrypt-materials-master-key-provider)
    TEXT[implication]: In place of calling its keyring's [On Decrypt](keyring-interface.md#ondecrypt) operation:
    TEXT[!MUST,implication]: The default CMM MUST call its master key provider's
    TEXT[!MUST,implication]: [Decrypt Data Key](master-key-provider-interface.md#decrypt-data-key) operation.

SPECIFICATION: [Key Agreement Schemas](aws-encryption-sdk-specification/framework/key-agreement-schemas.md)
  SECTION: [Overview](#overview)
    TEXT[!MAY]: In the ECDH key agreement protocol, there are scenarios where both parties
    TEXT[!MAY]: MAY establish key agreement with more than just their static keys.
    TEXT[!MAY]: Parties MAY use ephemeral keys in addition to static keys.

  SECTION: [KmsPublicKeyDiscovery](#kmspublickeydiscovery)
    TEXT[!MUST,implementation]: - MUST provide the recipient's AWS KMS key identifier
    TEXT[!MAY]: - MAY provide the recipient's public key
    TEXT[!MUST]:   - Public key MUST be DER-encoded [X.509 SubjectPublicKeyInfo](https://datatracker.ietf.org/doc/html/rfc5280#section-4.1)
    TEXT[!MUST]: On initialization, if the keyring is not configured with
    TEXT[!MUST]: a recipient public key,
    TEXT[!MUST,implementation]: the keyring MUST call
    TEXT[!MUST,implementation]: `kms:GetPublicKey` on the recipient's configured KMS key ID.
    TEXT[!MUST]: If the keyring fails to retrieve the public key, the keyring MUST fail.
    TEXT[!MUST]: If the keyring succeeds retrieving the configured KMS public key,
    TEXT[!MUST]: the `kms:GetPublicKey` response MUST indicate that
    TEXT[!MUST]: the `KeyUsage` on the KMS key ID is for `KeyAgreement` and
    TEXT[!MUST]: that the `Curve` matches the configured curve specification.
    TEXT[!MUST]: If used on encrypt, the keyring MUST fail.
    TEXT[!MUST,implementation]: - MUST verify that the configured recipient's public key
    TEXT[!MUST,implementation]:   matches the public key stored on the message ciphertext.

  SECTION: [KmsPrivateKeyToStaticPublicKey](#kmsprivatekeytostaticpublickey)
    TEXT[!MUST]: - MUST provide the sender's AWS KMS key identifier
    TEXT[!MUST]: - MUST provide the recipient's public key
    TEXT[!MUST]:   - Public key MUST be DER-encoded [X.509 SubjectPublicKeyInfo](https://datatracker.ietf.org/doc/html/rfc5280#section-4.1)
    TEXT[!MUST]:   - If the public key is not DER-encoded the keyring MUST fail.
    TEXT[!MAY,implementation]: - MAY provide the sender's public key
    TEXT[implementation]:   - Public key MUST be DER-encoded [X.509 SubjectPublicKeyInfo](https://datatracker.ietf.org/doc/html/rfc5280#section-4.1)
    TEXT[!MUST,implementation]: On initialization, if the keyring is not configured with
    TEXT[!MUST,implementation]: a sender public key, the keyring MUST call
    TEXT[!MUST,implementation]: `kms:GetPublicKey` on the sender's configured KMS key ID.
    TEXT[!MUST]: If the keyring fails to retrieve the public key, the keyring MUST fail.
    TEXT[!MUST]: If the keyring succeeds retrieving the sender public key, the `kms:GetPublicKey`
    TEXT[!MUST]: response MUST indicate that the `KeyUsage` on the KMS key ID
    TEXT[!MUST]: is for `KeyAgreement` and that the `Curve` matches the configured
    TEXT[!MUST]: curve specification.
    TEXT[!MUST]: - MUST call KMS `DeriveSharedSecret` with the
    TEXT[!MUST]:   sender's KMS key identifier and the recipient's public key.
    TEXT[!MUST,implementation]: - MUST verify that both the configured sender's and recipient's
    TEXT[!MUST,implementation]:   public keys match the public keys stored on the message ciphertext.
    TEXT[!MUST]: - If the public keys match the keyring MUST call KMS `DeriveSharedSecret`.

  SECTION: [Raw ECDH Key Agreement Schemas](#raw-ecdh-key-agreement-schemas)
    TEXT[!MAY]: When configured with a Raw ECDH Key Agreement Schema,
    TEXT[!MAY]: the sender party MAY be using an ephemeral key or a static key,
    TEXT[!MAY]: and the recipient is always static.

  SECTION: [EphemeralPrivateKeyToStaticPublicKey](#ephemeralprivatekeytostaticpublickey)
    TEXT[!MUST,implementation]: - MUST provide the recipient's public key
    TEXT[!MUST]:   - Public key MUST be DER-encoded [X.509 SubjectPublicKeyInfo](https://datatracker.ietf.org/doc/html/rfc5280#section-4.1)
    TEXT[!MUST]:   - If the public key is not DER-encoded the keyring MUST fail.
    TEXT[!MUST]: This schema can only encrypt data and MUST NOT be used
    TEXT[!MUST]: for decryption.
    TEXT[!MUST]: If used on decrypt, the keyring MUST fail.
    TEXT[!MAY]: The recipient's public key MAY belong to a KMS key.
    TEXT[!MUST]: - MUST generate a new ECC key pair along the same EC curve as
    TEXT[!MUST]:   the recipient's public key.
    TEXT[!MUST]: If the keyring is not able to generate a
    TEXT[!MUST]:   new ECC key pair, the keyring MUST fail.
    TEXT[!MUST,implementation]: On decrypt, the keyring MUST fail.

  SECTION: [PublicKeyDiscovery](#publickeydiscovery)
    TEXT[!MUST,implementation]: - MUST provide the recipient's static private key
    TEXT[!MUST]:   - Private key MUST be PEM encoded [PKCS #8 PrivateKeyInfo structures](https://tools.ietf.org/html/rfc5958#section-2)
    TEXT[!MUST]:   - If the private key is not PEM-encoded the keyring MUST fail.
    TEXT[!MUST]: On encrypt, the keyring MUST fail.
    TEXT[!MUST,implementation]: - MUST verify that the recipient public key stored on
    TEXT[!MUST,implementation]:   the message ciphertext matches the configured recipient's
    TEXT[!MUST,implementation]:   public key.

  SECTION: [RawPrivateKeyToStaticPublicKey](#rawprivatekeytostaticpublickey)
    TEXT[!MUST,implementation]: - MUST provide the sender's static private key
    TEXT[!MUST]:   - Private key MUST be PEM encoded [PKCS #8 PrivateKeyInfo structures](https://tools.ietf.org/html/rfc5958#section-2)
    TEXT[!MUST]:   - If the private key is not PEM-encoded the keyring MUST fail.
    TEXT[!MUST,implementation]: - MUST provide the recipient's public key
    TEXT[!MUST]:   - Public key MUST be DER-encoded [X.509 SubjectPublicKeyInfo](https://datatracker.ietf.org/doc/html/rfc5280#section-4.1)
    TEXT[!MUST]:   - If the public key is not DER-encoded the keyring MUST fail.
    TEXT[!MUST]: - MUST generate the shared secret with the sender's
    TEXT[!MUST]:   private key and the recipient's public key
    TEXT[!MUST,implementation]: - MUST verify that both the configured sender's and recipient's
    TEXT[!MUST,implementation]:   public keys match the public keys stored on the message ciphertext.

  SECTION: [Key Derivation](#key-derivation)
    TEXT[!MUST]: The keyring MUST attempt to derive a shared wrapping key from the shared secret.
    TEXT[!MUST,implementation]: Before deriving a shared wrapping key,
    TEXT[!MUST,implementation]: the keyring MUST generate a 32 byte random salt value.
    TEXT[!MUST,implementation]: If the keyring fails to generate a random value, the operation MUST fail.
    TEXT[!MUST,implication]: - MUST use the derived shared secret, Z
    TEXT[!MUST,implication]:   - L: MUST be a length of 512 bits
    TEXT[!MUST,implication]:   - salt: MUST be a random 32 byte string
    TEXT[!MUST]:   - IV: MUST be null
    TEXT[!MUST,implication]:     - MUST be the UTF8 encoded string "ecdh-key-derivation"
    TEXT[!MUST,implication]:     - MUST be the UTF8 encoded string of the configured curve specification
    TEXT[!MUST,implication]:     - MUST be the UTF8 encoded string of the configured Key Derivation Method used
    TEXT[!MUST,implication]:     - MUST be A concatenation of the static public keys used by the parties
    TEXT[!MUST,implication]:       in the format of sender followed by receiver
    TEXT[!MUST,implication]:     - MUST be The canonicalized encryption context found in the [encryption materials](structures.md#encryption-materials)
    TEXT[!MUST,implication]:     - MUST use a null byte concatenating all the fixed info fields.
    TEXT[!MUST,implication]:     - MUST use the keyring version found in the key provider information.
    TEXT[!MUST,implication]: The FixedInfo field MUST be serialized in the following order:

  SECTION: [Key Commitment](#key-commitment)
    TEXT[!MUST]: This equality check
    TEXT[!MUST]: MUST be a constant time operation.

SPECIFICATION: [Keyring Interface](aws-encryption-sdk-specification/framework/keyring-interface.md)
  SECTION: [Overview](#overview)
    TEXT[!MUST]: The keyring interface specified in this document describes the interface all keyrings MUST implement.

  SECTION: [key namespace](#key-namespace)
    TEXT[!MUST]: The key namespace MUST be a string value.

  SECTION: [key name](#key-name)
    TEXT[!MUST]: The key name MUST be a string value.

  SECTION: [key provider ID](#key-provider-id)
    TEXT[!MUST]: The key provider ID MUST be a binary value
    TEXT[!MUST]: and SHOULD be equal to a UTF-8 encoding of the key namespace.
    TEXT[!MUST]: This value MUST NOT be or start with "aws-kms"
    TEXT[!MUST]: unless this encrypted data key was produced by one of the [AWS KMS Keyrings](./aws-kms/).

  SECTION: [key provider info](#key-provider-info)
    TEXT[!MUST]: The key provider info MUST be a binary value
    TEXT[!MUST]: and SHOULD be equal to a UTF-8 encoding of the key name.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: This interface MUST take [encryption materials](structures.md#encryption-materials) as input.
    TEXT[!MUST,implication]: It MUST modify it with at least one of the following behaviors:
    TEXT[implication]: - [Generate data key](#generate-data-key)
    TEXT[implication]: - [Encrypt data key](#encrypt-data-key)
    TEXT[!MUST,implication]: If this keyring attempted any of the above behaviors, and successfully completed those behaviors,
    TEXT[!MUST,implication]: it MUST output the modified [encryption materials](structures.md#encryption-materials).
    TEXT[!MUST]: If the keyring did not attempt any of the above behaviors, it MUST fail
    TEXT[!MUST]: and it MUST NOT modify the [encryption materials](structures.md#encryption-materials).
    TEXT[!SHOULD]: The keyring SHOULD NOT attempt to store the encryption context
    TEXT[!SHOULD]: in the [encrypted data key's](structures.md#encrypted-data-key) properties.

  SECTION: [Generate Data Key](#generate-data-key)
    TEXT[!MUST,implication]: If the [encryption materials](structures.md#encryption-materials) do not contain a plaintext data key,
    TEXT[!MUST,implication]: OnEncrypt MUST generate a data key.
    TEXT[!MUST,implication]: If the encryption materials contain a plaintext data key, OnEncrypt MUST NOT generate a data key.
    TEXT[!MUST,implication]: Generate Data Key MUST modify the following fields in the [encryption materials](structures.md#encryption-materials):
    TEXT[implication]: - [plaintext data key](structures.md#plaintext-data-key)
    TEXT[implication]: To perform this behavior, the keyring generates a [plaintext data key](structures.md#plaintext-data-key)
    TEXT[implication]: and sets the resulting plaintext data key on the [encryption materials](structures.md#encryption-materials).
    TEXT[!MUST,implication]: The length of the output plaintext data key MUST be equal to the KDF input length of the [algorithm suite](algorithm-suites.md)
    TEXT[!MUST,implication]: specified in the [encryption materials](structures.md#encryption-materials).
    TEXT[!MUST,implication]: The value of the plaintext data key MUST consist of cryptographically secure (pseudo-)random bits.
    TEXT[!MAY,implication]: Note: If the keyring successfully performs this behavior, this means that the keyring MAY then
    TEXT[!MAY,implication]: perform the [Encrypt Data Key](#encrypt-data-key) behavior.

  SECTION: [Encrypt Data Key](#encrypt-data-key)
    TEXT[!MUST,implication]: If the [encryption materials](structures.md#encryption-materials) contain a plaintext data key,
    TEXT[!MUST,implication]: OnEncrypt MUST encrypt a data key.
    TEXT[!MUST,implication]: If the encryption materials do not contain a plaintext data key, OnEncrypt MUST NOT encrypt a data key.
    TEXT[!MUST,implication]: Encrypt Data Key MUST modify the following fields in the [encryption materials](structures.md#encryption-materials):
    TEXT[implication]: - [encrypted data keys](structures.md#encrypted-data-keys)
    TEXT[!MUST]: The [encrypted data keys](structures.md#encrypted-data-key) produced by this keyring MUST
    TEXT[!MUST]: have [ciphertexts](structures.md#ciphertext) that can be decrypted to the plaintext data key in the
    TEXT[!MUST]: [encryption materials](structures.md#encryption-materials).

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST,implication]: This interface MUST take [decryption materials](structures.md#decryption-materials) and
    TEXT[!MUST,implication]: a list of [encrypted data keys](structures.md#encrypted-data-key) as input.
    TEXT[!MUST,implication]: It MUST modify it with the following behavior:
    TEXT[implication]: - [Decrypt data key](#decrypt-data-key)
    TEXT[!MUST,implication]: If the decryption materials already contain a plaintext data key,
    TEXT[!MUST,implication]: the keyring MUST fail
    TEXT[!MUST,implication]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST,implication]: If this keyring attempted the above behavior, and succeeded, it MUST output the modified [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST]: If the keyring did not attempt the above behavior,
    TEXT[!MUST]: the keyring MUST fail
    TEXT[!MUST]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).

  SECTION: [Decrypt Data Key](#decrypt-data-key)
    TEXT[!MUST,implication]: If the encryption materials do contain a plaintext data key, OnDecrypt MUST NOT decrypt a data key.
    TEXT[!MUST,implication]: If the [decryption materials](structures.md#decryption-materials) do not include a plaintext data key,
    TEXT[!MUST,implication]: OnDecrypt MUST decrypt a data key.
    TEXT[!MUST,implication]: The decrypt data key MUST modify the following fields in the [decryption materials](structures.md#decryption-materials):
    TEXT[implication]: - [Plaintext data key](structures.md#plaintext-data-key-1)
    TEXT[implication]: To perform this behavior, the keyring attempts to retrieve a plaintext data key from the input list
    TEXT[implication]: of [encrypted data keys](structures.md#encrypted-data-key).
    TEXT[!SHOULD,implication]: If the keyring is able to successfully get at least one plaintext data key from any [encrypted data key](structures.md#encrypted-data-key)
    TEXT[!SHOULD,implication]: and the [decryption materials](structures.md#decryption-materials) still do not include a plaintext data key,
    TEXT[!SHOULD,implication]: it SHOULD set one resulting plaintext data key on the [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST]: If the keyring is unable to get any plaintext data key using the input [encrypted data keys](structures.md#encrypted-data-key),
    TEXT[!MUST]: the keyring MUST NOT not update the [decryption materials](structures.md#decryption-materials) and MUST return failure.

  SECTION: [Security Considerations](#security-considerations)
    TEXT[!SHOULD]: Keyring implementations SHOULD provide integrity guarantees for the [encrypted data keys](structures.md#encrypted-data-key)
    TEXT[!SHOULD]: they return on [OnEncrypt](#onencrypt) such that tampered versions of those encrypted data keys,
    TEXT[!SHOULD]: if input into [OnDecrypt](#ondecrypt), are overwhelmingly likely to cause a decryption failure
    TEXT[!SHOULD]: (i.e.
    TEXT[!SHOULD]: Such integrity guarantees SHOULD include the integrity of the [encryption context](structures.md#encryption-context)
    TEXT[!SHOULD]: such that, if the encryption context used as input to OnEncrypt to produce an encrypted data key is
    TEXT[!SHOULD]: different than the encryption context input to OnDecrypt to decrypt that encrypted data key,
    TEXT[!SHOULD]: the decryption is overwhelmingly likely to fail.
    TEXT[!SHOULD]: Users SHOULD use a keyring that protects wrapping keys and performs cryptographic operations within a secure boundary.
    TEXT[!MAY]: The [raw AES keyring](raw-aes-keyring.md) and [raw RSA keyring](raw-rsa-keyring.md) MAY be used,
    TEXT[!MAY]: however users should refer to their specification for notes on their respective security considerations.

  SECTION: [Why should I use Keyrings instead of Master Key Providers and Master Keys?](#why-should-i-use-keyrings-instead-of-master-key-providers-and-master-keys)
    TEXT[!SHOULD]: Due to this simplified architecture, master keys and master key providers are going to be deprecated in the future,
    TEXT[!SHOULD]: and new implementations SHOULD use keyrings.

SPECIFICATION: [Local Cryptographic Materials Cache](aws-encryption-sdk-specification/framework/local-cryptographic-materials-cache.md)
  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: On initialization of the local CMC,
    TEXT[!MUST,implication]: the caller MUST provide the following:
    TEXT[implication]: - [Entry Capacity](#entry-capacity)
    TEXT[!MUST,implication]: The local CMC MUST also define the following:
    TEXT[implication]: - [Entry Pruning Tail Size](#entry-pruning-tail-size)

  SECTION: [Entry Capacity](#entry-capacity)
    TEXT[!MUST,implementation]: The local CMC MUST NOT store more entries than this value,
    TEXT[!MUST,implementation]: except temporarily while performing a Put Cache Entry operation.
    TEXT[!MUST,implication]: The local CMC MUST accept entry capacity values between zero
    TEXT[!MUST,implication]: and an implementation-defined maximum, inclusive.

  SECTION: [Entry Pruning Tail Size](#entry-pruning-tail-size)
    TEXT[!MUST,implication]: The _entry pruning tail size_
    TEXT[!MUST,implication]: is the number of least recently used entries that the local CMC
    TEXT[!MUST,implication]: MUST check during [pruning](#pruning)
    TEXT[!MUST,implication]: for TTL-expired entries to evict.

  SECTION: [Put Cache Entry](#put-cache-entry)
    TEXT[!MAY,exception]: While performing a Put Cache Entry operation,
    TEXT[!MAY,exception]: the local CMC MAY store more entries than the entry capacity.
    TEXT[!MUST,implementation]: However, before returning, the local CMC MUST evict least-recently used entries
    TEXT[!MUST,implementation]: until the number of stored entries does not exceed the entry capacity.

  SECTION: [Get Cache Entry](#get-cache-entry)
    TEXT[!MUST,implementation]: When performing a Get Cache Entry operation,
    TEXT[!MUST,implementation]: the local CMC MUST [prune TTL-expired cache entries](#pruning).
    TEXT[!MUST,implementation]: The local CMC MUST NOT return any TTL-expired entry.

  SECTION: [Pruning](#pruning)
    TEXT[!MUST,implementation]: To prune TTL-expired cache entries,
    TEXT[!MUST,implementation]: the local CMC MUST evict all TTL-expired entries
    TEXT[!MUST,implementation]: among the `N` least recently used entries,
    TEXT[!MUST,implementation]: where `N` is the [Entry Pruning Tail Size](#entry-pruning-tail-size).
    TEXT[!SHOULD,exception]: The local CMC SHOULD also periodically evict all TTL-expired entries
    TEXT[!SHOULD,exception]: among the `N` least recently used entries.

SPECIFICATION: [Master Key Interface](aws-encryption-sdk-specification/framework/master-key-interface.md)
  SECTION: [Legacy](#legacy)
    TEXT[exception]: This is a legacy specification.
    TEXT[!SHOULD,exception]: Master keys SHOULD NOT be included in any additional implementations.
    TEXT[!MUST,exception]: Any new implementations MUST include [Keyrings](./keyring-interface.md) instead.

  SECTION: [Consistency](#consistency)
    TEXT[!MUST,exception]: This specification defines the common behavior between the two implementations
    TEXT[!MUST,exception]: that determine the REQUIRED functionality.
    TEXT[exception]: Other specifics of behavior and API vary between the two implementations.

  SECTION: [Get Master Key](#get-master-key)
    TEXT[exception]: Inputs and outputs are the same as for [master key providers](./master-key-provider-interface.md).
    TEXT[!MUST,exception]: A master key MUST supply itself and MUST NOT supply any other master keys.

  SECTION: [Get Master Keys For Encryption](#get-master-keys-for-encryption)
    TEXT[exception]: Inputs and outputs are the same as for [master key providers](./master-key-provider-interface.md).
    TEXT[!MUST,exception]: A master key MUST supply itself and MUST NOT supply any other master keys.

  SECTION: [Decrypt Data Key](#decrypt-data-key)
    TEXT[exception]: Inputs and outputs are the same as for [master key providers](./master-key-provider-interface.md).
    TEXT[!SHOULD,exception]: A master key SHOULD attempt to decrypt a data key using itself.
    TEXT[!MUST,exception]: A master key MUST not attempt to use any other master keys.

  SECTION: [Generate Data Key](#generate-data-key)
    TEXT[exception]: This interface is used to generate and encrypt a data key.
    TEXT[!MUST,exception]: The master key MUST generate a data key and MUST then encrypt that data key.
    TEXT[!MUST,exception]: Inputs to this interface MUST include
    TEXT[!MUST,exception]: the algorithm suite
    TEXT[!MUST,exception]: and the encryption context.
    TEXT[!MUST,exception]: The output of this interface MUST include
    TEXT[!MUST,exception]: the plaintext data key,
    TEXT[!MUST,exception]: the data key encrypted under the master key,
    TEXT[!MUST,exception]: and information that can identify which master key
    TEXT[!MUST,exception]: was used to generate and encrypt the data key.
    TEXT[!MUST,exception]: If the master key cannot generate or encrypt the data key,
    TEXT[!MUST,exception]: the call MUST result in an error.

  SECTION: [Encrypt Data Key](#encrypt-data-key)
    TEXT[exception]: This interface is used to encrypt a data key.
    TEXT[!MUST,exception]: The master key MUST encrypt the data key.
    TEXT[!MUST,exception]: Inputs to this interface MUST include
    TEXT[!MUST,exception]: the algorithm suite,
    TEXT[!MUST,exception]: the encryption context,
    TEXT[!MUST,exception]: the encrypted data key,
    TEXT[!MUST,exception]: and information that can identify which master key
    TEXT[!MUST,exception]: was used to encrypt the data key.
    TEXT[!MUST,exception]: The output of this interface MUST include
    TEXT[!MUST,exception]: a value that this master key can use to obtain
    TEXT[!MUST,exception]: the plaintext data key.
    TEXT[exception]: Most commonly,
    TEXT[exception]: this will be the result of an encryption operation.
    TEXT[!MUST,exception]: If the master key cannot encrypt the data key,
    TEXT[!MUST,exception]: the call MUST result in an error.

SPECIFICATION: [Master Key Provider Interface](aws-encryption-sdk-specification/framework/master-key-provider-interface.md)
  SECTION: [Legacy](#legacy)
    TEXT[exception]: This is a legacy specification.
    TEXT[!SHOULD,exception]: Master key providers SHOULD NOT be included in any additional implementations.
    TEXT[!MUST,exception]: Any new implementations MUST include [Keyrings](./keyring-interface.md) instead.

  SECTION: [Consistency](#consistency)
    TEXT[!MUST,exception]: This specification defines the common behavior between the two implementations
    TEXT[!MUST,exception]: that determine the REQUIRED functionality.

  SECTION: [Terms](#terms)
    TEXT[exception]: - Provider ID: A value that identifies a master key provider.
    TEXT[exception]:   This concept is equivalent to "key namespace" for Keyrings.
    TEXT[exception]: - Key ID: A value that identifies a master key
    TEXT[exception]:   within the context of a master key provider.
    TEXT[exception]:   This concept is equivalent to "key name" for Keyrings.
    TEXT[exception]: - Provider Info: The value that is written to a serialized encrypted data key
    TEXT[exception]:   that identifies a master key within the context of a master key provider.
    TEXT[!MUST,exception]:   This MUST always be equal to the master key's key ID
    TEXT[!MUST,exception]:   with the exception of the raw AES master key.
    TEXT[exception]:   For a detailed description of this exception,
    TEXT[exception]:   see the [Raw AES Keyring specification](./raw-aes-keyring.md).

  SECTION: [Get Master Key](#get-master-key)
    TEXT[exception]: This interface provides a way for a master key provider to return master keys.
    TEXT[!MUST,exception]: An implementation MUST support master key selection by key ID.
    TEXT[!MAY,exception]: An implementation MAY support master key selection by provider info or provider ID.
    TEXT[!MUST,exception]: The output of this interface MUST be a master key.
    TEXT[!MUST,exception]: If the master key provider cannot locate an appropriate master key,
    TEXT[!MUST,exception]: the call MUST result in an error.

  SECTION: [Get Master Keys For Encryption](#get-master-keys-for-encryption)
    TEXT[!SHOULD,exception]: This interface provides a way for a master key provider to indicate which master keys
    TEXT[!SHOULD,exception]: SHOULD be used for encryption.
    TEXT[!MUST,exception]: Inputs to this interface MUST include the encryption context.
    TEXT[!MAY,exception]: Inputs MAY include the plaintext body and plaintext size.
    TEXT[!MUST,exception]: The output of this interface MUST include a list of all master keys that
    TEXT[!MUST,exception]: SHOULD be used for encryption.
    TEXT[!MUST,exception]: The output of this interface MUST indicate which one of those master keys
    TEXT[!MUST,exception]: MUST be used to generate the data key.

  SECTION: [Decrypt Data Key](#decrypt-data-key)
    TEXT[exception]: This interface is used to decrypt a data key.
    TEXT[!SHOULD,exception]: The master key provider SHOULD attempt to decrypt the data key
    TEXT[!SHOULD,exception]: by passing the request to any master keys that it has access to
    TEXT[!SHOULD,exception]: until it has either exhausted available master keys
    TEXT[!SHOULD,exception]: or obtained a plaintext data key.
    TEXT[!MUST,exception]: Inputs to this interface MUST include
    TEXT[!MUST,exception]: the algorithm suite,
    TEXT[!MUST,exception]: the encryption context,
    TEXT[!MUST,exception]: and a list of encrypted data keys.
    TEXT[!MUST,exception]: The output of this interface MUST include
    TEXT[!MUST,exception]: the decrypted data key
    TEXT[!MUST,exception]: and information that can identify which master key
    TEXT[!MUST,exception]: decrypted the data key.
    TEXT[!MUST,exception]: If the master key provider cannot decrypt the data key,
    TEXT[!MUST,exception]: the call MUST result in an error.

SPECIFICATION: [Multi-Keyring](aws-encryption-sdk-specification/framework/multi-keyring.md)
  SECTION: [Inputs](#inputs)
    TEXT[!MUST,implication]: On keyring initialization, a keyring MUST define at least one of the following:

  SECTION: [Generator Keyring](#generator-keyring)
    TEXT[!MUST,implication]: This keyring MUST implement the [Generate Data Key](keyring-interface.md#generate-data-key) behavior
    TEXT[!MUST,implication]: during [OnEncrypt](keyring-interface.md#onencrypt).
    TEXT[!MUST,implication]: This means that this keyring MUST return [encryption materials](structures.md#encryption-materials) containing
    TEXT[!MUST,implication]: a plaintext data key on [OnEncrypt](keyring-interface.md#onencrypt).
    TEXT[!MUST,implication]: If the list of [child keyrings](#child-keyrings) is empty,
    TEXT[!MUST,implication]: a [generator keyring](#generator-keyring) MUST be defined for the keyring.

  SECTION: [Child Keyrings](#child-keyrings)
    TEXT[!MUST,implication]: If this keyring does not have a [generator keyring](#generator-keyring), this list MUST NOT be empty.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implementation,test]: If this keyring has a generator keyring,
    TEXT[!MUST,implementation,test]: this keyring MUST first generate a plaintext data key using the generator keyring:
    TEXT[!MUST,implication]: - If the input encryption materials already include a plaintext data key,
    TEXT[!MUST,implication]:   OnEncrypt MUST fail.
    TEXT[!MUST,implementation,test]: - This keyring MUST first call the generator keyring's OnEncrypt
    TEXT[!MUST,implementation,test]:   using the input encryption materials as input.
    TEXT[!MUST,implementation,test]: - If the generator keyring fails OnEncrypt,
    TEXT[!MUST,implementation,test]:   this OnEncrypt MUST also fail.
    TEXT[!MUST,implementation,test]: - If the generator keyring returns encryption materials missing a plaintext data key,
    TEXT[!MUST,implementation,test]:   OnEncrypt MUST fail.
    TEXT[!MUST,implication]: If this keyring does not have a [generator keyring](#generator-keyring),
    TEXT[!MUST,implication]: and the input [encryption materials](structures.md#encryption-materials)
    TEXT[!MUST,implication]: does not include a plaintext data key, OnEncrypt MUST fail.
    TEXT[!MUST,implementation,test]: Next, for each [keyring](keyring-interface.md) in this keyring's list of [child keyrings](#child-keyrings),
    TEXT[!MUST,implementation,test]: the keyring MUST call [OnEncrypt](keyring-interface.md#onencrypt).
    TEXT[!MUST,implementation,test]: If the child keyring's [OnEncrypt](keyring-interface.md#onencrypt) fails, this OnEncrypt MUST also fail.
    TEXT[!MUST,implementation,test]: If all previous [OnEncrypt](keyring-interface.md#onencrypt) calls succeeded, this keyring MUST return
    TEXT[!MUST,implementation,test]: the [encryption materials](structures.md#encryption-materials) returned by the last OnEncrypt call.

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST,implication]: If the decryption materials already contain a plaintext data key,
    TEXT[!MUST,implication]: the keyring MUST fail
    TEXT[!MUST,implication]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST,implementation,test]: Otherwise, OnDecrypt MUST first attempt to decrypt the [encrypted data keys](structures.md#encrypted-data-keys-1)
    TEXT[!MUST,implementation,test]: in the input [decryption materials](structures.md#decryption-materials) using its
    TEXT[!MUST,implementation,test]: [generator keyring](#generator-keyring).
    TEXT[!MUST,implementation,test]: If the generator keyring is unable to decrypt
    TEXT[!MUST,implementation,test]: the materials, the multi-keyring MUST attempt to decrypt using its child keyrings,
    TEXT[!MUST,implementation,test]: until one either succeeds in decryption or all have failed.
    TEXT[!MUST,implementation,todo]: For each [keyring](keyring-interface.md) to be used for decryption,
    TEXT[!MUST,implementation,todo]: the multi-keyring MUST call that keyring's [OnDecrypt](keyring-interface.md#ondecrypt) using
    TEXT[!MUST,implementation,todo]: the unmodified [decryption materials](structures.md#decryption-materials) and the input
    TEXT[!MUST,implementation,todo]: [encrypted data key](structures.md#encrypted-data-key) list.
    TEXT[!MUST,implementation,todo]: If [OnDecrypt](keyring-interface.md#ondecrypt) returns [decryption materials](structures.md#decryption-materials)
    TEXT[!MUST,implementation,todo]: containing a plaintext data key, the multi-keyring MUST immediately return the modified decryption materials.
    TEXT[!MUST,implementation,test]: If the child keyring's OnDecrypt call fails, the multi-keyring MUST collect the error and continue
    TEXT[!MUST,implementation,test]: to the next keyring, if any.
    TEXT[!MUST,implementation,test]: If, after calling [OnDecrypt](keyring-interface.md#ondecrypt) on every [child keyring](#child-keyrings)
    TEXT[!MUST,implementation,test]: (and possibly the [generator keyring](#generator-keyring)), the [decryption materials](structures.md#decryption-materials)
    TEXT[!MUST,implementation,test]: still do not contain a plaintext data key, OnDecrypt MUST return a failure message containing the
    TEXT[!MUST,implementation,test]: collected failure messages from the child keyrings.

  SECTION: [Security Considerations](#security-considerations)
    TEXT[!SHOULD]: Users SHOULD examine the [keyrings](keyring-interface.md) they include in a multi-keyring to ensure
    TEXT[!SHOULD]: that they understand what set of keyrings will be capable of obtaining the plaintext data key from
    TEXT[!SHOULD]: the returned set of encrypted data keys.

SPECIFICATION: [Raw AES Keyring](aws-encryption-sdk-specification/framework/raw-aes-keyring.md)
  SECTION: [Changelog](#changelog)
    TEXT[!MUST]:   - [
    TEXT[!MUST,implication]: Raw AES keyring MUST NOT accept a key namespace of "aws-kms".
    TEXT[!MUST]: ](https://github.com/awslabs/aws-encryption-sdk-specification/issues/101)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: On keyring initialization,
    TEXT[!MUST,implication]: the caller MUST provide the following:

  SECTION: [Wrapping Key](#wrapping-key)
    TEXT[!MUST,implementation]: The wrapping key MUST be a secret value consisting of cryptographically secure pseudo-random bytes.
    TEXT[!MUST,implementation]: It MUST be randomly generated from a cryptographically secure entropy source.
    TEXT[!MUST,implication]: The length of the wrapping key MUST be 128, 192, or 256.

  SECTION: [Wrapping Algorithm](#wrapping-algorithm)
    TEXT[!MUST]: The keyring MUST support the following algorithm configurations:
    TEXT[!MUST]: Initialization MUST fail if the length of the [wrapping key](#wrapping-key) does not match the length specified by the wrapping algorithm.

  SECTION: [Authentication Tag Length](#authentication-tag-length)
    TEXT[!MUST,implication]: This value MUST match the authentication tag length of the keyring's configured [wrapping algorithm
    TEXT[!MUST]: ](#wrapping-algorithm).

  SECTION: [IV Length](#iv-length)
    TEXT[!MUST,implication]: This value MUST match the IV length of the keyring's configured [wrapping algorithm
    TEXT[!MUST]: ](#wrapping-algorithm).

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: OnEncrypt MUST take [encryption materials](structures.md#encryption-materials) as input.
    TEXT[!MUST,test]: If the [encryption materials](structures.md#encryption-materials) do not contain a plaintext data key,
    TEXT[!MUST,test]: OnEncrypt MUST generate a random plaintext data key and set it on the [encryption materials](structures.md#encryption-materials).
    TEXT[!MUST,implementation,test]: The keyring MUST encrypt the plaintext data key in the [encryption materials](structures.md#encryption-materials)
    TEXT[!MUST,implementation,test]: using AES-GCM.
    TEXT[!MUST,implementation,implication,test]: The keyring MUST attempt to serialize the [encryption materials'](structures.md#encryption-materials)
    TEXT[!MUST,implementation,implication,test]: [encryption context](structures.md#encryption-context-1) according to the [encryption context serialization specification](structures.md#serialization).
    TEXT[!MUST,implication]: If the keyring cannot serialize the encryption context, OnEncrypt MUST fail.
    TEXT[!MUST]: - It MUST use the serialized [encryption context](structures.md#encryption-context-1) as the additional authenticated data (AAD).
    TEXT[!MUST]: - It MUST use this keyring's [wrapping key](#wrapping-key) as the AES-GCM cipher key.
    TEXT[!MUST]: - It MUST use a cryptographically random generated IV of length specified by this keyring's [wrapping algorithm](#wrapping-algorithm).
    TEXT[!MUST]: - It MUST use an authentication tag bit of length specified by this keyring's [wrapping algorithm](#wrapping-algorithm).
    TEXT[!MUST]: Based on the ciphertext output of the AES-GCM decryption,
    TEXT[!MUST]: the keyring MUST construct an [encrypted data key](structures.md#encrypted-data-key) with the following specifics:
    TEXT[!MUST,implementation,test]: The keyring MUST append the constructed encrypted data key to the encrypted data key list in the
    TEXT[!MUST,implementation,test]: [encryption materials](structures.md#encryption-materials).
    TEXT[!MUST,implementation,test]: OnEncrypt MUST output the modified [encryption materials](structures.md#encryption-materials).

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST,implication]: OnDecrypt MUST take [decryption materials](structures.md#decryption-materials) and
    TEXT[!MUST,implication]: a list of [encrypted data keys](structures.md#encrypted-data-key) as input.
    TEXT[!MUST]: If the decryption materials already contain a plaintext data key,
    TEXT[!MUST]: the keyring MUST fail
    TEXT[!MUST]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST,implication,test]: The keyring MUST attempt to serialize the [decryption materials'](structures.md#decryption-materials)
    TEXT[!MUST,implication,test]: [encryption context](structures.md#encryption-context-1) according to the [encryption context serialization specification](structures.md#serialization).
    TEXT[!MUST,implication]: If the keyring cannot serialize the encryption context, OnDecrypt MUST fail.
    TEXT[!MUST,implementation]: The keyring MUST perform the following actions on each [encrypted data key](structures.md#encrypted-data-key)
    TEXT[!MUST,implementation]: in the input encrypted data key list, serially, until it successfully decrypts one.
    TEXT[!MUST]: For each [encrypted data key](structures.md#encrypted-data-key),
    TEXT[!MUST]: the keyring MUST first attempt to deserialize the [serialized ciphertext](#ciphertext)
    TEXT[!MUST]: to obtain the [encrypted key](#encrypted-key) and [authentication tag](#authentication-tag), and
    TEXT[!MUST]: deserialize the [serialized key provider info](#key-provider-information) to obtain the [key name](./keyring-interface.md#key-name),
    TEXT[!MUST]: [IV](#iv), [IV length](#iv-length), and [authentication tag length](#authentication-tag-length).
    TEXT[!MUST]: - The [ciphertext](#ciphertext) and [key provider information](#key-provider-information) MUST be successfully deserialized.
    TEXT[!MUST]: - The key name obtained from the encrypted data key's key provider information MUST have a value equal to this keyring's [key name](./keyring-interface.md#key-name).
    TEXT[!MUST]: - The key provider ID of the encrypted data key MUST have a value equal to this keyring's [key namespace](./keyring-interface.md#key-namespace).
    TEXT[!MUST]: - The [IV length](#iv-length) obtained from the encrypted data key's key provider information MUST have a value equal to the length specified by this keyring's [wrapping algorithm](#wrapping-algorithm).
    TEXT[!MUST]: - The [authentication tag length](#authentication-tag-length) obtained from the key provider information MUST have a value equal to the length specified by this keyring's [wrapping algorithm](#wrapping-algorithm).
    TEXT[!MUST]: - It MUST use the [encrypt key](#encrypted-key) obtained from deserialization as the AES-GCM input ciphertext.
    TEXT[!MUST]: - It MUST use the [authentication tag](#authentication-tag) obtained from deserialization as the AES-GCM input authentication tag.
    TEXT[!MUST]: - It MUST use this keyring's [wrapping key](#wrapping-key) as the AES-GCM cipher key.
    TEXT[!MUST]: - It MUST use the [IV](#iv) obtained from deserialization as the AES-GCM IV.
    TEXT[!MUST]: - It MUST use the serialized [encryption context](structures.md#encryption-context-1) as the AES-GCM AAD.
    TEXT[!MUST,implementation,test]: If a decryption succeeds, this keyring MUST
    TEXT[!MUST,implementation,test]: add the resulting plaintext data key to the decryption materials and return the modified materials.
    TEXT[!MUST,implementation]: If no decryption succeeds,
    TEXT[!MUST,implementation]: the keyring MUST fail
    TEXT[!MUST,implementation]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).

SPECIFICATION: [Raw ECDH Keyring](aws-encryption-sdk-specification/framework/raw-ecdh-keyring.md)
  SECTION: [ECC Keys](#ecc-keys)
    TEXT[!MUST]: ECC Private Key MUST be a [PEM encoded PKCS #8 PrivateKeyInfo structures](https://tools.ietf.org/html/rfc5958#section-2)
    TEXT[!MUST]: as private key.
    TEXT[!MUST]: ECC Public Key MUST be a [DER-encoded ASN.1 SubjectPublicKeyInfo](https://datatracker.ietf.org/doc/html/rfc5280#section-4.1)

  SECTION: [Interface](#interface)
    TEXT[!MUST,implication]: MUST implement the [AWS Encryption SDK Keyring interface](../keyring-interface.md#interface)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: - MUST provide a [Key Agreement Schema](#key-agreement-schema)
    TEXT[!MUST,implication]: - MUST provide a [Curve Specification](#curve-specification)
    TEXT[!MUST,implementation]: On initialization, the keyring MUST assert that the recipient's public key
    TEXT[!MUST,implementation]: and the sender's private key belong to the same ECC Curve, and that
    TEXT[!MUST,implementation]: the public key's ECC points are not the "points at infinity".
    TEXT[!MUST,implication]: The keyring MUST set the sender's public key
    TEXT[!MUST,implication]: and the recipient's public key on the keyring.

  SECTION: [Curve Specification](#curve-specification)
    TEXT[!MUST]: This value MUST correspond with one of the [supported curve specifications](#supported-curve-specifications).

  SECTION: [Supported Curve Specifications](#supported-curve-specifications)
    TEXT[!MUST]: This keyring MUST NOT use a curve specification outside of the defined above.

  SECTION: [Additional Information](#additional-information)
    TEXT[!SHOULD]: As such, users
    TEXT[!SHOULD]: SHOULD use the Additional Information to store:
    TEXT[!MUST]: - Non-secret data that MUST remain associated with the [message](../data-format/message.md) ciphertext.

  SECTION: [Key Provider Information](#key-provider-information)
    TEXT[!MUST,implementation]: Both the recipient and the sender public keys MUST be in their compressed formats.

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: OnEncrypt MUST fail if configured with a
    TEXT[!MUST,implication]: [PublicKeyDiscovery Key Agreement Configuration](./key-agreement-schemas.md#publickeydiscovery)
    TEXT[!MUST]: OnEncrypt MUST fail if this keyring does not have
    TEXT[!MUST]: the ECC Key Pairs as specified by the configured
    TEXT[!MUST]: [Key Agreement Schema](./key-agreement-schemas.md#supported-key-agreement-schemas)
    TEXT[!MUST,implication]: OnEncrypt MUST take [encryption materials](structures.md#encryption-materials) as input.
    TEXT[!MUST]: The keyring MUST attempt to serialize the [encryption materials'](structures.md#encryption-materials)
    TEXT[!MUST]: [encryption context](structures.md#encryption-context-1) according to the [encryption context serialization specification](structures.md#serialization).
    TEXT[!MUST,implication]: If the keyring cannot serialize the encryption context, OnEncrypt MUST fail.
    TEXT[!MUST,implementation]: The keyring MUST derive the shared secret
    TEXT[!MUST,implementation]: according to the configured [Key Agreement Schema](#key-agreement-procedure).
    TEXT[!MUST]: If the keyring fails to compute the shared secret, the keyring MUST fail.
    TEXT[!MUST,implementation]: The keyring MUST derive a data key according to the construction
    TEXT[!MUST,implementation]: outlined by the [key agreement schemas](./key-agreement-schemas.md#key-derivation)
    TEXT[!MUST]: If the Key Derivation step fails, the keyring MUST fail.
    TEXT[!MUST]: If they Key Derivation step succeeds it MUST produce
    TEXT[!MUST]: keying material with a length of 64 bytes.
    TEXT[!MUST]: The keyring MUST use the first 32 bytes as the Commitment Key.
    TEXT[!MUST]: The keyring MUST use the last 32 bytes as the Derived Shared Wrapping Key.
    TEXT[!MUST,implementation]: The keyring MUST perform data key wrapping according to the [Data Key Wrapping section](#data-key-wrapping).
    TEXT[!MUST]: Based on the ciphertext output of the AES-GCM encryption,
    TEXT[!MUST]: the keyring MUST construct an [encrypted data key](structures.md#encrypted-data-key) with the following specifics:
    TEXT[!MUST,implementation]: - The [key provider id](../structures.md#key-provider-id) MUST be the UTF8 encoded string "raw-ecdh".

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST,implication]: OnDecrypt MUST fail if configured with a
    TEXT[!MUST,implication]: [EphemeralPrivateKeyToStaticPublicKey Key Agreement Configuration](./key-agreement-schemas.md#ephemeralprivatekeytostaticpublickey)
    TEXT[!MUST]: OnDecrypt MUST take [decryption materials](structures.md#decryption-materials) and
    TEXT[!MUST]: a list of [encrypted data keys](structures.md#encrypted-data-key) as input.
    TEXT[!MUST,implementation]: If the decryption materials already contain a plaintext data key,
    TEXT[!MUST,implementation]: the keyring MUST fail
    TEXT[!MUST,implementation]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST]: The keyring MUST attempt to serialize the [decryption materials'](structures.md#decryption-materials)
    TEXT[!MUST]: [encryption context](structures.md#encryption-context-1) according to the [encryption context serialization specification](structures.md#serialization).
    TEXT[!MUST,implication]: If the keyring cannot serialize the encryption context, OnDecrypt MUST fail.
    TEXT[!MUST,implementation]: The set of encrypted data keys MUST first be filtered to match this keyring’s configuration.
    TEXT[implementation]: For the encrypted data key to match:
    TEXT[!MUST,implementation]: - MUST first verify that the uncompressed deserialized sender public key
    TEXT[!MUST,implementation]:   and the uncompressed deserialized recipient public key match the public
    TEXT[!MUST,implementation]:   keys configured on the keyring.
    TEXT[!MUST,implementation]: - The deserialized version value in the [key provider information](#key-provider-information) MUST match `0x01`.
    TEXT[!MUST,implementation]: - The [ciphertext](#ciphertext) and [key provider information](#key-provider-information) MUST be successfully deserialized.
    TEXT[!MUST,implementation]: - The key provider ID of the encrypted data key MUST have a value equal to the UTF8 encoded strings `raw-ecdh` OR `aws-kms-ecdh`.
    TEXT[!MUST]: - The [authentication tag length](#authentication-tag-length) obtained from the key provider information MUST have a value equal to 16 bytes.
    TEXT[!MUST,implementation]: For each encrypted data key in the filtered set, one at a time, the OnDecrypt MUST attempt to decrypt the data key.
    TEXT[!MUST,implementation]: If this attempt results in an error, then these errors MUST be collected.
    TEXT[!MUST]: To attempt to decrypt a particular [encrypted data key](./structures.md#encrypted-data-key),
    TEXT[!MUST]: OnDecrypt MUST attempt to deserialize the [serialized ciphertext](#ciphertext)
    TEXT[!MUST]: to obtain:
    TEXT[!MUST]: If the keyring is unable to deserialize this information then an error MUST be collected
    TEXT[!MUST]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST,implementation]: The keyring MUST derive the shared secret
    TEXT[!MUST,implementation]: according to the configured [Key Agreement Schema](#key-agreement-procedure).
    TEXT[!MUST]: If the Key Agreement step fails, then an error MUST be collected
    TEXT[!MUST]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST]: The keyring MUST derive a shared wrapping key according to the construction
    TEXT[!MUST]: outlined by the [key agreement schemas](./key-agreement-schemas.md#key-derivation)
    TEXT[!MUST]: If the Key Derivation step fails, then an error MUST be collected
    TEXT[!MUST]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST]: If they Key Derivation step succeeds it MUST produce
    TEXT[!MUST]: keying material with a length of 64 bytes.
    TEXT[!MUST]: The keyring MUST use the first 32 bytes as the Commitment Key.
    TEXT[!MUST]: The keyring MUST use the last 32 bytes as the Derived Shared Wrapping Key.
    TEXT[!MUST,implementation]: The keyring MUST check that the calculated Commitment Key
    TEXT[!MUST,implementation]: from the key derivation step is equal to the deserialized commitment key
    TEXT[!MUST,implementation]: found in the encrypted data key.
    TEXT[!MUST]: This check MUST be a constant time check.
    TEXT[!MUST]: If the commitment keys DO NOT match, then an error MUST be collected
    TEXT[!MUST]: and the next encrypted data key in the filtered set MUST be attempted.
    TEXT[!MUST,implementation]: The keyring MUST perform data key unwrapping according to the [Data Key Unwrapping section](#data-key-unwrapping).
    TEXT[!MUST]: If the keyring fails to unwrap the data key,
    TEXT[!MUST]: then an error MUST be collected and the next encrypted data key
    TEXT[!MUST]: in the filtered set MUST be attempted.
    TEXT[implementation]: If the response does satisfy these requirements then OnDecrypt:
    TEXT[!MUST]: - MUST set the plaintext data key on the [decryption materials](./structures.md#decryption-materials)
    TEXT[!MUST]: - MUST immediately return the modified [decryption materials](../structures.md#decryption-materials).
    TEXT[!MUST,implementation]: If OnDecrypt fails to successfully decrypt any encrypted data key,
    TEXT[!MUST,implementation]: then it MUST yield an error that includes all the collected errors.

  SECTION: [Data Key Wrapping](#data-key-wrapping)
    TEXT[!MUST,implication]: If the [encryption materials](structures.md#encryption-materials) do not contain a plaintext data key,
    TEXT[!MUST,implication]: OnEncrypt MUST generate a random plaintext data key.
    TEXT[!MUST,implication]: The keyring MUST encrypt the plaintext data key
    TEXT[!MUST,implication]: using AES-GCM and use the shared wrapping key as the wrapping key.
    TEXT[!MUST,implementation]: The keyring MUST encrypt a plaintext data key
    TEXT[!MUST,implementation]: using `AES-GCM-256` with the following inputs:
    TEXT[!MUST,implementation]: - MUST use the shared wrapping key as the AES-GCM cipher key.
    TEXT[!MUST,implementation]: - MUST use the plain text data key that will be wrapped by the shared wrapping key as the AES-GCM message.
    TEXT[!MUST,implementation,implication]: - It MUST use a zeroed out 12 byte IV
    TEXT[!MUST,implication]: - MUST use an authentication tag byte of length 16.
    TEXT[!MUST,implementation]: - MUST use the serialized [AAD](#branch-key-wrapping-and-unwrapping-aad) concatenated
    TEXT[!MUST,implementation]:   with the `FixedInfo` used as part of the key derivation step concatenated with the keyring version found
    TEXT[!MUST,implementation]:   in the key provider information.
    TEXT[!MUST]: The serialized AAD and the `FixedInfo` field MUST be serialized in the following order:
    TEXT[!MUST,implementation]: If the keyring successfully wraps the plaintext data key it MUST set it on the [encryption materials](structures.md#encryption-materials).

  SECTION: [Data Key Unwrapping](#data-key-unwrapping)
    TEXT[!MUST,implementation]: The keyring MUST decrypt the encrypted data key with the shared wrapping key using `AES-GCM-256` with the following inputs:
    TEXT[!MUST,implementation]: - It MUST use the `encrypted key` obtained from deserialization as the AES-GCM input ciphertext.
    TEXT[!MUST,implementation]: - It MUST use the `authentication tag` obtained from deserialization as the AES-GCM input authentication tag.
    TEXT[!MUST,implementation]: - It MUST use the shared wrapping key as the AES-GCM cipher key.
    TEXT[!MUST,implementation]: - It MUST use a zeroed out 12 byte IV
    TEXT[!MUST,implementation]: - MUST use the serialized [AAD](#branch-key-wrapping-and-unwrapping-aad) concatenated
    TEXT[!MUST,implementation]:   with the `FixedInfo` used as part of the key derivation step concatenated with the keyring version found
    TEXT[!MUST,implementation]:   in the key provider information.
    TEXT[!MUST]: The serialized AAD and the `FixedInfo` field MUST be serialized in the following order:

SPECIFICATION: [Raw RSA Keyring](aws-encryption-sdk-specification/framework/raw-rsa-keyring.md)
  SECTION: [Changelog](#changelog)
    TEXT[!MUST]:   - [
    TEXT[!MUST,implication]: Raw RSA keyring MUST NOT accept a key namespace of "aws-kms".
    TEXT[!MUST]: ](https://github.com/awslabs/aws-encryption-sdk-specification/issues/101)

  SECTION: [Initialization](#initialization)
    TEXT[!MUST,implication]: On keyring initialization,
    TEXT[!MUST,implication]: the caller MUST provide the following:
    TEXT[implication]: - [Key Namespace](./keyring-interface.md#key-namespace)
    TEXT[implication]: - [Key Name](./keyring-interface.md#key-name)
    TEXT[implication]: - [Padding Scheme](#padding-scheme)
    TEXT[implication]: - [Public Key](#public-key) and/or [Private Key](#private-key)

  SECTION: [Padding Scheme](#padding-scheme)
    TEXT[!MUST,implication]: This value MUST correspond with one of the [supported padding schemes](#supported-padding-schemes).
    TEXT[!MUST]: If the padding scheme uses MGF1 Padding, the hash function used as part of MGF1 MUST be the same hash function
    TEXT[!MUST]: used to hash the plaintext data key.

  SECTION: [Supported Padding Schemes](#supported-padding-schemes)
    TEXT[!MUST]: This keyring MUST NOT use a padding scheme outside those defined above.

  SECTION: [Public Key](#public-key)
    TEXT[!MUST,todo]: The public key MUST follow the [RSA specification for public keys](#rsa)
    TEXT[!MUST]: .
    TEXT[!SHOULD,todo]: The raw RSA keyring SHOULD support loading PEM encoded [X.509 SubjectPublicKeyInfo structures](https://tools.ietf.org/html/rfc5280#section-4.1)
    TEXT[!SHOULD,todo]: as public keys.

  SECTION: [Private Key](#private-key)
    TEXT[!MUST,todo]: The private key MUST follow the [RSA specification for private keys](#rsa)
    TEXT[!MUST]: .
    TEXT[!SHOULD]: The raw RSA keyring SHOULD support loading PEM encoded [PKCS #8 PrivateKeyInfo structures](https://tools.ietf.org/html/rfc5958#section-2)
    TEXT[!SHOULD]: as private keys.
    TEXT[!SHOULD,todo]: The private key SHOULD contain all Chinese Remainder Theorem (CRT) components (public exponent, prime factors, CRT exponents, and CRT coefficient).

  SECTION: [OnEncrypt](#onencrypt)
    TEXT[!MUST,implication]: OnEncrypt MUST fail if this keyring does not have a specified [public key](#public-key).
    TEXT[!MUST,implication]: The keyring MUST NOT derive a public key from a specified [private key](#private-key).
    TEXT[!MUST,implication]: OnEncrypt MUST take [encryption materials](structures.md#encryption-materials) as input.
    TEXT[!MUST,implementation,implication]: If the [encryption materials](structures.md#encryption-materials) do not contain a plaintext data key,
    TEXT[!MUST,implementation,implication]: OnEncrypt MUST generate a random plaintext data key and set it on the [encryption materials](structures.md#encryption-materials).
    TEXT[!MUST,implementation,test]: The keyring MUST attempt to encrypt the plaintext data key in the
    TEXT[!MUST,implementation,test]: [encryption materials](structures.md#encryption-materials) using RSA.
    TEXT[implementation]: The keyring performs [RSA encryption](#rsa) with the following specifics:
    TEXT[implementation]: - This keyring's [public key](#public-key) is the RSA public key.
    TEXT[implementation]: - This keyring's [padding scheme](#supported-padding-schemes) is the RSA padding scheme.
    TEXT[implementation]: - The plaintext data key is the plaintext input to RSA encryption.
    TEXT[!MUST,implementation,implication]: If RSA encryption was successful, OnEncrypt MUST return the input
    TEXT[!MUST,implementation,implication]: [encryption materials](structures.md#encryption-materials), modified in the following ways:
    TEXT[implementation,implication]: - The encrypted data key list has a new encrypted data key added, constructed as follows:
    TEXT[implementation]:   - The [key provider ID](structures.md#key-provider-id) field is this keyring's [key namespace](keyring-interface.md#key-namespace).
    TEXT[implementation]:   - The [key provider information](structures.md#key-provider-information) field is this keyring's [key name](keyring-interface.md#key-name).
    TEXT[implementation]:   - The [ciphertext](structures.md#ciphertext) field is the ciphertext output by
    TEXT[implementation]:     the RSA encryption of the plaintext data key.

  SECTION: [OnDecrypt](#ondecrypt)
    TEXT[!MUST,implication]: OnDecrypt MUST fail if this keyring does not have a specified [private key](#private-key).
    TEXT[!MUST,implication]: OnDecrypt MUST take [decryption materials](structures.md#decryption-materials) and
    TEXT[!MUST,implication]: a list of [encrypted data keys](structures.md#encrypted-data-key) as input.
    TEXT[!MUST,implication]: If the decryption materials already contain a plaintext data key,
    TEXT[!MUST,implication]: the keyring MUST fail
    TEXT[!MUST,implication]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).
    TEXT[!MUST,implementation,test]: The keyring MUST attempt to decrypt the input encrypted data keys, in list order, until it successfully decrypts one.
    TEXT[!MUST,implication]: For each encrypted data key, the keyring MUST attempt to decrypt the encrypted data key into plaintext
    TEXT[!MUST,implication]: using RSA if and only if the following is true:
    TEXT[implication]: - The encrypted data key's [key provider information](structures.md#key-provider-information).
    TEXT[implication]:   has a value equal to this keyring's [key name](keyring-interface.md#key-name).
    TEXT[implication]: - The encrypted data key's [key provider ID](structures.md#key-provider-id) has a value equal to
    TEXT[implication]:   this keyring's [key namespace](keyring-interface.md#key-namespace).
    TEXT[!MUST,implementation,test]: If any decryption succeeds, this keyring MUST immediately return the input
    TEXT[!MUST,implementation,test]: [decryption materials](structures.md#decryption-materials), modified in the following ways:
    TEXT[implementation]: - The output of RSA decryption is set as the decryption material's plaintext data key.
    TEXT[!MUST,implementation,test]: If no decryption succeeds,
    TEXT[!MUST,implementation,test]: the keyring MUST fail
    TEXT[!MUST,implementation,test]: and MUST NOT modify the [decryption materials](structures.md#decryption-materials).

SPECIFICATION: [Required Encryption Context Cryptographic Materials Manager](aws-encryption-sdk-specification/framework/required-encryption-context-cmm.md)
  SECTION: [Overview](#overview)
    TEXT[!MUST]: This set of keys MUST

  SECTION: [Initialization](#initialization)
    TEXT[!MUST]: On Required Encryption Context CMM initialization,
    TEXT[!MUST]: the caller MUST provide the following values:
    TEXT[!MUST]: Additionally, the caller MUST provide one of the following values:
    TEXT[!MUST]: If the caller provides a keyring,
    TEXT[!MUST]: then the Required Encryption Context CMM MUST set its underlying CMM
    TEXT[!MUST]: to a [default CMM](default-cmm.md) initialized with the keyring.

  SECTION: [Get Encryption Materials](#get-encryption-materials)
    TEXT[!MUST,implication]: The encryption context on the [encryption materials request](./cmm-interface.md#encryption-materials-request)
    TEXT[!MUST,implication]: MUST contain a value for every key in the configured [required encryption context keys](#required-encryption-context-keys)
    TEXT[!MUST,implication]: or this request MUST fail.
    TEXT[!MUST,implication]: The Required Encryption Context CMM MUST attempt to obtain [encryption materials](./structures.md#encryption-materials)
    TEXT[!MUST,implication]: by making a call to the [underlying CMM's](#underlying-cryptographic-materials-manager)
    TEXT[!MUST,implication]: [Get Encryption Materials](cmm-interface.md#get-encryption-materials).
    TEXT[!MUST,implication]: All configured [required encryption context keys](#required-encryption-context-keys)
    TEXT[!MUST,implication]: MUST exist in the required encryption context keys
    TEXT[!MUST,implication]: of the [encryption materials request](./cmm-interface.md#encryption-materials-request)
    TEXT[!MUST,implication]: to the [underlying CMM's](#underlying-cryptographic-materials-manager).
    TEXT[!MUST,implication]: The obtained [encryption materials](./structures.md#encryption-materials) MUST
    TEXT[!MUST,implication]: have all configured [required encryption context keys](#required-encryption-context-keys)
    TEXT[!MUST,implication]: in it's [required encryption context keys](./structures.md#required-encryption-context-keys).

  SECTION: [Decrypt Materials](#decrypt-materials)
    TEXT[!MUST,implication]: The reproduced encryption context on the [decrypt materials request](./cmm-interface.md#decrypt-materials-request)
    TEXT[!MUST,implication]: MUST contain a value for every key in the configured [required encryption context keys](#required-encryption-context-keys)
    TEXT[!MUST,implication]: or this request MUST fail.
    TEXT[!MUST,implication]: The Required Encryption Context
    TEXT[!MUST,implication]: CMM MUST attempt to obtain [decryption materials](./structures.md#decryption-materials)
    TEXT[!MUST,implication]: by making a call to the [underlying CMM's](#underlying-cryptographic-materials-manager)
    TEXT[!MUST,implication]: [decrypt materials](cmm-interface.md#decrypt-materials) interface
    TEXT[!MUST,implication]: with the unchanged [decrypt materials request](./cmm-interface.md#decrypt-materials-request).
    TEXT[!MUST,implication]: The obtained [decryption materials](./structures.md#decryption-materials) MUST
    TEXT[!MUST,implication]: have all configured [required encryption context keys](#required-encryption-context-keys)
    TEXT[!MUST,implication]: in it's [encryption context](./structures.md#encryption-context-2).

SPECIFICATION: [Storm Tracking Cryptographic Materials Cache](aws-encryption-sdk-specification/framework/storm-tracking-cryptographic-materials-cache.md)
  SECTION: [Initialization](#initialization)
    TEXT[!MUST]: On initialization of the storm tracking CMC,
    TEXT[!MUST]: the caller MUST provide exactly what is required by a
    TEXT[!MUST]: [Local CMC](local-cryptographic-materials-cache.md).
    TEXT[!MUST]: Initialization MUST also provide
    TEXT[!MUST]: The implementation MUST instantiate a [Local CMC](local-cryptographic-materials-cache.md)
    TEXT[!MUST]: to do the actual cacheing.

  SECTION: [Behaviors](#behaviors)
    TEXT[!MUST]: The interface MUST be exactly the same as a [Local CMC](local-cryptographic-materials-cache.md),
    TEXT[!MUST]: even if used in a multi-threaded context, with two exceptions

  SECTION: [In Flight](#in-flight)
    TEXT[!MUST]: For each in flight key, the storm tracking CMC MUST keep track of the most recent time
    TEXT[!MUST]: that NoSuchEntry was returned, with accuracy to the second.

  SECTION: [PutCacheEntry](#putcacheentry)
    TEXT[!MUST]: PutCacheEntry MUST mark the key as not in flight.

  SECTION: [Within Grace Period](#within-grace-period)
    TEXT[!MUST]: A time `now` MUST be considered within the [grace period](#grace-period) for an entry that expires
    TEXT[!MUST]: at a time `expiry` if `(expiry - gracePeriod) <= now`

  SECTION: [Within Grace Interval](#within-grace-interval)
    TEXT[!MUST]: A time `now` MUST be considered within the [grace interval](#grace-interval)
    TEXT[!MUST]: of an inflight entry at `inflight` time
    TEXT[!MUST]: if `now < (inflight + graceInterval)`

  SECTION: [GetCacheEntry](#getcacheentry)
    TEXT[!MUST]: The implementation MUST call the [Local CMC](local-cryptographic-materials-cache.md)
    TEXT[!MUST]: to find the cached materials for the key, if any.
    TEXT[!MUST]: - If the number of things inflight is greater than or equal to the [FanOut](#fanout)
    TEXT[!MUST]:   GetCacheEntry MUST return the cache entry.
    TEXT[!MUST]: - If the key's expiration _is not_ [within the grace period](#within-grace-period),
    TEXT[!MUST]:   GetCacheEntry MUST return the cache entry.
    TEXT[!MUST]: - If the key's expiration _is_ [within the grace period](#within-grace-period),
    TEXT[!MUST]:   and the key _is not_ inflight
    TEXT[!MUST]:   GetCacheEntry MUST return NoSuchEntry and mark that key as inflight at the current time.
    TEXT[!MUST]: - If the key's expiration _is_ [within the grace period](#within-grace-period),
    TEXT[!MUST]:   and the key _is_ inflight
    TEXT[!MUST]:   and the inflight time _is_ [within the grace interval](#within-grace-interval)
    TEXT[!MUST]:   GetCacheEntry MUST return the cache entry.
    TEXT[!MUST]: - If the key's expiration _is_ [within the grace period](#within-grace-period),
    TEXT[!MUST]:   and the key _is_ inflight
    TEXT[!MUST]:   and the inflight time _is not_ [within the grace interval](#within-grace-interval)
    TEXT[!MUST]:   GetCacheEntry MUST return NoSuchEntry and update the key as inflight at the current time.
    TEXT[!MUST]: - If the number of things inflight is greater than or equal to the [FanOut](#fanout)
    TEXT[!MUST]:   GetCacheEntry MUST block until a [FanOut](#fanout) slot is available, or the key appears in the cache.
    TEXT[!MUST]: - If the key _is not_ inflight
    TEXT[!MUST]:   GetCacheEntry MUST return NoSuchEntry and mark that key as inflight at the current time.
    TEXT[!MUST]: - If the key _is_ inflight
    TEXT[!MUST]:   and the current time _is_ [within the grace interval](#within-grace-interval)
    TEXT[!MUST]:   GetCacheEntry MUST block until a [FanOut](#fanout) slot is available, or the key appears in the cache.
    TEXT[!MUST]: - If the key _is_ inflight
    TEXT[!MUST]:   and the current time _is not_ [within the grace interval](#within-grace-interval)
    TEXT[!MUST]:   GetCacheEntry MUST return NoSuchEntry and update the key as inflight at the current time.

SPECIFICATION: [Structures](aws-encryption-sdk-specification/framework/structures.md)
  SECTION: [Overview](#overview)
    TEXT[!MUST,implication]: These structures define a group of related fields that MUST hold certain properties.
    TEXT[!MUST,implication]: Wherever these structures are referenced in this specification,
    TEXT[!MUST,implication]: implementations MUST ensure that all properties of a structure's fields are upheld.
    TEXT[!MAY,implication,exception]: While these structures will usually be represented as objects, lower level languages MAY represent
    TEXT[!MAY,implication,exception]: these fields in a less strictly defined way as long as all field properties are still upheld.

  SECTION: [Structure](#structure)
    TEXT[implication]: An encrypted data key is comprised of the following fields:
    TEXT[implication]: - [Key Provider ID](#key-provider-id)
    TEXT[implication]: - [Key Provider Information](#key-provider-information)
    TEXT[implication]: - [Ciphertext](#ciphertext)
    TEXT[implication]: Note: "Encrypted" is a misnomer here, as the process by which a key provider may obtain the plaintext data key
    TEXT[implication]: from the ciphertext and vice versa does not have to be an encryption and decryption cipher.
    TEXT[!MAY,implication,exception]: This specification uses the terms "encrypt" and "decrypt" for simplicity,
    TEXT[!MAY,implication,exception]: but the actual process by which a key provider obtains the plaintext data key from the ciphertext
    TEXT[!MAY,implication,exception]: and vice versa MAY be any reversible operation, though we expect that most will use encryption.

  SECTION: [Ciphertext](#ciphertext)
    TEXT[!MUST,exception]: Some key provider MUST be capable of deterministically obtaining the plaintext key from the ciphertext.

  SECTION: [Structure](#structure-1)
    TEXT[implication]: The encryption context is a key-value mapping of arbitrary, non-secret, UTF-8 encoded strings.
    TEXT[implication]: It is used during [encryption](../client-apis/encrypt.md) and [decryption](../client-apis/decrypt.md) to provide additional authenticated data (AAD).
    TEXT[!SHOULD,exception]: Users SHOULD use the encryption context to store:
    TEXT[!MUST,exception]: - Non-secret data that MUST remain associated with the [message](../data-format/message.md) ciphertext.
    TEXT[exception]: - Data that is useful in logging and tracking, such as data about the file type, purpose, or ownership.
    TEXT[!MUST,exception]: Users MUST NOT use the encryption context to store secret data.

  SECTION: [Serialization](#serialization)
    TEXT[!MUST]: If the encryption context is empty, its serialization MUST be
    TEXT[!MUST]: an empty byte sequence.
    TEXT[!MUST]: If the encryption context is not empty, its serialization MUST
    TEXT[!MUST]: take the following form:

  SECTION: [Key Value Pair Count](#key-value-pair-count)
    TEXT[!MUST]: The value of this field MUST be greater than 0.

  SECTION: [Key Value Pair Entries](#key-value-pair-entries)
    TEXT[!MUST]: This sequence MUST NOT contain duplicate entries.
    TEXT[!MUST]: These entries MUST be sorted, by key,
    TEXT[!MUST]: in ascending order according to the UTF-8 encoded binary value.

  SECTION: [Structure](#structure-2)
    TEXT[!MUST,implication]: This structure MUST include the following fields:
    TEXT[implication]: - [Algorithm Suite](#algorithm-suite)
    TEXT[implication]: - [Encrypted Data Keys](#encrypted-data-keys)
    TEXT[implication]: - [Encryption Context](#encryption-context-1)
    TEXT[implication]: - [Required Encryption Context Keys](#required-encryption-context-keys)
    TEXT[!MAY,implication]: This structure MAY include any of the following fields:
    TEXT[implication]: - [Plaintext Data Key](#plaintext-data-key)
    TEXT[implication]: - [Signing Key](#signing-key)

  SECTION: [Encrypted Data Keys](#encrypted-data-keys)
    TEXT[!MUST,exception]: The [ciphertext](#ciphertext) of each encrypted data key in this list MUST be an opaque form of the
    TEXT[!MUST,exception]: plaintext data key from this set of encryption materials.
    TEXT[!MUST,implication]: If the plaintext data key is not included in this set of encryption materials, this list MUST be empty.

  SECTION: [Encryption Context](#encryption-context-1)
    TEXT[!SHOULD,implication]: If an [encryption material](#encryption-materials) contains a [signing key](#signing-key),
    TEXT[!SHOULD,implication]: the [encryption context](#encryption-context) SHOULD include the reserved key `aws-crypto-public-key`.
    TEXT[!SHOULD,implication]: The mapped value from the reserved key `aws-crypto-public-key` SHOULD be the signature verification key
    TEXT[!SHOULD,implication]: corresponding to the [signing key](#signing-key) stored on the [encryption material](#encryption-materials).
    TEXT[!SHOULD,implication]: If an [encryption material](#encryption-materials) does not contains a [signing key](#signing-key),
    TEXT[!SHOULD,implication]: the [encryption context](#encryption-context) SHOULD NOT include the reserved key `aws-crypto-public-key`.

  SECTION: [Plaintext Data Key](#plaintext-data-key)
    TEXT[!MUST,implication]: The plaintext data key MUST:
    TEXT[implication]: - Fit the specification for the [key derivation algorithm](algorithm-suites.md#key-derivation-algorithm)
    TEXT[implication]:   included in this decryption material's [algorithm suite](#algorithm-suite).
    TEXT[!SHOULD,exception]: The plaintext data key SHOULD be stored as immutable data.
    TEXT[!SHOULD,exception]: The plaintext data key SHOULD offer an interface to zero the plaintext data key.

  SECTION: [Signing Key](#signing-key)
    TEXT[!MUST,exception]: The signing key MUST fit the specification described by the [asymmetric signature algorithm](algorithm-suites.md#asymmetric-signature-algorithm)
    TEXT[!MUST,exception]: included in this encryption material's [algorithm suite](#algorithm-suite).
    TEXT[!MUST,implication]: If the algorithm suite does not contain an asymmetric signing algorithm, the signing key MUST NOT be present.
    TEXT[!MUST,exception]: The value of this key MUST be kept secret.

  SECTION: [Required Encryption Context Keys](#required-encryption-context-keys)
    TEXT[!MUST,implication]: Every key in Required Encryption Context Keys
    TEXT[!MUST,implication]: MUST be a key in the [encryption context](#encryption-context-1).

  SECTION: [Symmetric Signing Keys](#symmetric-signing-keys)
    TEXT[!MUST,implication]: If the algorithm suite does not contain a symmetric signing algorithm, this list MUST NOT be included in the materials.
    TEXT[!MUST,implication]: If the algorithm suite does contain a symmetric signing algorithm, this list MUST have length equal to the [encrypted data key list](#encrypted-data-keys).
    TEXT[!MUST]: The symmetric signature keys MUST adhere to the specification for [symmetric signature algorithms](./algorithm-suites.md#symmetric-signature-algorithm)
    TEXT[!MUST]: included in this encryption material's [algorithm suite](#algorithm-suite).
    TEXT[!MUST,implication]: The value of keys in this list MUST be kept secret.

  SECTION: [Fields](#fields)
    TEXT[!MUST,implication]: This structure MUST include the following fields:
    TEXT[implication]: - [Algorithm Suite](#algorithm-suite-1)
    TEXT[implication]: - [Encryption Context](#encryption-context-2)
    TEXT[implication]: - [Required Encryption Context Keys](#required-encryption-context-keys-1)
    TEXT[!MAY,implication]: This structure MAY include any of the following fields:
    TEXT[implication]: - [Plaintext Data Key](#plaintext-data-key-1)
    TEXT[implication]: - [Verification Key](#verification-key)

  SECTION: [Encryption Context](#encryption-context-2)
    TEXT[!SHOULD,implication]: If a [decryption materials](#decryption-materials) contains a [verification key](#verification-key),
    TEXT[!SHOULD,implication]: the [encryption context](#encryption-context) SHOULD include the reserved key `aws-crypto-public-key`.
    TEXT[!SHOULD,implication]: The mapped value from the reserved key `aws-crypto-public-key`
    TEXT[!SHOULD,implication]: SHOULD be the signature verification key stored on the [decryption materials](#decryption-materials).
    TEXT[!SHOULD,implication]: If a [decryption materials](#decryption-materials) does not contain a [verification key](#verification-key),
    TEXT[!SHOULD,implication]: the [encryption context](#encryption-context) SHOULD NOT include the reserved key `aws-crypto-public-key`.

  SECTION: [Plaintext Data Key](#plaintext-data-key-1)
    TEXT[!MUST,implication]: The plaintext data key MUST:
    TEXT[implication]: - Fit the specification for the [encryption algorithm](algorithm-suites.md#encryption-algorithm)
    TEXT[implication]:   included in this decryption material's [algorithm suite](#algorithm-suite-1).
    TEXT[!SHOULD,exception]: The plaintext data key SHOULD be stored as immutable data.
    TEXT[!SHOULD,exception]: The plaintext data key SHOULD offer an interface to zero the plaintext data key.

  SECTION: [Verification Key](#verification-key)
    TEXT[!MUST,exception]: The verification key MUST fit the specification for the [asymmetric signature algorithm](algorithm-suites.md#asymmetric-signature-algorithm)
    TEXT[!MUST,exception]: included in this decryption material's [algorithm suite](#algorithm-suite-1).

  SECTION: [Required Encryption Context Keys](#required-encryption-context-keys-1)
    TEXT[!MUST,implication]: Every key in Required Encryption Context Keys
    TEXT[!MUST,implication]: MUST be a key in the [encryption context](#encryption-context-2).

  SECTION: [Symmetric Signing Key](#symmetric-signing-key)
    TEXT[!MUST,implication]: If the algorithm suite does not contain a symmetric signing algorithm,
    TEXT[!MUST,implication]: the symmetric signing key MUST NOT be included in the materials.
    TEXT[!MUST,implication]: If the algorithm suite does contain a symmetric signing algorithm,
    TEXT[!MUST,implication]: the symmetric signing key MUST also be included in the materials
    TEXT[!MUST,implication]: if and only if the materials also include a [plaintext data key](#plaintext-data-key-1).
    TEXT[!MUST]: If included, the symmetric signature key MUST fit the specification for the [symmetric signature algorithm](algorithm-suites.md#symmetric-signature-algorithm)
    TEXT[!MUST]: included in this decryption material's [algorithm suite](#algorithm-suite-1).
    TEXT[!MUST,implication]: This value MUST be kept secret.

  SECTION: [Structure](#structure-3)
    TEXT[!MUST,implication]: This structure MUST include all of the following fields:
    TEXT[implication]: - [Branch Key](#branch-key)
    TEXT[implication]: - [Branch Key Id](#branch-key-id)
    TEXT[implication]: - [Branch Key Version](#branch-key-version)
    TEXT[implication]: - [Encryption Context](#encryption-context-3)

  SECTION: [Branch Key](#branch-key)
    TEXT[!MUST]: This data key MUST only be generated through
    TEXT[!MUST]: AWS KMS using the [`GenerateDataKeyWithoutPlaintext`](https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKeyWithoutPlaintext.html) API.
    TEXT[!MUST]: This key MUST be 32 bytes long.

  SECTION: [Branch Key Version](#branch-key-version)
    TEXT[!MUST]: This value MUST be a version 4 [UUID](https://www.ietf.org/rfc/rfc4122.txt).

  SECTION: [Structure](#structure-4)
    TEXT[!MUST,implication]: This structure MUST include the following fields:
    TEXT[implication]: - [Beacon Key Id](#beacon-key-id)
    TEXT[implication]: - [Encryption Context](#encryption-context-4)
    TEXT[!MAY,implication]: This structure MAY include the following fields:
    TEXT[implication]: - [Beacon Key](#beacon-key)
    TEXT[implication]: - [HMAC Keys](#hmac-keys)

SPECIFICATION: [Synchronized Local Cryptographic Materials Cache](aws-encryption-sdk-specification/framework/synchronized-local-cryptographic-materials-cache.md)
  SECTION: [Initialization](#initialization)
    TEXT[!MUST]: On initialization of the synchronized local CMC,
    TEXT[!MUST]: the caller MUST provide exactly what is required by a
    TEXT[!MUST]: [Local CMC](local-cryptographic-materials-cache.md).

  SECTION: [Behaviors](#behaviors)
    TEXT[!MUST]: All behaviors MUST be exactly the same as a [Local CMC](local-cryptographic-materials-cache.md),
    TEXT[!MUST]: even if used in a multi-threaded context.

SPECIFICATION: [Transitive requirements for supported formats](aws-encryption-sdk-specification/framework/transitive-requirements.md)
  SECTION: [HKDF Encryption Key](#hkdf-encryption-key)
    TEXT[!MUST]: If an algorithm suite uses HKDF to derive the encryption key
    TEXT[!MUST]: the AWS Encryption SDK MUST use HKDF with the following specifics:
    TEXT[!MUST]: - The hash function MUST be specified by the [algorithm suite key derivation settings](#algorithm-suites-encryption-key-derivation-settings).
    TEXT[!MUST]:   - The input keying material MUST be the data key generated by the key provider.
    TEXT[!MUST]:   - The length of the input keying material MUST equal the [key derivation input length](#key-derivation-input-length)
    TEXT[!MUST]:     specified by the [algorithm suite encryption key derivation settings](#algorithm-suites-encryption-key-derivation-settings).
    TEXT[!MUST]:   - If there is no salt length defined for the [algorithm suite encryption key derivation commitment setting](#algorithm-suites-encryption-key-derivation-settings),
    TEXT[!MUST]:     the the salt MUST be a byte sequence of 0 as long as the hash length in bytes.
    TEXT[!MUST]:   - If salt length is defined for the [algorithm suite encryption key derivation commitment setting](#algorithm-suites-encryption-key-derivation-settings),
    TEXT[!MUST]:     the salt MUST be the [message ID](../data-format/message-header.md#message-id) with a length equal to the salt length.
    TEXT[!MUST]:   - The input pseudorandom key MUST be the output from the extract step.
    TEXT[!MUST]:   - The length of the output keying material MUST equal the [encryption key length](#encryption-key-length)
    TEXT[!MUST]:     specified by the [algorithm suite encryption settings](#algorithm-suites-encryption-settings).
    TEXT[!MUST]:   - If [key commitment](#key-commitment) for the [algorithm suite encryption key derivation setting](#algorithm-suites-encryption-key-derivation-settings) is True,
    TEXT[!MUST]:     then the input info MUST be a concatenation of the [algorithm suite ID](#algorithm-suite-id) followed by the string `DERIVEKEY` as UTF8 encoded bytes.
    TEXT[!MUST]:   - If [key commitment](#key-commitment) for the [algorithm suite encryption key derivation setting](#algorithm-suites-encryption-key-derivation-settings) is False,
    TEXT[!MUST]:     the the input info MUST be a concatenation of the [algorithm suite ID](#algorithm-suite-id)
    TEXT[!MUST]:     followed by the [message ID](../data-format/message-header.md#message-id).

  SECTION: [HKDF Commit Key](#hkdf-commit-key)
    TEXT[!MUST]: If an algorithm suite uses HKDF to derive the commitment key
    TEXT[!MUST]: the AWS Encryption SDK MUST use HKDF with the following specifics:
    TEXT[!MUST]: - The hash function MUST be specified by the [algorithm suite commitment settings](#algorithm-suites-commit-key-derivation-settings).
    TEXT[!MUST]:   - The input keying material MUST be the data key generated by the key provider.
    TEXT[!MUST]:   - The length of the input keying material MUST equal the [key derivation input length](#key-derivation-input-length)
    TEXT[!MUST]:     specified by the algorithm suite commit key derivation setting.
    TEXT[!MUST]:   - The salt MUST be the [message ID](../data-format/message-header.md#message-id) with a length of 256 bits.
    TEXT[!MUST]:   - The input pseudorandom key MUST be the output from the extract step.
    TEXT[!MUST]:   - The length of the output keying material MUST equal the [algorithm suite data length](#algorithm-suite-data-length)
    TEXT[!MUST]:     specified by the [supported algorithm suites](#supported-algorithm-suites).
    TEXT[!MUST]:   - The input info MUST the string `COMMITKEY` as UTF8 encoded bytes by the algorithm suite commitment settings.
    TEXT[!SHOULD]: For algorithm suites that support commitment,
    TEXT[!SHOULD]: the AWS Encryption SDK SHOULD only perform the extract step once
    TEXT[!SHOULD]: and use the same output from the extract step
    TEXT[!SHOULD]: for both the encryption key and the commitment key.
    TEXT[!MUST]: Verification of the commitment key MUST be a constant time comparison.

  SECTION: [ECDSA](#ecdsa)
    TEXT[!MUST]: If specified to use ECDSA, the AWS Encryption SDK MUST use ECDSA with the following specifics:
